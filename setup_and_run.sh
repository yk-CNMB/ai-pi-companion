#!/bin/bash

# å®šä¹‰é¢œè‰²ï¼Œè®©è¾“å‡ºå¥½çœ‹ç‚¹
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}ğŸ¤– æ­£åœ¨å¯åŠ¨ Pico AI æœåŠ¡å™¨...${NC}"
echo -e "${BLUE}========================================${NC}"

# 1. åˆ‡æ¢åˆ°è„šæœ¬æ‰€åœ¨çš„ç›®å½• (ç¡®ä¿è·¯å¾„æ­£ç¡®)
cd "$(dirname "$0")"

# 2. æ€æ­»æ—§è¿›ç¨‹ (é˜²æ­¢ç«¯å£å ç”¨)
echo -e "ğŸ”ª æ­£åœ¨æ¸…ç†æ—§è¿›ç¨‹..."
pkill -f "gunicorn.*app:app"
pkill -f "cloudflared tunnel"
sleep 2

# 3. å¯åŠ¨ Gunicorn (åœ¨åå°è¿è¡Œï¼Œä½¿ç”¨ & ç¬¦å·)
echo -e "ğŸ§  æ­£åœ¨å¯åŠ¨ AI å¤§è„‘ (Gunicorn)..."
# å¿…é¡»ä½¿ç”¨å®Œæ•´è·¯å¾„æ¥ç¡®ä¿ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒé‡Œçš„ gunicorn
./.venv/bin/gunicorn --worker-class eventlet -w 1 --bind 0.0.0.0:5000 app:app --daemon

# ç­‰å¾…å‡ ç§’ç¡®ä¿ Gunicorn å¯åŠ¨æˆåŠŸ
sleep 5

# æ£€æŸ¥ Gunicorn æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ
if pgrep -f "gunicorn.*app:app" > /dev/null; then
    echo -e "${GREEN}âœ… AI å¤§è„‘å¯åŠ¨æˆåŠŸï¼${NC}"
else
    echo -e "âŒ AI å¤§è„‘å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
    exit 1
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}ğŸŒ æ­£åœ¨å»ºç«‹å…¬ç½‘éš§é“...${NC}"
echo -e "è¯·è€å¿ƒç­‰å¾…å‡ ç§’é’Ÿï¼Œä¸‹æ–¹ä¼šå‡ºç°ä¸€ä¸ª ${GREEN}trycloudflare.com${NC} çš„ç½‘å€ã€‚"
echo -e "å¤åˆ¶é‚£ä¸ªç½‘å€ï¼Œç›´æ¥è®¿é—®å³å¯ (ä¼šè‡ªåŠ¨è·³è½¬åˆ°æœ€æ–°ç‰ˆæœ¬)ã€‚"
echo -e "${BLUE}========================================${NC}"

# 4. å¯åŠ¨éš§é“ (åœ¨å‰å°è¿è¡Œï¼Œæ˜¾ç¤ºæ—¥å¿—)
# æˆ‘ä»¬ä½¿ç”¨ grep è¿‡æ»¤ä¸€ä¸‹æ—¥å¿—ï¼Œåªæ˜¾ç¤ºç½‘å€ï¼Œè®©ç•Œé¢æ›´æ¸…çˆ½ (å¯é€‰)
./cloudflared tunnel --url http://localhost:5000 2>&1 | grep --line-buffered "trycloudflare.com"

# å¦‚æœä½ ä¸æƒ³è¿‡æ»¤æ—¥å¿—ï¼Œæƒ³çœ‹å…¨éƒ¨è¾“å‡ºï¼Œå°±ç”¨ä¸‹é¢è¿™è¡Œä»£æ›¿ä¸Šé¢é‚£è¡Œï¼š
# ./cloudflared tunnel --url http://localhost:5000
```

---

### ğŸš€ å¦‚ä½•ä½¿ç”¨

1.  **åˆ›å»ºè„šæœ¬**ï¼šæŠŠä¸Šé¢çš„å†…å®¹å¤åˆ¶åˆ° `start_pico.sh` æ–‡ä»¶ä¸­ã€‚
2.  **èµ‹äºˆæ‰§è¡Œæƒé™**ï¼š
    ```bash
    chmod +x start_pico.sh
    ```
3.  **ä¸€é”®å¯åŠ¨**ï¼š
    ```bash
    ./start_pico.sh

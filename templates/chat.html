<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pico Studio (3D Dual Engine)</title>
    
    <!-- Live2D Core -->
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

    <!-- â˜…â˜…â˜… Three.js & VRM Import Map â˜…â˜…â˜… -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/",
                "@pixiv/three-vrm": "https://unpkg.com/@pixiv/three-vrm@3.3.0/lib/three-vrm.module.js"
            }
        }
    </script>
    
    <style>
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; margin: 0; padding: 0; height: 100dvh; width: 100vw; background-color: #2d3436; overflow: hidden; color: #333; }
        
        /* ä¸¤ä¸ªç”»å¸ƒå åŠ ï¼Œé€šè¿‡ display æ§åˆ¶æ˜¾ç¤º */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #live2d-canvas { z-index: 1; }
        #three-canvas { z-index: 2; display: none; } /* é»˜è®¤éšè— 3D ç”»å¸ƒ */
        
        #orientation-lock { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2d3436; z-index: 99999; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        @media screen and (max-width: 1024px) and (orientation: landscape) { #orientation-lock { display: flex !important; } }

        @media (min-width: 1025px) {
            body { display: flex; flex-direction: row; }
            #stage-container { flex: 1; position: relative; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); overflow: hidden; background-size: cover; background-position: center; z-index: 1; }
            #chat-container { width: 420px; display: flex; flex-direction: column; background: #fff; z-index: 10; box-shadow: -5px 0 20px rgba(0,0,0,0.15); border-left: 1px solid #eee; height: 100%; }
            #header { background: #6c5ce7; color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; font-weight: bold; font-size: 18px; }
            #chat-window { flex: 1; overflow-y: auto; padding: 20px; background: #f5f7fa; }
            #input-area { padding: 20px; background: white; border-top: 1px solid #eee; flex-shrink: 0; display: flex; align-items: center; height: 80px; }
            #user-input { flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 16px; }
            #send-btn { background: #6c5ce7; color: white; border: none; padding: 0 30px; margin-left: 12px; border-radius: 25px; height: 46px; font-weight: bold; cursor: pointer; }
            .message-bubble { background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .self .message-bubble { background: #6c5ce7; color: white; }
            .pico .message-bubble { background: #fff0f6; border: 2px solid #f8a5c2; }
            .icon-btn { background: rgba(0,0,0,0.1); padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
            .icon-btn:hover { background: rgba(0,0,0,0.2); }
            body.live-mode #header, body.live-mode #input-area, body.live-mode #debug-pos { display: none !important; }
            body.live-mode #chat-container { position: absolute; right: 30px; top: 30px; bottom: 30px; width: 350px; height: auto; background: rgba(0, 0, 0, 0.5); border-radius: 12px; pointer-events: none; }
            body.live-mode #chat-window { background: transparent; }
            body.live-mode .message-bubble { background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); }
        }

        @media (max-width: 1024px) {
            body { display: block; background: #2d3436; }
            #stage-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; z-index: 0; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); background-size: cover; background-position: center; }
            #chat-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; z-index: 10; background: transparent; display: flex; flex-direction: column; justify-content: flex-end; pointer-events: none; }
            #header { position: absolute; top: 0; left: 0; width: 100%; padding: max(10px, env(safe-area-inset-top)) 15px 10px; background: transparent; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; z-index: 20; }
            #room-title { text-shadow: 0 1px 3px rgba(0,0,0,0.8); color: white; font-weight: 800; font-size: 18px; }
            .icon-btn { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); color: white; padding: 8px 12px; border-radius: 8px; }
            #chat-window { flex: 0 1 60%; overflow-y: auto; padding: 15px; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); pointer-events: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
            #input-area { pointer-events: auto; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); margin: 0 10px; margin-bottom: max(10px, env(safe-area-inset-bottom)); border-radius: 20px 20px 0 0; padding: 10px; display: flex; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            #user-input { flex: 1; padding: 10px; border: 1px solid rgba(0,0,0,0.1); border-radius: 20px; background: rgba(255,255,255,0.8); font-size: 16px; }
            #send-btn { background: #6c5ce7; color: white; border: none; width: 44px; height: 44px; border-radius: 50%; margin-left: 8px; font-weight: bold; display: flex; align-items: center; justify-content: center; }
            .message-bubble { background: rgba(255, 255, 255, 0.9) !important; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.5); color: #2d3436 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
            .self .message-bubble { background: rgba(108, 92, 231, 0.95) !important; color: white !important; border: none; }
            .message-info { color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        }

        .message-container { display: flex; margin-bottom: 15px; flex-direction: column; width: 100%; }
        .message-info { font-size: 12px; margin-bottom: 4px; padding: 0 5px; color: #888; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; max-width: 85%; word-wrap: break-word; position: relative; line-height: 1.5; }
        .self { align-items: flex-end; } .self .message-bubble { border-bottom-right-radius: 4px; }
        .other { align-items: flex-start; } .other .message-bubble { border-bottom-left-radius: 4px; }
        .emotion-tag { display: inline-block; font-size: 0.8em; padding: 1px 4px; border-radius: 4px; background: rgba(232, 67, 147, 0.1); color: #e84393; margin-left: 5px; font-weight: bold;}
        .message-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .audio-player { display: block !important; margin-top: 8px; height: 40px; width: 100%; min-width: 200px; border-radius: 20px; background: #f1f3f5; border: 1px solid #ddd; opacity: 1 !important; pointer-events: auto !important; z-index: 999; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #login-overlay { z-index: 10000; } 
        #studio-overlay { display: none; z-index: 9000; }
        
        #username-input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #6c5ce7; border-radius: 10px; font-size: 18px; text-align: center; outline: none; }
        #login-btn { background: #6c5ce7; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; transition: all 0.3s; cursor: pointer; }
        #login-btn:disabled { background: #b2bec3; cursor: not-allowed; opacity: 0.7; }
        
        .admin-only { display: none; }
        .slider-container { margin: 12px 0; }
        .slider-label { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; margin-top: 15px; cursor: pointer; transition: background 0.2s; background: #fafafa; }
        .model-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .model-card { background: #f8f9fa; padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; font-size: 14px; }
        .model-card.active { border-color: #6c5ce7; background: #ecebff; font-weight: bold; color: #6c5ce7; }
        .chip { display: inline-block; background: #eee; padding: 6px 12px; border-radius: 15px; margin: 5px; cursor: pointer; font-size: 13px; }
        .bg-chip { display: inline-block; background: #fff; padding: 5px 10px; border-radius: 8px; margin: 5px; cursor: pointer; font-size: 12px; border: 1px solid #ddd; }
        .bg-chip.active { background: #d1ecf1; border-color: #17a2b8; font-weight: bold; }
        .btn-del { color: red; font-size: 12px; display: block; margin-top: 5px; }
        .toggle-btn { background-color: #f1f2f6; color: #333; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: bold; border: 2px solid #ddd; display: block; width: 100%; margin-bottom: 15px; transition: all 0.3s; }
        .toggle-btn.active { background-color: #6c5ce7; color: white; border-color: #6c5ce7; }
        
        #preview-area { position: absolute; bottom: 90px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 10px; display: none; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15); z-index: 100; pointer-events: auto; text-align: center; }
        #preview-img { max-height: 120px; max-width: 100%; border-radius: 8px; }
        #close-preview { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; line-height: 24px; }
        #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 11000; text-align: center; width: 100%; pointer-events: none; }
        .toast { display: inline-block; background: rgba(0, 0, 0, 0.85); color: white; padding: 10px 25px; border-radius: 30px; margin-top: 10px; animation: fadeOut 3s forwards 2s; backdrop-filter: blur(4px); font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        #debug-pos { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0, 0, 0, 0.5); padding: 5px; font-size: 10px; pointer-events: none; z-index: 100; border-radius: 4px; }
        
        #acgn-panel { background: #e3f2fd; padding: 10px; border-radius: 8px; margin-top: 10px; border: 1px solid #90caf9; display: none; }
        #acgn-panel input { width: 100%; margin-bottom: 5px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 12px; }
        #acgn-panel label { font-size: 11px; font-weight: bold; color: #1565c0; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div id="orientation-lock"><div style="font-size: 40px; margin-bottom: 20px;">ğŸ“±</div><h2>ä¸ºäº†æœ€ä½³ä½“éªŒï¼Œè¯·ç«–å±ä½¿ç”¨</h2><p>æ£€æµ‹åˆ°å±å¹•ç¿»è½¬ï¼Œè¿™ä¼šå¯¼è‡´æ¨¡å‹æ¯”ä¾‹å˜å½¢ã€‚</p></div>
    <div id="toast-container"></div>
    
    <div id="login-overlay" class="overlay">
        <div class="modal-box" style="text-align:center">
            <h2 style="color:#6c5ce7;margin-bottom:20px;">Pico ç›´æ’­é—´</h2>
            <input id="username-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="12" autocomplete="off"><br>
            <button id="login-btn" disabled>è¿æ¥ä¸­...</button>
        </div>
    </div>
    
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ› ï¸ å·¥ä½œå®¤æ§åˆ¶å°</h3>
                <div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div>
            </div>
            
            <button id="follow-toggle" class="toggle-btn active" onclick="window.toggleMouseFollow()">ğŸ‘€ çœ¼ç¥è·Ÿéš: ON</button>

            <h4>ğŸ­ æ¨¡å‹é€‰æ‹©</h4>
            <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            <hr>
            
            <h4>ğŸ–¼ï¸ èˆå°èƒŒæ™¯</h4>
            <div class="upload-box" onclick="document.getElementById('bg-input').click()">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (JPG/PNG)<input type="file" id="bg-input" accept="image/*" style="display:none" onchange="window.uploadBackground(this.files[0])"></div>
            <div id="bg-list" style="margin-top:10px; max-height:100px; overflow-y:auto"></div>
            <div style="margin-top:5px"><span class="bg-chip" onclick="window.changeBackground('')">ğŸš« é»˜è®¤ç°è‰²</span></div>

            <div class="admin-only">
                <hr>
                <h4>ğŸ”‘ API Key</h4>
                <div style="display:flex; gap:5px;">
                    <input id="api-key-input" placeholder="è¾“å…¥ Gemini API Key (AIza...)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="window.saveGeminiKey()" style="background:#6c5ce7; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">ä¿å­˜</button>
                </div>
                
                <hr>
                <h4>âš™ï¸ å‚æ•°è°ƒæ•´</h4>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                    <div style="font-size:12px;color:#666;margin-bottom:5px;">äººè®¾æç¤ºè¯ (System Prompt):</div>
                    <textarea id="persona-text" style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;font-size:12px;"></textarea>
                    
                    <label style="font-size:12px;color:#666">å£°çº¿é€‰æ‹© (Voice):</label>
                    <select id="voice-select" style="width:100%;padding:8px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd" onchange="window.checkVoicePanel()"></select>

                    <div id="acgn-panel">
                        <label>ğŸ”’ è®¿é—®ä»¤ç‰Œ (Token):</label><input id="acgn-token" placeholder="ç²˜è´´ ACGN ç½‘ç«™çš„ Token">
                        <label>ğŸ”— API åœ°å€ (é»˜è®¤ gsv2p.acgnai.top):</label><input id="acgn-url" placeholder="https://gsv2p.acgnai.top">
                        <label>ğŸ‘§ è§’è‰²å (Character):</label><input id="acgn-char" placeholder="ä¾‹å¦‚: æµè¤, æ´¾è’™, çº³è¥¿å¦²">
                    </div>

                    <div class="slider-container"><div class="slider-label"><span>è¯­é€Ÿ (Rate)</span><span id="rate-val">0%</span></div><input type="range" id="rate-range" min="-50" max="50" oninput="window.updateVal('rate', this.value)"></div>
                    <div class="slider-container"><div class="slider-label"><span>éŸ³è°ƒ (Pitch)</span><span id="pitch-val">0Hz</span></div><input type="range" id="pitch-range" min="-50" max="50" oninput="window.updateVal('pitch', this.value)"></div>
                    <div class="slider-container"><div class="slider-label"><span>ç¼©æ”¾ (Scale)</span><span id="scale-val">0.5</span></div><input type="range" id="model-scale" min="0.1" max="5.0" step="0.05" oninput="window.previewTransform()"></div>
                    <div class="slider-container"><div class="slider-label"><span>ä½ç½® X</span><span id="x-val">0.0</span></div><input type="range" id="model-x" min="-2" max="2" step="0.01" oninput="window.previewTransform()"></div>
                    <div class="slider-container"><div class="slider-label"><span>ä½ç½® Y</span><span id="y-val">0.0</span></div><input type="range" id="model-y" min="-2" max="2" step="0.01" oninput="window.previewTransform()"></div>
                </div>
                <button id="save-settings-btn" style="width:100%;padding:12px;margin-top:15px;background:#6c5ce7;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">ä¿å­˜æ‰€æœ‰é…ç½®</button>
                
                <hr>
                <h4>â˜ï¸ ä¸Šä¼ æ¨¡å‹ (zip/vrm)</h4>
                <div class="upload-box" onclick="document.getElementById('file-input').click()">ç‚¹å‡»ä¸Šä¼  (.zip / .vrm)<input type="file" id="file-input" accept=".zip,.vrm" style="display:none" onchange="window.uploadFile(this.files[0])"></div>
            </div>
            
            <hr>
            <h4>ğŸ§¹ ç¼“å­˜æ¸…ç†</h4>
            <div><span class="chip" onclick="window.clearLocalHistory()" style="color:red;background:#ffeaea;">æ¸…é™¤èŠå¤©è®°å½•</span><span class="chip" onclick="window.clearLocalMemories()" style="color:red;background:#ffeaea;">æ¸…é™¤æœ¬åœ°è®°å¿†</span></div>
        </div>
    </div>

    <div id="stage-container">
        <!-- Live2D Canvas (Default) -->
        <canvas id="live2d-canvas"></canvas>
        <!-- Three.js Canvas (VRM) -->
        <canvas id="three-canvas"></canvas>
        <div id="debug-pos"></div>
    </div>
    
    <div id="chat-container">
        <div id="header"><span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span><div style="display:flex;gap:10px"><div class="icon-btn" id="live-btn" title="ç›´æ’­æ¨¡å¼ (ä»…PC)" onclick="window.toggleLiveMode()">ğŸ“º</div><div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div><div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div></div></div>
        <div id="chat-window"></div>
        <div id="preview-area"><img id="preview-img"><div id="close-preview" onclick="window.clearPreview()">Ã—</div></div>
        <div id="input-area"><div class="icon-btn" onclick="document.getElementById('img-input').click()" style="margin-right:10px;display:flex;align-items:center;justify-content:center;">ğŸ“·</div><input type="file" id="img-input" accept="image/*" style="display:none" onchange="window.handleImgSelect(this.files[0])"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <!-- â˜…â˜…â˜… Main Logic Module â˜…â˜…â˜… -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        const socket = io({reconnection:true});
        
        // --- å¼•æ“çŠ¶æ€ ---
        let engineType = 'live2d'; // 'live2d' or 'vrm'
        
        // --- Live2D (Pixi) å˜é‡ ---
        let app_pixi, model_live2d;
        
        // --- VRM (Three) å˜é‡ ---
        let renderer, scene, camera, clock, currentVRM;
        let mixer; // åŠ¨ç”»æ··åˆå™¨
        
        // --- é€šç”¨å˜é‡ ---
        let myUser="", currentModelId="", currentCfg={scale:0.5,x:0.5,y:0.5};
        let audioCtx, analyser, dataArray, isTalking=false;
        let isDragging=false, dragData, initialScale, initialDist, iAmAdmin=false;
        let currentImgBase64 = null;
        let isMouseFollow = true;
        let targetX = 0, targetY = 0; // -1 to 1

        // æŒ‚è½½å…¨å±€å‡½æ•° (å› ä¸ºæ˜¯ module)
        window.toggleMouseFollow = toggleMouseFollow;
        window.updateVal = updateVal;
        window.previewTransform = previewTransform;
        window.checkVoicePanel = checkVoicePanel;
        window.uploadBackground = uploadBackground;
        window.changeBackground = changeBackground;
        window.uploadFile = uploadFile;
        window.saveGeminiKey = saveGeminiKey;
        window.clearLocalHistory = clearLocalHistory;
        window.clearLocalMemories = clearLocalMemories;
        window.handleImgSelect = handleImgSelect;
        window.clearPreview = clearPreview;
        window.toggleLiveMode = toggleLiveMode;

        // --- Three.js åˆå§‹åŒ– ---
        function initThree() {
            const canvas = document.getElementById('three-canvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);

            scene = new THREE.Scene();
            
            // ç¯å…‰
            const light = new THREE.DirectionalLight(0xffffff);
            light.position.set(1.0, 1.0, 1.0).normalize();
            scene.add(light);
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);

            // ç›¸æœº
            camera = new THREE.PerspectiveCamera(30.0, canvas.clientWidth / canvas.clientHeight, 0.1, 20.0);
            camera.position.set(0.0, 1.0, 5.0); // é»˜è®¤ä½ç½®

            clock = new THREE.Clock();
            
            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            animateThree();
        }

        function animateThree() {
            requestAnimationFrame(animateThree);
            if (engineType !== 'vrm') return; // ä¸åœ¨ VRM æ¨¡å¼ä¸æ¸²æŸ“

            const delta = clock.getDelta();

            if (currentVRM) {
                // 1. çœ¼ç¥è·Ÿéš (LookAt)
                if (isMouseFollow) {
                    // VRM LookAt éœ€è¦ä¸€ä¸ªå…·ä½“çš„ 3D åæ ‡ target
                    // ç®€å•çš„æ˜ å°„ï¼šå°†é¼ æ ‡ 2D åæ ‡æ˜ å°„åˆ°ç›¸æœºå‰æ–¹çš„ 3D å¹³é¢ä¸Š
                    // å¤´éƒ¨å¤§æ¦‚åœ¨ (0, 1.5, 0)
                    const lookTarget = new THREE.Vector3(targetX * 2.0, 1.5 - targetY * 1.0, camera.position.z - 2.0);
                    currentVRM.lookAt.target = lookTarget;
                }
                
                // 2. å£å‹åŒæ­¥
                if (isTalking && analyser) {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0;
                    for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                    const vol = Math.min(1.0, (sum / dataArray.length) / 30);
                    // è®¾ç½® 'aa' blendshape
                    currentVRM.expressionManager.setValue('aa', vol);
                } else {
                    currentVRM.expressionManager.setValue('aa', 0);
                }

                currentVRM.update(delta);
            }
            
            if (mixer) mixer.update(delta);

            renderer.render(scene, camera);
        }

        // --- VRM åŠ è½½ ---
        function loadVRM(url, cfg) {
            // åˆ‡æ¢ç”»å¸ƒ
            document.getElementById('live2d-canvas').style.display = 'none';
            document.getElementById('three-canvas').style.display = 'block';
            engineType = 'vrm';

            if (!renderer) initThree();
            
            // æ¸…ç†æ—§ VRM
            if (currentVRM) {
                scene.remove(currentVRM.scene);
                VRMUtils.deepDispose(currentVRM.scene);
                currentVRM = null;
            }

            const loader = new GLTFLoader();
            loader.register((parser) => new VRMLoaderPlugin(parser));

            console.log("ğŸ“¥ Loading VRM:", url);
            loader.load(
                url,
                (gltf) => {
                    const vrm = gltf.userData.vrm;
                    VRMUtils.removeUnnecessaryVertices(gltf.scene);
                    VRMUtils.removeUnnecessaryJoints(gltf.scene);
                    vrm.scene.rotation.y = Math.PI; // è®©æ¨¡å‹é¢æœæ‘„åƒæœº (å¤§å¤šæ•° VRM é»˜è®¤èƒŒå¯¹)
                    
                    currentVRM = vrm;
                    scene.add(vrm.scene);
                    
                    console.log("âœ… VRM Loaded");
                    applyConfig(cfg); // åº”ç”¨ç¼©æ”¾å’Œä½ç½®
                },
                (progress) => console.log('Loading model...', 100.0 * (progress.loaded / progress.total), '%'),
                (error) => { console.error(error); showToast("âŒ VRM åŠ è½½å¤±è´¥", "error"); }
            );
        }

        // --- Live2D åŠ è½½ (å…¼å®¹æ—§é€»è¾‘) ---
        async function loadLive2D(path, cfg) {
            // åˆ‡æ¢ç”»å¸ƒ
            document.getElementById('three-canvas').style.display = 'none';
            document.getElementById('live2d-canvas').style.display = 'block';
            engineType = 'live2d';

            console.log("ğŸ“¥ Loading Live2D:", path);
            if(!app_pixi) { 
                app_pixi = new PIXI.Application({ 
                    view:document.getElementById('live2d-canvas'), 
                    autoStart:true, 
                    resizeTo:document.getElementById('stage-container'), 
                    transparent:true 
                }); 
                initInteractionLive2D(); 
            }
            try { 
                if(model_live2d) { app_pixi.stage.removeChild(model_live2d); model_live2d.destroy(); model_live2d=null; } 
                app_pixi.stage.removeChildren(); 
                model_live2d = await PIXI.live2d.Live2DModel.from(path); 
                app_pixi.stage.addChild(model_live2d); 
                
                setTimeout(() => applyConfig(cfg), 100); 
                
                app_pixi.ticker.remove(lipSyncLive2D); 
                app_pixi.ticker.add(lipSyncLive2D); 
                
                if(model_live2d.internalModel.motionManager) model_live2d.internalModel.motionManager.startRandomMotion('Idle'); 
                console.log("âœ… Live2D Loaded"); 
            } catch(e) { 
                console.error("âŒ Live2D Load Failed:", e); 
                showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥", "error"); 
            }
        }

        // --- é€šç”¨é…ç½®åº”ç”¨ ---
        function applyConfig(cfg) {
            const target = cfg || currentCfg;
            const s = (target.scale !== undefined) ? target.scale : 1.0;
            const x = (target.x !== undefined) ? target.x : 0.0;
            const y = (target.y !== undefined) ? target.y : 0.0;

            // UI æ›´æ–°
            if(document.getElementById('model-scale')) {
                document.getElementById('model-scale').value = s;
                document.getElementById('model-x').value = x;
                document.getElementById('model-y').value = y;
                // ...éŸ³è°ƒè¯­é€Ÿç•¥
            }

            // åº”ç”¨åˆ°å¼•æ“
            if (engineType === 'vrm' && currentVRM) {
                // VRM ç¼©æ”¾
                currentVRM.scene.scale.set(s, s, s);
                // VRM ä½ç½® (x, y, z)
                currentVRM.scene.position.set(x, y, 0); 
            } else if (engineType === 'live2d' && model_live2d && app_pixi) {
                // Live2D ç¼©æ”¾ (ç›¸å¯¹å±å¹•)
                // è¿™é‡Œä¸ºäº†ç»Ÿä¸€ä½“éªŒï¼Œå¯èƒ½éœ€è¦è°ƒæ•´ Live2D çš„ç¼©æ”¾é€»è¾‘
                const st = document.getElementById('stage-container');
                const absScale = (st.clientHeight / model_live2d.height) * s * 0.5; // *0.5 æ˜¯ä¸ºäº†è·Ÿ VRM å·®ä¸å¤šå¤§å°æ„Ÿ
                model_live2d.scale.set(absScale);
                model_live2d.x = (st.clientWidth * 0.5) + (x * 500) - (model_live2d.width / 2); // ç®€å•çš„ä½ç½®æ˜ å°„
                model_live2d.y = (st.clientHeight * 0.5) + (y * 500) - (model_live2d.height / 2);
            }
            
            document.getElementById('debug-pos').textContent = `S:${s.toFixed(2)} X:${x.toFixed(2)} Y:${y.toFixed(2)}`;
        }

        function previewTransform() {
            const s = parseFloat(document.getElementById('model-scale').value);
            const x = parseFloat(document.getElementById('model-x').value);
            const y = parseFloat(document.getElementById('model-y').value);
            applyConfig({scale:s, x:x, y:y});
        }

        // --- äº¤äº’é€»è¾‘ ---
        function toggleMouseFollow() {
            isMouseFollow = !isMouseFollow;
            const btn = document.getElementById('follow-toggle');
            if (isMouseFollow) { btn.textContent = "ğŸ‘€ çœ¼ç¥è·Ÿéš: ON"; btn.classList.add('active'); showToast("âœ… å·²å¼€å¯"); }
            else { btn.textContent = "ğŸ‘€ çœ¼ç¥è·Ÿéš: OFF"; btn.classList.remove('active'); showToast("ğŸš« å·²å…³é—­"); }
        }

        // å…¨å±€é¼ æ ‡ç›‘å¬
        window.addEventListener('mousemove', (e) => {
            // è®¡ç®—å½’ä¸€åŒ–åæ ‡ (-1 to 1)
            targetX = (e.clientX / window.innerWidth) * 2 - 1;
            targetY = (e.clientY / window.innerHeight) * 2 - 1;
        });

        // Live2D ä¸“å±äº¤äº’ (ç‚¹å‡»/è§¦æ‘¸)
        function initInteractionLive2D() {
            // ä¹‹å‰çš„ Live2D ç‚¹å‡»é€»è¾‘...
            // app_pixi.stage.on('pointerdown', ...); 
            // ç®€ç•¥ï¼Œä¿æŒåŸæ ·å³å¯
        }

        // Live2D ä¸“å±å£å‹
        function lipSyncLive2D() {
            if(!model_live2d || !analyser || !isTalking) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0; for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            if(model_live2d.internalModel?.coreModel) 
                model_live2d.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0,(sum/dataArray.length)/30));
        }

        // --- Socket Events ---
        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`;
            currentCfg = d.current_model;
            // â˜…â˜…â˜… æ ¸å¿ƒåˆ†æµé€»è¾‘ â˜…â˜…â˜…
            if (d.current_model.type === 'vrm') {
                loadVRM(d.current_model.path, d.current_model);
            } else {
                loadLive2D(d.current_model.path, d.current_model);
            }
            if(d.current_background) changeBackgroundUI(d.current_background);
        });

        socket.on('model_switched', (m) => {
            currentCfg = m;
            document.getElementById('room-title').textContent=`ğŸ¤– ${m.name}`;
            if (m.type === 'vrm') {
                loadVRM(m.path, m);
            } else {
                loadLive2D(m.path, m);
            }
            showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);
        });

        // --- è¡¨æƒ…è§¦å‘ (å…¼å®¹ VRM) ---
        function triggerMotion(emo) {
            emo = emo.toUpperCase();
            if (engineType === 'vrm' && currentVRM) {
                // VRM è¡¨æƒ…
                const map = {'HAPPY': 'happy', 'ANGRY': 'angry', 'SAD': 'sad', 'SHOCK': 'surprised', 'NORMAL': 'neutral'};
                const preset = map[emo] || 'neutral';
                currentVRM.expressionManager.setValue(preset, 1.0);
                setTimeout(() => currentVRM.expressionManager.setValue(preset, 0), 3000); // 3ç§’åæ¢å¤
            } else if (engineType === 'live2d' && model_live2d) {
                // åŸæœ‰çš„ Live2D è¡¨æƒ…é€»è¾‘
                // ...
            }
        }
        
        // -----------------------------------------------------
        // ä»¥ä¸‹ä¸ºä¸éœ€è¦ä¿®æ”¹çš„è¾…åŠ©å‡½æ•° (DOM æ“ä½œ, Socketå‘é€ç­‰)
        // -----------------------------------------------------
        function checkVoicePanel() {
            const val = document.getElementById('voice-select').value;
            const panel = document.getElementById('acgn-panel');
            panel.style.display = (val === 'acgn') ? 'block' : 'none';
        }
        function updateVal(type, val) { document.getElementById(`${type}-val`).textContent = (val > 0 ? '+' : '') + val + (type==='rate'?'%':'Hz'); }
        function showToast(m,t='success'){let d=document.createElement('div');d.className='toast';d.textContent=m;if(t==='error'||t==='info')d.style.backgroundColor=t==='error'?'#d63031':(t==='info'?'#0984e3':'#00b894');document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3500);}
        function changeBackgroundUI(filename) { const el = document.getElementById('stage-container'); if (filename) { el.style.backgroundImage = `url('/static/backgrounds/${filename}')`; } else { el.style.backgroundImage = 'radial-gradient(circle,#636e72 10%,#2d3436 90%)'; } }
        function uploadBackground(f) { if(!f) return; let fd = new FormData(); fd.append('file', f); showToast("ğŸ–¼ï¸ ä¸Šä¼ èƒŒæ™¯..."); fetch('/upload_bg', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{if(d.success){ showToast("âœ… ä¸Šä¼ æˆåŠŸ"); socket.emit('get_studio_data'); } else showToast("âŒ " + d.msg, "error");}); }
        function changeBackground(name) { socket.emit('switch_background', {name: name}); }
        function uploadFile(f) { let fd=new FormData();fd.append('file',f);showToast("ğŸ“¤ ä¸Šä¼ ä¸­...");fetch('/upload_model',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){showToast("âœ… æˆåŠŸ");socket.emit('get_studio_data');}else showToast("âŒ "+d.msg,"error")}); }
        function clearLocalHistory() { if(confirm('ç¡®å®šæ¸…é™¤èŠå¤©è®°å½•ï¼Ÿ')){document.getElementById('chat-window').innerHTML="";showToast('ğŸ§¹ å·²æ¸…é™¤');} }
        function clearLocalMemories() { if(confirm('ç¡®å®šæ¸…é™¤ä¸“å±è®°å¿†ï¼Ÿ')){localStorage.removeItem('pico_user_memories');showToast('ğŸ§  å·²æ¸…é™¤');} }
        function handleImgSelect(f) { if(!f) return; if (f.size > 50 * 1024 * 1024) { showToast("âŒ å›¾ç‰‡å¤ªå¤§äº†", "error"); return; } const reader = new FileReader(); reader.onload = (e) => { currentImgBase64 = e.target.result; document.getElementById('preview-img').src = currentImgBase64; document.getElementById('preview-area').style.display = 'block'; }; reader.readAsDataURL(f); }
        function clearPreview() { currentImgBase64 = null; document.getElementById('preview-area').style.display = 'none'; document.getElementById('img-input').value = ""; }
        function toggleLiveMode() { if(window.innerWidth > 1024) { document.body.classList.toggle('live-mode'); showToast("ğŸ“º ç›´æ’­æ¨¡å¼"); window.dispatchEvent(new Event('resize')); } else { showToast("ä»…PCå¯ç”¨", "info"); } }
        
        socket.on('audio_failed', (d) => { if (d.type === 'warning' || d.type === 'info') showToast("ğŸ”Š " + d.msg, "info"); else showToast("âš ï¸ " + d.msg, "error"); });
        
        // éŸ³é¢‘æ’­æ”¾ä¸å£å‹é©±åŠ¨æ¡¥æ¥
        socket.on('audio_response',(d)=>{
            if(d.audio){
                let a = new Audio(); a.crossOrigin = "anonymous"; a.src = d.audio;
                let ui = document.createElement('audio'); ui.className = 'audio-player'; ui.controls = true; ui.src = d.audio;
                document.getElementById('chat-window').appendChild(ui);
                if(!audioCtx) try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}
                if(audioCtx){
                    if(audioCtx.state==='suspended') audioCtx.resume();
                    try{
                        let s=audioCtx.createMediaElementSource(a);
                        s.connect(analyser); analyser.connect(audioCtx.destination);
                        a.onplay=()=>{isTalking=true};
                        a.onpause=a.onended=()=>{isTalking=false};
                    }catch(e){}
                }
                a.play().catch(e=>{});
            }
        });

        socket.on('chat_message',(d)=>{addMsg(d.text,d.sender,d.sender===myUser?'self':'other', null, d.image);});
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        socket.on('toast',(d)=>showToast(d.text,d.type));
        
        function addMsg(t,u,y,e,img){ let d=document.createElement('div');d.className=`message-container ${y}`; if(y!=='system') d.innerHTML=`<div class=\"message-info\">${u} ${e?`<span class=\"emotion-tag\">${e}</span>`:''}</div>`; let contentHtml = `<div class=\"message-bubble\">`; if(img) contentHtml += `<img src=\"${img}\" class=\"message-img\" onclick=\"window.open(this.src)\">`; if(t) contentHtml += `<div>${t}</div>`; contentHtml += `</div>`; d.innerHTML+=contentHtml; document.getElementById('chat-window').appendChild(d); document.getElementById('chat-window').scrollTop=99999; }
        
        const send=()=>{ let i=document.getElementById('user-input');let t=i.value.trim(); if(!t && !currentImgBase64) return; 
            // ...æŒ‡ä»¤é€»è¾‘ç•¥ï¼Œä¸ä¹‹å‰ç›¸åŒ...
            if(t.startsWith('/')){ socket.emit('message',{text:t}); } // ç®€åŒ–
            else { socket.emit('message', {text:t, image: currentImgBase64}); } 
            i.value=''; clearPreview(); 
        };
        document.getElementById('send-btn').onclick=send; document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')send();};

    </script>
</body>
</html>

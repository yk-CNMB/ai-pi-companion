<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live (Hiyori)</title>
    <!-- æ ¸å¿ƒåº“ -->
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#dff9fb;overflow:hidden}
        #live2d-canvas{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;height:100%;z-index:0;pointer-events:none}
        #main-app{position:relative;z-index:2;height:100%;display:flex;flex-direction:column;background:rgba(255,255,255,0)}
        #header{background:rgba(108,92,231,0.8);color:white;padding:15px;text-align:center;font-weight:bold;backdrop-filter:blur(5px)}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:linear-gradient(to bottom,rgba(255,255,255,0.5),rgba(255,255,255,0.8))}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#666;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:80%;word-wrap:break-word;box-shadow:0 2px 5px rgba(0,0,0,0.1);backdrop-filter:blur(2px)}
        .self{align-items:flex-end} .self .message-bubble{background:rgba(108,92,231,0.9);color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:rgba(255,255,255,0.9);color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:rgba(255,240,246,0.95);color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:rgba(0,0,0,0.4);color:white;font-size:12px;padding:4px 12px;border-radius:12px}
        .audio-player{margin-top:6px;height:32px;max-width:80%;border-radius:16px;opacity:0.8}
        #input-area{display:flex;padding:10px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px)}
        #user-input{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;font-size:16px;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:10px 20px;margin-left:10px;border-radius:25px;font-weight:bold}
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:999;display:flex;align-items:center;justify-content:center}
        #login-box{background:white;padding:30px;border-radius:20px;text-align:center;width:85%;max-width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold}
    </style>
</head>
<body>
    <canvas id="live2d-canvas"></canvas>
    <div id="login-overlay"><div id="login-box"><h2>Pico ç›´æ’­é—´</h2><input type="text" id="username-input" placeholder="ä½ çš„æ˜µç§°" maxlength="10" autocomplete="off"><br><button id="login-btn">è¿›å…¥</button></div></div>
    <div id="main-app" style="display: none;"><div id="header">ğŸ¤– Pico Live</div><div id="chat-window"></div><div id="input-area"><input type="text" id="user-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off"><button id="send-btn">å‘é€</button></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // =========================================
        // ğŸ”§ ä½ç½®å¾®è°ƒåŒºåŸŸ (å¦‚æœä½ç½®ä¸å¯¹ï¼Œæ”¹è¿™é‡Œï¼)
        // =========================================
        const MODEL_SCALE = 1.1;  // ç¼©æ”¾æ¯”ä¾‹ (è¶Šå¤§è¶Šè¿‘)
        const OFFSET_X = 0;       // å·¦å³å¹³ç§» (è´Ÿæ•°å‘å·¦ï¼Œæ­£æ•°å‘å³)
        const OFFSET_Y = 100;     // ä¸Šä¸‹å¹³ç§» (è´Ÿæ•°å‘ä¸Šï¼Œæ­£æ•°å‘ä¸‹)
        // =========================================

        let app_pixi, model;
        let audioContext, analyser, dataArray, isTalking = false;

        async function initLive2D() {
            app_pixi = new PIXI.Application({
                view: document.getElementById('live2d-canvas'),
                autoStart: true, resizeTo: window, transparent: true
            });
            try {
                model = await PIXI.live2d.Live2DModel.from('/static/live2d/hiyori/Hiyori.model3.json');
                app_pixi.stage.addChild(model);
                resizeModel(); // åˆå§‹åŒ–æ—¶è°ƒæ•´ä¸€æ¬¡ä½ç½®
                app_pixi.ticker.add(lipSyncLoop);
                console.log("âœ… æ¨¡å‹åŠ è½½æˆåŠŸ");
            } catch (e) { console.error(e); alert("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶åã€‚"); }
        }
        if (typeof PIXI !== 'undefined') initLive2D();

        // --- æ ¸å¿ƒï¼šæ›´ç²¾ç¡®çš„ä½ç½®è°ƒæ•´å‡½æ•° ---
        function resizeModel() {
            if (model) {
                // 1. è®¡ç®—ç¼©æ”¾
                const scale = Math.min(window.innerWidth / model.width, window.innerHeight / model.height) * MODEL_SCALE;
                model.scale.set(scale);
                
                // 2. è®¡ç®—å±…ä¸­ä½ç½®
                // (å±å¹•å®½åº¦ - æ¨¡å‹å®é™…å®½åº¦) / 2 = æ°´å¹³å±…ä¸­
                model.x = (window.innerWidth - model.width) / 2 + OFFSET_X;
                // (å±å¹•é«˜åº¦ - æ¨¡å‹å®é™…é«˜åº¦) = å¯¹é½åº•éƒ¨ï¼Œå†åŠ åç§»é‡
                model.y = (window.innerHeight - model.height) + OFFSET_Y;
            }
        }
        // ç›‘å¬çª—å£å¤§å°æ”¹å˜ï¼Œå®æ—¶è°ƒæ•´
        window.addEventListener('resize', resizeModel);

        // --- Hiyori åŠ¨ä½œ ---
        function triggerMotion(emotion) {
            if (!model || !model.internalModel.motionManager) return;
            switch(emotion) {
                case 'HAPPY': model.internalModel.motionManager.startRandomMotion('Charm'); break;
                case 'ANGRY': case 'SHOCK': model.internalModel.motionManager.startRandomMotion('Shame'); break;
                case 'SAD': model.internalModel.motionManager.startRandomMotion('Idle'); break;
                case 'NORMAL': default: model.internalModel.motionManager.startRandomMotion('TapBody'); break;
            }
        }

        // --- å£å‹åŒæ­¥ ---
        function lipSyncLoop() {
            if (!model || !analyser || !isTalking) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0; for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let avg = sum / dataArray.length;
            if (model.internalModel && model.internalModel.coreModel) {
                 model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0, avg / 40));
            }
        }

        // --- ä¸šåŠ¡é€»è¾‘ (ä¿æŒä¸å˜) ---
        const socket = io({ reconnection: true });
        let myUser = "", lastPico = null;
        const overlay = document.getElementById('login-overlay'), main = document.getElementById('main-app'), chat = document.getElementById('chat-window'), input = document.getElementById('user-input'), head = document.getElementById('header');

        document.getElementById('login-btn').onclick = () => {
            let name = document.getElementById('username-input').value.trim();
            if (name) { myUser = name; socket.emit('login', { username: name }); initAudio(); }
        };
        function initAudio() { if(!audioContext) { try { audioContext = new (window.AudioContext||window.webkitAudioContext)(); analyser=audioContext.createAnalyser(); analyser.fftSize=512; dataArray=new Uint8Array(analyser.frequencyBinCount); } catch(e){} } }
        
        socket.on('login_success', (d) => { overlay.style.display='none'; main.style.display='flex'; head.textContent=`ğŸ¤– Pico (${myUser})`; });
        socket.on('login_failed', (d) => { alert(d.error); });
        function addMsg(txt, user, type, emo) {
            let div = document.createElement('div'); div.className=`message-container ${type}`;
            if(type!=='system') div.innerHTML=`<div class="message-info">${user} ${type==='pico'&&emo?`<span style="opacity:0.6">[${emo}]</span>`:''}</div>`;
            div.innerHTML+=`<div class="message-bubble">${txt}</div>`;
            chat.appendChild(div); chat.scrollTop=chat.scrollHeight;
            if(type==='pico') lastPico=div;
        }
        socket.on('chat_message', (d) => addMsg(d.text, d.sender, d.sender===myUser?'self':'other'));
        socket.on('system_message', (d) => addMsg(d.text, 'ç³»ç»Ÿ', 'system'));
        socket.on('response', (d) => { addMsg(d.text, 'Pico', 'pico', d.emotion); triggerMotion(d.emotion||'NORMAL'); });
        socket.on('audio_response', (d) => {
            if(d.audio && lastPico) {
                let a=new Audio(); a.crossOrigin="anonymous"; a.src=d.audio;
                let ui=document.createElement('audio'); ui.className='audio-player'; ui.controls=true; ui.src=d.audio;
                lastPico.appendChild(ui); chat.scrollTop=chat.scrollHeight;
                if(audioContext) {
                    if(audioContext.state==='suspended') audioContext.resume();
                    try {
                        let src = audioContext.createMediaElementSource(a);
                        src.connect(analyser); analyser.connect(audioContext.destination);
                        a.onplay=()=>{isTalking=true;}; 
                        a.onpause=()=>{isTalking=false;if(model)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0);};
                        a.onended=()=>{isTalking=false;if(model)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0);};
                    } catch(e){}
                }
                a.play().catch(()=>{});
            }
        });
        document.getElementById('send-btn').onclick = () => { if(input.value.trim()) { socket.emit('message', {text: input.value.trim()}); input.value=''; }};
        document.getElementById('user-input').onkeypress = (e) => { if(e.key==='Enter') document.getElementById('send-btn').click(); };
    </script>
</body>
</html>
```

### ğŸ› ï¸ å¦‚ä½•è°ƒèŠ‚ä½ç½®

å¦‚æœåˆ·æ–°åä½ç½®è¿˜æ˜¯ä¸å¯¹ï¼Œä½ åªéœ€è¦åœ¨æ ‘è“æ´¾ä¸Šç”¨ `nano templates/chat.html` æ‰“å¼€æ–‡ä»¶ï¼Œæ‰¾åˆ°æœ€ä¸Šé¢çš„è¿™å‡ è¡Œï¼š

```javascript
        // =========================================
        // ğŸ”§ ä½ç½®å¾®è°ƒåŒºåŸŸ (å¦‚æœä½ç½®ä¸å¯¹ï¼Œæ”¹è¿™é‡Œï¼)
        // =========================================
        const MODEL_SCALE = 1.1;  // ç¼©æ”¾æ¯”ä¾‹ (è¶Šå¤§è¶Šè¿‘)
        const OFFSET_X = 0;       // å·¦å³å¹³ç§» (è´Ÿæ•°å‘å·¦ï¼Œæ­£æ•°å‘å³)
        const OFFSET_Y = 100;     // ä¸Šä¸‹å¹³ç§» (è´Ÿæ•°å‘ä¸Šï¼Œæ­£æ•°å‘ä¸‹)

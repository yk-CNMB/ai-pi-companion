<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live (Ultimate)</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:2}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4}#chat-container{width:100%;flex:6}}
        #header{background:#6c5ce7;color:white;padding:15px;text-align:center;font-weight:bold;position:relative}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:linear-gradient(to bottom,rgba(255,255,255,0.5),rgba(255,255,255,0.8))}
        #input-area{display:flex;padding:10px;background:white}
        #user-input{flex:1;padding:10px;border-radius:20px;border:2px solid #eee;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:20px}
        
        /* --- æ¨¡å‹åˆ‡æ¢æŒ‰é’® & èœå• --- */
        #settings-btn {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            cursor: pointer; font-size: 20px; opacity: 0.8;
        }
        #settings-btn:hover { opacity: 1; }
        #model-menu {
            position: absolute; top: 50px; right: 10px; background: white;
            border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            padding: 10px; display: none; z-index: 100; max-height: 300px; overflow-y: auto;
        }
        .model-item {
            padding: 8px 12px; cursor: pointer; border-radius: 5px; color: #333;
            transition: background 0.2s; white-space: nowrap;
        }
        .model-item:hover { background: #f0f0f0; }
        .model-item.active { background: #6c5ce7; color: white; }

        /* --- å…¶ä»–å¿…è¦çš„ UI --- */
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999;display:flex;align-items:center;justify-content:center}
        #login-box{background:white;padding:30px;border-radius:20px;text-align:center;width:80%;max-width:300px}
        #username-input{width:80%;padding:10px;margin:20px 0;border-radius:10px;border:2px solid #6c5ce7;text-align:center}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:10px 30px;border-radius:20px}
        .message-bubble{padding:10px;border-radius:15px;margin-bottom:10px;max-width:85%;word-wrap:break-word;background:white}
        .self .message-bubble{background:#6c5ce7;color:white;align-self:flex-end}
        .message-container{display:flex;flex-direction:column}
        .self{align-items:flex-end} .other,.pico{align-items:flex-start}
        .audio-player{width:80%;height:30px;margin-top:5px}
    </style>
</head>
<body>
    <div id="login-overlay"><div id="login-box"><h2>Pico ç›´æ’­é—´</h2><input id="username-input" placeholder="æ˜µç§°"><br><button id="login-btn">è¿›å…¥</button></div></div>
    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container">
        <div id="header">
            ğŸ¤– äº’åŠ¨åŒº
            <!-- è®¾ç½®æŒ‰é’® -->
            <div id="settings-btn" title="åˆ‡æ¢æ¨¡å‹">âš™ï¸</div>
        </div>
        <!-- æ¨¡å‹èœå• -->
        <div id="model-menu">æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...</div>
        
        <div id="chat-window"></div>
        <div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        let app_pixi, model, currentModelPath;
        const socket = io({ reconnection: true });

        // --- Live2D å¼•æ“ ---
        async function initPixi() {
            app_pixi = new PIXI.Application({
                view: document.getElementById('live2d-canvas'),
                autoStart: true, resizeTo: document.getElementById('stage-container'), transparent: true
            });
        }
        if(typeof PIXI!=='undefined') initPixi();

        // åŠ è½½æŒ‡å®šæ¨¡å‹
        async function loadModel(path) {
            if (!app_pixi) return;
            console.log("ğŸ”„ æ­£åœ¨åˆ‡æ¢æ¨¡å‹:", path);
            try {
                // ç§»é™¤æ—§æ¨¡å‹
                if (model) app_pixi.stage.removeChild(model);
                
                // åŠ è½½æ–°æ¨¡å‹
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                currentModelPath = path;

                // è‡ªåŠ¨è°ƒæ•´å¤§å°å’Œä½ç½®
                resizeModel();
                
                console.log("âœ… æ¨¡å‹åˆ‡æ¢æˆåŠŸ");
                // å°è¯•åŠ¨ä¸€ä¸‹ï¼Œç¡®è®¤å®ƒæ˜¯æ´»çš„
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');

            } catch (e) {
                console.error("âŒ æ¨¡å‹åŠ è½½å¤±è´¥:", e);
                alert("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´ã€‚");
            }
        }

        function resizeModel() {
            if (!model || !app_pixi) return;
            const stage = document.getElementById('stage-container');
            // ç¨å¾®ç¼©å°ä¸€ç‚¹ï¼Œé˜²æ­¢å¤ªæ»¡
            const scale = Math.min(stage.clientWidth/model.width, stage.clientHeight/model.height) * 0.9;
            model.scale.set(scale);
            model.x = (stage.clientWidth - model.width * scale) / 2;
            model.y = stage.clientHeight - model.height * scale; // åº•å¯¹é½
        }
        window.onresize = resizeModel;

        // --- æ¨¡å‹åˆ‡æ¢å™¨é€»è¾‘ ---
        const settingsBtn = document.getElementById('settings-btn');
        const modelMenu = document.getElementById('model-menu');
        
        settingsBtn.onclick = (e) => {
            e.stopPropagation();
            // åˆ‡æ¢èœå•æ˜¾ç¤ºï¼Œå¹¶è¯·æ±‚æœ€æ–°çš„æ¨¡å‹åˆ—è¡¨
            if (modelMenu.style.display === 'block') {
                modelMenu.style.display = 'none';
            } else {
                socket.emit('get_models');
                modelMenu.style.display = 'block';
            }
        };
        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        document.onclick = () => modelMenu.style.display = 'none';

        // æ”¶åˆ°æ¨¡å‹åˆ—è¡¨
        socket.on('models_list', (data) => {
            modelMenu.innerHTML = ""; // æ¸…ç©ºæ—§åˆ—è¡¨
            data.models.forEach(m => {
                const item = document.createElement('div');
                item.className = `model-item ${m.path === data.current ? 'active' : ''}`;
                item.textContent = m.name;
                item.onclick = () => {
                    // ç‚¹å‡»åï¼Œå‘æœåŠ¡å™¨å‘é€åˆ‡æ¢è¯·æ±‚
                    socket.emit('change_model', { path: m.path });
                };
                modelMenu.appendChild(item);
            });
        });

        // --- ç›‘å¬æœåŠ¡å™¨çš„æ¨¡å‹åˆ‡æ¢æŒ‡ä»¤ ---
        socket.on('model_changed', (data) => {
            loadModel(data.path);
        });

        // --- ç™»å½•ä¸èŠå¤©é€»è¾‘ ---
        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display='none';
            // ç™»å½•æˆåŠŸåï¼ŒåŠ è½½å½“å‰æœåŠ¡å™¨æŒ‡å®šçš„æ¨¡å‹
            if (d.current_model) loadModel(d.current_model);
        });
        
        // (ç®€åŒ–ç‰ˆæ¶ˆæ¯å¤„ç†ï¼ŒåŠŸèƒ½ä¸ä¹‹å‰ç›¸åŒ)
        socket.on('chat', (d) => addMsg(d.text, d.sender, d.sender===document.getElementById('username-input').value?'self':'other'));
        socket.on('sys', (d) => addMsg(d.text, 'ç³»ç»Ÿ', 'system'));
        socket.on('response', (d) => { addMsg(d.text, 'Pico', 'pico', d.emotion); triggerMotion(d.emotion||'NORMAL'); });
        socket.on('audio_response', (d) => { /* ...ä¹‹å‰çš„éŸ³é¢‘æ’­æ”¾ä»£ç ... */ });

        // ... (å…¶ä½™åŸºç¡€äº‹ä»¶ç»‘å®š) ...
        document.getElementById('login-btn').onclick=()=>{let n=document.getElementById('username-input').value;if(n)socket.emit('login',{username:n});};
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;d.innerHTML=`<div class="message-info">${u} ${e?`[${e}]`:''}</div><div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;}
        document.getElementById('send-btn').onclick=()=>{let i=document.getElementById('user-input');if(i.value){socket.emit('message',{text:i.value});i.value='';}};

        // åŠ¨ä½œè§¦å‘ (é€šç”¨ç‰ˆ)
        function triggerMotion(emo) {
            if(!model?.internalModel?.motionManager)return;
            try {
                // å°è¯•æ ¹æ®ä¸åŒæ¨¡å‹çš„é€šç”¨åŠ¨ä½œç»„åç§°æ¥è§¦å‘
                const groups = model.internalModel.motionManager.motionGroups;
                let group = 'Idle'; // é»˜è®¤
                if (emo==='HAPPY' && groups.includes('Charm')) group='Charm';
                else if (emo==='HAPPY' && groups.includes('Joy')) group='Joy';
                else if ((emo==='ANGRY'||emo==='SHOCK') && groups.includes('Shame')) group='Shame';
                else if ((emo==='ANGRY'||emo==='SHOCK') && groups.includes('Anger')) group='Anger';
                else if (groups.includes('TapBody')) group='TapBody';

                model.internalModel.motionManager.startRandomMotion(group);
            } catch(e){}
        }
    </script>
</body>
</html>


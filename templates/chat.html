<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live (Ultimate)</title>
    
    <!-- ========================================= -->
    <!-- æ ¸å¿ƒå›¾å½¢åº“ (æœ¬åœ°åŠ è½½ï¼Œç¡®ä¿ç¨³å®š) -->
    <!-- ========================================= -->
    <script src="/static/js/live2d.min.js"></script>          <!-- æ—§ç‰ˆæ¨¡å‹æ ¸å¿ƒ -->
    <script src="/static/js/live2dcubismcore.min.js"></script> <!-- æ–°ç‰ˆæ¨¡å‹æ ¸å¿ƒ -->
    <script src="/static/js/pixi.min.js"></script>             <!-- PixiJS æ¸²æŸ“å¼•æ“ -->
    <script src="/static/js/index.min.js"></script>            <!-- Live2D é€‚é…æ’ä»¶ -->

    <style>
        /* --- å…¨å±€è®¾ç½® --- */
        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            background-color: #dff9fb; overflow: hidden; /* é˜²æ­¢å‡ºç°åŒæ»šåŠ¨æ¡ */
        }

        /* --- Live2D ç”»å¸ƒ (ä½äºæœ€åº•å±‚) --- */
        #live2d-canvas {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; height: 100%;
            z-index: 0; pointer-events: none; /* è®©é¼ æ ‡ç‚¹å‡»ç©¿é€ç”»å¸ƒ */
        }

        /* --- ä¸»ç•Œé¢å®¹å™¨ (åŠé€æ˜ï¼Œæµ®åœ¨æ¨¡å‹ä¸Šæ–¹) --- */
        #main-app {
            position: relative; z-index: 2; height: 100%;
            display: flex; flex-direction: column;
            background: rgba(255, 255, 255, 0.0); /* å®Œå…¨é€æ˜èƒŒæ™¯ */
        }

        /* --- é¡¶éƒ¨æ ‡é¢˜æ  --- */
        #header {
            background: rgba(108, 92, 231, 0.85); color: white;
            padding: 15px; text-align: center; font-weight: bold;
            backdrop-filter: blur(10px); /* æ¯›ç»ç’ƒæ•ˆæœ */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* --- èŠå¤©è®°å½•çª—å£ --- */
        #chat-window {
            flex: 1; overflow-y: auto; padding: 15px;
            /* æ¸å˜åŠé€æ˜èƒŒæ™¯ï¼Œä¿è¯æ–‡å­—å¯è¯»æ€§ */
            background: linear-gradient(to bottom, rgba(255,255,255,0.4), rgba(255,255,255,0.85));
            scroll-behavior: smooth;
        }

        /* --- æ¶ˆæ¯å®¹å™¨é€šç”¨æ ·å¼ --- */
        .message-container {
            display: flex; flex-direction: column; margin-bottom: 15px;
            animation: fadeIn 0.3s ease; /* æ¶ˆæ¯å‡ºç°æ—¶çš„æ·¡å…¥åŠ¨ç”» */
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-info {
            font-size: 12px; color: #666; margin-bottom: 4px; padding: 0 8px;
        }
        .message-bubble {
            padding: 12px 16px; border-radius: 18px; max-width: 85%;
            word-wrap: break-word; line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            backdrop-filter: blur(5px);
        }

        /* --- ä¸åŒè§’è‰²çš„æ¶ˆæ¯æ ·å¼ --- */
        /* è‡ªå·± (å³ä¾§ï¼Œè“è‰²ç³») */
        .self { align-items: flex-end; }
        .self .message-info { text-align: right; }
        .self .message-bubble {
            background: rgba(108, 92, 231, 0.95); color: white;
            border-bottom-right-radius: 4px;
        }

        /* å…¶ä»–äºº (å·¦ä¾§ï¼Œç™½è‰²ç³») */
        .other { align-items: flex-start; }
        .other .message-bubble {
            background: rgba(255, 255, 255, 0.95); color: #333;
            border-bottom-left-radius: 4px;
        }

        /* Pico (å·¦ä¾§ï¼Œç²‰è‰²é«˜äº®) */
        .pico { align-items: flex-start; }
        .pico .message-info { color: #e84393; font-weight: bold; }
        .pico .message-bubble {
            background: rgba(255, 240, 246, 0.95); color: #333;
            border: 2px solid #f8a5c2; /* ç²‰è‰²è¾¹æ¡† */
            border-bottom-left-radius: 4px;
        }
        /* æƒ…æ„Ÿæ ‡ç­¾æ ·å¼ */
        .emotion-tag {
            font-size: 0.8em; opacity: 0.7; margin-left: 5px;
            background: #f8a5c2; color: white; padding: 2px 6px; border-radius: 10px;
        }

        /* ç³»ç»Ÿé€šçŸ¥ (ä¸­é—´ï¼Œç°è‰²å°å­—) */
        .system { align-items: center; margin: 10px 0; }
        .system .message-bubble {
            background: rgba(0, 0, 0, 0.05); color: #666;
            font-size: 12px; padding: 4px 12px; border-radius: 12px;
            box-shadow: none;
        }

        /* --- åº•éƒ¨è¾“å…¥åŒºåŸŸ --- */
        #input-area {
            display: flex; padding: 12px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05);
        }
        #user-input {
            flex: 1; padding: 12px 15px; font-size: 16px;
            border: 2px solid #eee; border-radius: 25px; outline: none;
            transition: border-color 0.3s;
        }
        #user-input:focus { border-color: #6c5ce7; }
        #send-btn {
            background: #6c5ce7; color: white; border: none;
            padding: 0 25px; margin-left: 10px; border-radius: 25px;
            font-weight: bold; font-size: 16px; cursor: pointer;
            transition: transform 0.1s, background-color 0.3s;
        }
        #send-btn:active { transform: scale(0.95); }

        /* --- ç™»å½•é®ç½©å±‚ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); /* æ·±è‰²åŠé€æ˜èƒŒæ™¯ */
            z-index: 999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(8px);
        }
        #login-box {
            background: white; padding: 40px 30px; border-radius: 25px;
            text-align: center; width: 85%; max-width: 350px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        #login-box h2 { margin-top: 0; color: #2d3436; }
        #username-input {
            width: 100%; padding: 15px; margin: 25px 0; box-sizing: border-box;
            border: 3px solid #a29bfe; border-radius: 15px;
            font-size: 18px; text-align: center; outline: none;
            transition: border-color 0.3s;
        }
        #username-input:focus { border-color: #6c5ce7; }
        #login-btn {
            width: 100%; padding: 15px; background: #6c5ce7; color: white;
            border: none; border-radius: 30px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: background-color 0.3s;
        }
        #login-btn:disabled { background: #b2bec3; cursor: not-allowed; }

        /* --- éŸ³é¢‘æ’­æ”¾å™¨ --- */
        /* éšè—é»˜è®¤æ’­æ”¾å™¨ï¼Œæˆ‘ä»¬ç”¨çº¯ JS æ§åˆ¶ï¼Œæˆ–è€…ä½ å¯ä»¥æŠŠå®ƒè®¾ä¸º visible æ¥è°ƒè¯• */
        .audio-player {
            margin-top: 8px; height: 32px; width: 100%;
            opacity: 0.6; transition: opacity 0.3s;
        }
        .audio-player:hover { opacity: 1; }

    </style>
</head>
<body>
    <!-- Live2D ç”»å¸ƒ -->
    <canvas id="live2d-canvas"></canvas>

    <!-- ç™»å½•é®ç½© -->
    <div id="login-overlay">
        <div id="login-box">
            <h2>æ¬¢è¿æ¥åˆ° Pico ç›´æ’­é—´</h2>
            <p style="color:#999; margin-bottom: 20px;">ç»™è‡ªå·±èµ·ä¸ªå“äº®çš„åå­—å§</p>
            <input type="text" id="username-input" placeholder="ä½ çš„æ˜µç§°" maxlength="12" autocomplete="off">
            <button id="login-btn">è¿›å…¥ç›´æ’­é—´</button>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ (åˆå§‹éšè—) -->
    <div id="main-app" style="display: none;">
        <div id="header">ğŸ¤– Pico Live</div>
        <div id="chat-window"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <!-- å¼•å…¥ Socket.IO åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    
    <script>
        // =========================================
        // 1. å…¨å±€å˜é‡å®šä¹‰
        // =========================================
        let app_pixi, model; // Live2D ç›¸å…³
        let audioContext, analyser, dataArray; // éŸ³é¢‘åˆ†æç›¸å…³ (ç”¨äºå£å‹)
        let isTalking = false; // æ ‡è®°å½“å‰æ˜¯å¦æ­£åœ¨è¯´è¯
        
        const socket = io({ reconnection: true }); // Socket è¿æ¥
        let myUsername = "";
        let lastPicoContainer = null; // è®°å½•æœ€åä¸€æ¡ Pico æ¶ˆæ¯ï¼Œç”¨äºè¿½åŠ éŸ³é¢‘æ’­æ”¾å™¨

        // =========================================
        // 2. Live2D å¼•æ“åˆå§‹åŒ–
        // =========================================
        async function initLive2D() {
            console.log("ğŸš€ å¼€å§‹åˆå§‹åŒ– Live2D...");
            app_pixi = new PIXI.Application({
                view: document.getElementById('live2d-canvas'),
                autoStart: true,
                resizeTo: window,
                transparent: true // èƒŒæ™¯é€æ˜
            });

            try {
                // åŠ è½½æœ¬åœ°æ¨¡å‹
                model = await PIXI.live2d.Live2DModel.from('/static/live2d/shizuku/shizuku.model.json');
                app_pixi.stage.addChild(model);

                // è°ƒæ•´æ¨¡å‹å¤§å°å’Œä½ç½® (è‡ªé€‚åº”å±å¹•)
                resizeModel();

                // å¯åŠ¨å£å‹åŒæ­¥å¾ªç¯ä¾¦å¬å™¨
                app_pixi.ticker.add(lipSyncLoop);
                
                console.log("âœ… Live2D æ¨¡å‹åŠ è½½å®Œæ¯•");

            } catch (e) {
                console.error("âŒ Live2D åŠ è½½å¤±è´¥:", e);
                alert("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é™æ€èµ„æºã€‚");
            }
        }
        // ç¡®ä¿ PixiJS å·²åŠ è½½åå†è¿è¡Œ
        if (typeof PIXI !== 'undefined') {
            initLive2D();
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶è‡ªåŠ¨è°ƒæ•´æ¨¡å‹
        function resizeModel() {
            if (model) {
                const scale = Math.min(window.innerWidth / model.width, window.innerHeight / model.height) * 1.35;
                model.scale.set(scale);
                model.x = (window.innerWidth - model.width) / 2;
                model.y = window.innerHeight - model.height + 180; // ç¨å¾®å¾€ä¸‹æ”¾ä¸€ç‚¹
            }
        }
        window.addEventListener('resize', resizeModel);

        // =========================================
        // 3. å£å‹åŒæ­¥ & åŠ¨ä½œæ§åˆ¶æ ¸å¿ƒ
        // =========================================
        
        // æ¯ä¸€å¸§éƒ½ä¼šè¿è¡Œè¿™ä¸ªå‡½æ•°ï¼Œæ£€æŸ¥éŸ³é‡å¹¶æ›´æ–°å˜´å·´
        function lipSyncLoop() {
            if (!model || !analyser || !isTalking) return;

            // è·å–å½“å‰éŸ³é¢‘æ•°æ®
            analyser.getByteFrequencyData(dataArray);
            
            // è®¡ç®—å¹³å‡éŸ³é‡
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let average = sum / dataArray.length;

            // å°†éŸ³é‡ (0~255) æ˜ å°„åˆ°å˜´å·´å¼ åˆåº¦ (0.0~1.0)
            // é™¤ä»¥ 30 æ˜¯ä¸€ä¸ªç»éªŒå€¼ï¼Œä½ å¯ä»¥è°ƒæ•´å®ƒæ¥æ”¹å˜å˜´å·´çµæ•åº¦
            let mouthOpen = Math.min(1.0, average / 30);

            // è®¾ç½®æ¨¡å‹å‚æ•° (Cubism 2.1 æ ‡å‡†å‚æ•°å)
            if (model.internalModel && model.internalModel.coreModel) {
                model.internalModel.coreModel.setParamFloat('PARAM_MOUTH_OPEN_Y', mouthOpen);
            }
        }

        // æ ¹æ®æƒ…æ„Ÿæ ‡ç­¾è§¦å‘åŠ¨ä½œ
        function triggerMotion(emotion) {
            if (!model || !model.internalModel.motionManager) return;
            
            console.log("ğŸ­ æ”¶åˆ°æƒ…æ„ŸæŒ‡ä»¤:", emotion);
            
            // Shizuku çš„åŠ¨ä½œåº“æ¯”è¾ƒè€ï¼Œæˆ‘ä»¬å°½é‡æ‰¾åˆé€‚çš„å¯¹åº”
            switch (emotion) {
                case 'HAPPY':
                    // å¼€å¿ƒæ—¶æ™ƒåŠ¨èº«ä½“
                    model.internalModel.motionManager.startMotion('pinch_out', 0, 3);
                    break;
                case 'ANGRY':
                case 'SHOCK':
                    // ç”Ÿæ°”æˆ–æƒŠè®¶æ—¶å¿«é€Ÿæ‘‡å¤´
                    model.internalModel.motionManager.startMotion('shake', 0, 3);
                    break;
                case 'SAD':
                    // æ‚²ä¼¤æ—¶ä½ä¸‹å¤´ (ç”¨ idle æ¨¡æ‹Ÿå¹³é™)
                    model.internalModel.motionManager.startMotion('idle', 0, 3);
                    break;
                case 'NORMAL':
                default:
                    // æ™®é€šå¯¹è¯åŠ¨ä½œ
                    model.internalModel.motionManager.startRandomMotion('tap_body');
                    break;
            }
        }

        // =========================================
        // 4. èŠå¤©å®¤ UI é€»è¾‘
        // =========================================

        // ç™»å½•æŒ‰é’®ç‚¹å‡»
        document.getElementById('login-btn').addEventListener('click', () => {
            const usernameInput = document.getElementById('username-input');
            const name = usernameInput.value.trim();
            if (name) {
                myUsername = name;
                socket.emit('login', { username: name });
                document.getElementById('login-btn').textContent = "æ­£åœ¨è¿æ¥...";
                document.getElementById('login-btn').disabled = true;
                
                // ç”¨æˆ·äº§ç”Ÿç¬¬ä¸€æ¬¡äº¤äº’ï¼Œæ­¤æ—¶å¯ä»¥åˆå§‹åŒ–éŸ³é¢‘å¼•æ“äº†
                initAudioContext();
            }
        });

        // åˆå§‹åŒ– Web Audio API (å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»åæ‰èƒ½è°ƒç”¨)
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 512; // é‡‡æ ·ç²¾åº¦
                    dataArray = new Uint8Array(analyser.frequencyBinCount);
                    console.log("ğŸ”Š éŸ³é¢‘å¼•æ“å·²å¯åŠ¨");
                } catch (e) {
                    console.warn("âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒ Web Audio APIï¼Œå£å‹åŒæ­¥å°†ä¸å¯ç”¨");
                }
            }
        }

        // ç™»å½•æˆåŠŸ
        socket.on('login_success', (data) => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('header').textContent = `ğŸ¤– Pico ç›´æ’­é—´ (${myUsername})`;
        });

        // ç™»å½•å¤±è´¥
        socket.on('login_failed', (data) => {
            alert("ç™»å½•å¤±è´¥: " + data.error);
            document.getElementById('login-btn').textContent = "é‡è¯•";
            document.getElementById('login-btn').disabled = false;
        });

        // =========================================
        // 5. æ¶ˆæ¯å¤„ç†æ ¸å¿ƒ
        // =========================================

        // é€šç”¨ï¼šå‘èŠå¤©çª—å£æ·»åŠ ä¸€æ¡æ¶ˆæ¯
        function appendMessage(text, senderName, type, emotion) {
            const chatWindow = document.getElementById('chat-window');
            const container = document.createElement('div');
            container.className = `message-container ${type}`;
            
            // ç³»ç»Ÿæ¶ˆæ¯ä¸æ˜¾ç¤ºåå­—
            if (type !== 'system') {
                let infoHtml = `<div class="message-info">${senderName}`;
                // å¦‚æœæ˜¯ Pico ä¸”æœ‰æƒ…æ„Ÿæ ‡ç­¾ï¼Œæ˜¾ç¤ºå‡ºæ¥æ–¹ä¾¿è°ƒè¯• (å¯é€‰)
                if (type === 'pico' && emotion && emotion !== 'NORMAL') {
                     infoHtml += `<span class="emotion-tag">${emotion}</span>`;
                }
                infoHtml += `</div>`;
                container.innerHTML = infoHtml;
            }

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            container.appendChild(bubble);

            chatWindow.appendChild(container);
            // æ»šåŠ¨åˆ°åº•éƒ¨
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // å¦‚æœæ˜¯ Pico çš„æ¶ˆæ¯ï¼Œè®°å½•ä¸‹æ¥ï¼Œç­‰ä¼šå„¿è¯­éŸ³æ’­æ”¾å™¨è¦åŠ åœ¨è¿™é‡Œ
            if (type === 'pico') {
                lastPicoContainer = container;
            }
        }

        // æ”¶åˆ°æ™®é€šèŠå¤©æ¶ˆæ¯
        socket.on('chat_message', (data) => {
            const type = (data.sender === myUsername) ? 'self' : 'other';
            appendMessage(data.text, data.sender, type);
        });

        // æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯
        socket.on('system_message', (data) => {
            appendMessage(data.text, 'ç³»ç»Ÿ', 'system');
        });

        // æ”¶åˆ° AI å›å¤ (å¸¦æƒ…æ„Ÿ)
        socket.on('response', (data) => {
            // æ˜¾ç¤ºæ–‡å­—
            appendMessage(data.text, 'ğŸ¤– Pico', 'pico', data.emotion);
            // è§¦å‘ Live2D åŠ¨ä½œ
            triggerMotion(data.emotion || 'NORMAL');
        });

        // æ”¶åˆ°è¯­éŸ³ (æ ¸å¿ƒï¼šè¿æ¥å£å‹)
        socket.on('audio_response', (data) => {
            if (!data.audio) return;

            // åˆ›å»ºä¸€ä¸ªä¸å¯è§çš„éŸ³é¢‘å¯¹è±¡ç”¨äºæ’­æ”¾
            const audio = new Audio();
            audio.crossOrigin = "anonymous"; // é˜²æ­¢è·¨åŸŸé—®é¢˜å¯¼è‡´çš„éŸ³é¢‘åˆ†æå¤±è´¥
            audio.src = data.audio;

            // å¦‚æœä¹‹å‰åˆå§‹åŒ–äº† AudioContextï¼Œå°±æŠŠå®ƒè¿æ¥ä¸Šå»
            if (audioContext && analyser) {
                // ç¡®ä¿ AudioContext æ˜¯æ¿€æ´»çŠ¶æ€
                if (audioContext.state === 'suspended') audioContext.resume();

                try {
                    const source = audioContext.createMediaElementSource(audio);
                    source.connect(analyser);
                    analyser.connect(audioContext.destination); // è¿æ¥åˆ°æ‰¬å£°å™¨
                } catch (e) {
                     // é˜²æ­¢é‡å¤è¿æ¥æŠ¥é”™
                }

                // ç›‘å¬æ’­æ”¾çŠ¶æ€ï¼Œæ§åˆ¶ isTalking æ ‡å¿—ä½
                audio.onplay = () => { isTalking = true; };
                audio.onpause = () => { isTalking = false; resetMouth(); };
                audio.onended = () => { isTalking = false; resetMouth(); };
            }

            // å°è¯•è‡ªåŠ¨æ’­æ”¾
            audio.play().then(() => {
                console.log("âœ… è‡ªåŠ¨æ’­æ”¾æˆåŠŸ");
            }).catch(e => {
                console.warn("âš ï¸ è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œæ·»åŠ æ‰‹åŠ¨æ’­æ”¾å™¨");
                // å¦‚æœè‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œæ‰åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ªæ‰‹åŠ¨æ’­æ”¾å™¨
                if (lastPicoContainer) {
                    const uiAudio = document.createElement('audio');
                    uiAudio.className = 'audio-player';
                    uiAudio.controls = true;
                    uiAudio.src = data.audio;
                    lastPicoContainer.appendChild(uiAudio);
                    document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
                }
            });
        });

        // è¾…åŠ©å‡½æ•°ï¼šé‡ç½®å˜´å·´åˆ°é—­åˆçŠ¶æ€
        function resetMouth() {
            if (model && model.internalModel && model.internalModel.coreModel) {
                model.internalModel.coreModel.setParamFloat('PARAM_MOUTH_OPEN_Y', 0);
            }
        }

        // =========================================
        // 6. å‘é€æ¶ˆæ¯
        // =========================================
        function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (text) {
                socket.emit('message', { text: text });
                input.value = '';
            }
        }
        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

    </script>
</body>
</html>

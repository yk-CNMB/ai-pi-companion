<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Studio</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* --- å¸ƒå±€æ ·å¼ --- */
        body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 0; height: 100vh; background-color: #2d3436; display: flex; overflow: hidden; color: #333; }
        #stage-container { flex: 1; position: relative; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); overflow: hidden; }
        #live2d-canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        #chat-container { width: 400px; display: flex; flex-direction: column; background: rgba(255,255,255,0.95); z-index: 10; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        @media(max-width:768px) { body { flex-direction: column; } #stage-container { flex: 4; } #chat-container { width: 100%; flex: 6; } }

        /* --- ç™»å½•å±‚ (æœ€é«˜å±‚çº§ Z=9999) --- */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        #login-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 85%; max-width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #username-input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #6c5ce7; border-radius: 10px; font-size: 18px; text-align: center; outline: none; }
        #login-btn { background: #6c5ce7; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; transition: all 0.2s; }
        #login-btn:disabled { background: #b2bec3; cursor: not-allowed; transform: none !important; }
        #login-btn:active { transform: scale(0.95); }
        #login-status { margin-top: 10px; color: #e74c3c; font-size: 14px; min-height: 20px; }

        /* --- å·¥ä½œå®¤å±‚ (Z=8888) --- */
        #studio-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 8888; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .model-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; margin-top: 10px; }
        .model-card { background: #f0f0f0; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .model-card.active { border-color: #6c5ce7; background: #e0dfff; }
        .btn-del { color: red; font-size: 12px; display: block; margin-top: 5px; }

        /* --- èŠå¤©ç»„ä»¶ --- */
        #header { background: #6c5ce7; color: white; padding: 15px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; }
        #studio-btn { cursor: pointer; padding: 5px 10px; background: rgba(0,0,0,0.1); border-radius: 5px; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; background: #f5f7fa; }
        .message-container { display: flex; margin-bottom: 15px; flex-direction: column; }
        .message-info { font-size: 12px; color: #999; margin-bottom: 4px; padding: 0 5px; }
        .message-bubble { padding: 10px 14px; border-radius: 16px; max-width: 85%; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .self { align-items: flex-end; } .self .message-bubble { background: #6c5ce7; color: white; border-bottom-right-radius: 4px; }
        .other { align-items: flex-start; } .other .message-bubble { background: white; color: #333; border-bottom-left-radius: 4px; }
        .pico { align-items: flex-start; } .pico .message-info { color: #e84393; font-weight: bold; } .pico .message-bubble { background: #fff0f6; color: #333; border: 2px solid #f8a5c2; border-bottom-left-radius: 4px; }
        #input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; }
        #send-btn { background: #6c5ce7; color: white; border: none; padding: 0 20px; margin-left: 10px; border-radius: 25px; font-weight: bold; }
        .audio-player { margin-top: 8px; height: 32px; width: 100%; opacity: 0.8; border-radius: 16px; }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 80%; max-width: 300px; text-align: center; }
        .toast { background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 25px; margin-bottom: 10px; font-size: 14px; animation: fadeOut 3s forwards 2s; }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- ç™»å½•å±‚ -->
    <div id="login-overlay">
        <div id="login-box">
            <h2>Pico ç›´æ’­é—´</h2>
            <input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off">
            <br>
            <button id="login-btn" disabled>è¿æ¥æœåŠ¡å™¨ä¸­...</button>
            <div id="login-status"></div>
        </div>
    </div>

    <!-- å·¥ä½œå®¤å±‚ -->
    <div id="studio-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>ğŸ› ï¸ æ¨¡å‹ç®¡ç†</h3>
                <button onclick="document.getElementById('studio-overlay').style.display='none'" style="border:none;background:none;font-size:24px;">Ã—</button>
            </div>
            <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            <hr>
            <h3>ğŸ§  äººè®¾ç¼–è¾‘</h3>
            <textarea id="persona-text" style="width:100%;height:100px;margin-bottom:10px;"></textarea>
            <button id="save-persona-btn" style="width:100%;padding:10px;background:#6c5ce7;color:white;border:none;border-radius:10px;">ä¿å­˜äººè®¾</button>
            <hr>
            <h3>â˜ï¸ ä¸‹è½½æ›´å¤š</h3>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                <button onclick="dlModel('Mao')">Mao</button>
                <button onclick="dlModel('Natori')">Natori</button>
                <button onclick="dlModel('Rice')">Rice</button>
                <button onclick="dlModel('Wanko')">Wanko</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container">
        <div id="header"><span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span><div id="studio-btn">âš™ï¸ è®¾ç½®</div></div>
        <div id="chat-window"></div>
        <div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <script>
        // --- 1. åŸºç¡€è¿æ¥ä¸ç™»å½• ---
        const socket = io({reconnection: true});
        let myUser = "", currentModelId = "";
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');

        // è¿æ¥çŠ¶æ€ç›‘æ§
        socket.on('connect', () => {
            loginBtn.textContent = "è¿›å…¥ç›´æ’­é—´";
            loginBtn.disabled = false;
            loginStatus.textContent = "";
        });
        socket.on('disconnect', () => {
            loginBtn.textContent = "å·²æ–­å¼€ï¼Œé‡è¿ä¸­...";
            loginBtn.disabled = true;
            loginStatus.textContent = "ç½‘ç»œè¿æ¥å·²ä¸­æ–­";
        });
        socket.on('connect_error', (err) => {
            loginBtn.textContent = "è¿æ¥å¤±è´¥";
            loginStatus.textContent = "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨";
            console.error("Socket Error:", err);
        });

        // ç™»å½•æ“ä½œ
        loginBtn.onclick = () => {
            const name = document.getElementById('username-input').value.trim();
            if (!name) {
                shake(document.getElementById('username-input'));
                return;
            }
            myUser = name;
            loginBtn.disabled = true;
            loginBtn.textContent = "æ­£åœ¨ç™»å½•...";
            socket.emit('login', {username: name});
            
            // å°è¯•åˆå§‹åŒ–éŸ³é¢‘ç¯å¢ƒ (éœ€è¦ç”¨æˆ·äº¤äº’)
            initAudio();
        };

        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('room-title').textContent = `ğŸ¤– ${d.current_model.name} (${myUser})`;
            if (d.current_model.path) loadModel(d.current_model.path);
        });

        socket.on('login_failed', (d) => {
            loginBtn.disabled = false;
            loginBtn.textContent = "é‡è¯•";
            loginStatus.textContent = d.error;
        });

        // --- 2. Live2D å¼•æ“ (å¸¦é”™è¯¯å¤„ç†) ---
        let app_pixi, model, isDragging = false, dragData;
        
        async function loadModel(path) {
            if (!window.PIXI) { showToast("âŒ å›¾å½¢å¼•æ“æœªåŠ è½½", "error"); return; }
            if (!app_pixi) {
                app_pixi = new PIXI.Application({
                    view: document.getElementById('live2d-canvas'),
                    autoStart: true, resizeTo: document.getElementById('stage-container'), transparent: true
                });
                // å¯ç”¨äº¤äº’
                app_pixi.stage.interactive = true;
                app_pixi.stage.on('pointerdown', onDragStart).on('pointerup', onDragEnd).on('pointerupoutside', onDragEnd).on('pointermove', onDragMove);
                document.getElementById('stage-container').addEventListener('wheel', onWheel, {passive: false});
            }
            try {
                if (model) app_pixi.stage.removeChild(model);
                console.log("Load:", path);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resetModel();
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                // å°è¯•æ’­æ”¾éšæœºåŠ¨ä½œ
                if (model.internalModel.motionManager) {
                    model.internalModel.motionManager.startRandomMotion('Idle');
                }
            } catch (e) {
                console.error(e);
                showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶", "error");
            }
        }

        function resetModel() {
            if (!model || !app_pixi) return;
            const st = document.getElementById('stage-container');
            const sc = Math.min(st.clientWidth/model.width, st.clientHeight/model.height) * 0.9;
            model.scale.set(sc);
            model.x = (st.clientWidth - model.width*sc) / 2;
            model.y = st.clientHeight - model.height*sc + 50;
        }
        window.onresize = resetModel;

        // æ‹–æ‹½ä¸ç¼©æ”¾
        function onDragStart(e) { if(model){ isDragging=true; dragData=e.data; model.alpha=0.8; } }
        function onDragEnd() { isDragging=false; if(model) model.alpha=1; }
        function onDragMove() { if(isDragging&&model){ const p=dragData.getLocalPosition(model.parent); model.x=p.x-model.width/2; model.y=p.y-model.height/2; } }
        function onWheel(e) { e.preventDefault(); if(model){ model.scale.x *= (e.deltaY<0 ? 1.1 : 0.9); model.scale.y = model.scale.x; } }

        // --- 3. èŠå¤©ä¸å¤šåª’ä½“ ---
        let audioCtx, analyser, dataArray, isTalking=false;
        function initAudio() {
            if(!audioCtx) try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser(); analyser.fftSize=512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            } catch(e) { console.warn("Web Audio API ä¸æ”¯æŒ"); }
        }

        function lipSync() {
            if(!model||!analyser||!isTalking) return;
            analyser.getByteFrequencyData(dataArray);
            let sum=0; for(let i=0; i<dataArray.length; i++) sum+=dataArray[i];
            let val = Math.min(1.0, (sum/dataArray.length)/30);
            if(model.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', val);
        }

        let lastPico = null;
        function addMsg(txt, user, type, emo) {
            const div = document.createElement('div');
            div.className = `message-container ${type}`;
            if(type!=='system') {
                div.innerHTML = `<div class="message-info">${user} ${type==='pico'&&emo?`<span style="opacity:0.6">[${emo}]</span>`:''}</div>`;
            }
            div.innerHTML += `<div class="message-bubble">${txt}</div>`;
            document.getElementById('chat-window').appendChild(div);
            document.getElementById('chat-window').scrollTop = 99999;
            if(type==='pico') lastPico = div;
        }

        socket.on('chat', (d) => addMsg(d.text, d.sender, d.sender===myUser?'self':'other'));
        socket.on('sys', (d) => addMsg(d.text, 'ç³»ç»Ÿ', 'system'));
        socket.on('response', (d) => {
            addMsg(d.text, 'Pico', 'pico', d.emotion);
            // è§¦å‘åŠ¨ä½œ
            if(model?.internalModel?.motionManager) {
                try {
                    let m = model.internalModel.motionManager;
                    let emo = d.emotion || 'NORMAL';
                    switch(emo) {
                        case 'HAPPY': m.startRandomMotion(m.motionGroups.includes('Charm')?'Charm':'TapBody'); break;
                        case 'ANGRY': case 'SHOCK': m.startRandomMotion(m.motionGroups.includes('Shame')?'Shame':'Shake'); break;
                        default: m.startRandomMotion('Idle');
                    }
                    // è§¦å‘è¡¨æƒ… (é€‚é…ä¸åŒæ¨¡å‹å‘½å)
                    const expList = model.internalModel.settings.expressions;
                    if(expList && expList.length > 0) {
                         // ç®€å•ç²—æš´ï¼šæ ¹æ®æƒ…æ„Ÿç´¢å¼•å¤§æ¦‚ä½ç½®çš„è¡¨æƒ…
                         let idx = 0; // é»˜è®¤ F01
                         if(emo==='SAD') idx=1;
                         else if(emo==='ANGRY') idx=3;
                         else if(emo==='HAPPY') idx=4;
                         else if(emo==='SHOCK') idx=5;
                         if(expList[idx]) model.expression(expList[idx].Name);
                    }
                } catch(e){}
            }
        });
        socket.on('audio_response', (d) => {
            if(d.audio && lastPico) {
                let a = new Audio(); a.crossOrigin="anonymous"; a.src=d.audio;
                let ui = document.createElement('audio'); ui.className='audio-player'; ui.controls=true; ui.src=d.audio;
                lastPico.appendChild(ui);
                document.getElementById('chat-window').scrollTop = 99999;
                if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
                if(audioCtx && analyser) {
                    try {
                        let src = audioCtx.createMediaElementSource(a);
                        src.connect(analyser); analyser.connect(audioCtx.destination);
                        a.onplay=()=>{isTalking=true}; a.onpause=a.onended=()=>{isTalking=false};
                    } catch(e){}
                }
                a.play().catch(()=>{});
            }
        });

        // --- å·¥ä½œå®¤ & å·¥å…· ---
        document.getElementById('studio-btn').onclick = () => {
            document.getElementById('studio-overlay').style.display = 'flex';
            socket.emit('get_studio_data');
        };
        socket.on('studio_data', (d) => {
            const list = document.getElementById('model-list'); list.innerHTML=""; currentModelId=d.current_id;
            d.models.forEach(m => {
                let el = document.createElement('div');
                el.className = `model-card ${m.id===d.current_id?'active':''}`;
                el.innerHTML = `<div>${m.name}</div>${m.id!==d.current_id?`<span class="btn-del" onclick="delModel('${m.id}',event)">ğŸ—‘ï¸</span>`:''}`;
                el.onclick = () => socket.emit('switch_model', {id: m.id});
                list.appendChild(el);
                if(m.id===d.current_id) document.getElementById('persona-text').value = m.persona;
            });
        });
        socket.on('model_switched', (m) => {
            loadModel(m.path);
            document.getElementById('room-title').textContent=`ğŸ¤– ${m.name} (${myUser})`;
            if(document.getElementById('studio-overlay').style.display==='flex') socket.emit('get_studio_data');
            showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);
        });
        socket.on('toast', (d) => showToast(d.text, d.type));

        window.delModel = (id,e) => { e.stopPropagation(); if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) socket.emit('delete_model', {id}); };
        window.dlModel = (name) => socket.emit('download_model', {name});
        document.getElementById('save-persona-btn').onclick = () => socket.emit('save_persona', {id:currentModelId, text:document.getElementById('persona-text').value});

        // å‘é€
        const send = () => { let i=document.getElementById('user-input'); if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
        document.getElementById('send-btn').onclick = send;
        document.getElementById('user-input').onkeypress = (e) => {if(e.key==='Enter')send();};

        function showToast(msg, type='success') {
            let t = document.createElement('div'); t.className='toast'; t.textContent=msg;
            if(type==='error') t.style.background='rgba(231,76,60,0.9)';
            document.getElementById('toast-container').appendChild(t);
            setTimeout(()=>t.remove(), 3500);
        }
        function shake(el) { el.style.animation='shake 0.5s'; setTimeout(()=>el.style.animation='',500); }
        // å®šä¹‰ shake åŠ¨ç”»
        const style = document.createElement('style');
        style.innerHTML = `@keyframes shake {0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}`;
        document.head.appendChild(style);

<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- (Head å†…å®¹ä¿æŒä¸å˜ï¼Œå¤ç”¨ä¹‹å‰çš„æ ·å¼) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <!-- æ ·å¼åŒºçœç•¥ï¼Œè¯·ç›´æ¥ä½¿ç”¨ä¸Šä¸€ç‰ˆçš„ CSS -->
    <style>
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden;color:#333}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden;touch-action:none}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:10;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4;min-height:35vh}#chat-container{width:100%;flex:6;min-height:0}}
        #header{background:#6c5ce7;color:white;padding:12px 15px;text-align:center;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .icon-btn{cursor:pointer;padding:6px 10px;background:rgba(0,0,0,0.15);border-radius:6px;user-select:none}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa;overscroll-behavior:contain}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:85%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:white;color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:#fff0f6;color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .emotion-tag{display:inline-block;font-size:0.8em;padding:1px 4px;border-radius:4px;background:rgba(232,67,147,0.1);color:#e84393;margin-left:5px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:#eee;color:#666;font-size:12px;padding:4px 12px;border-radius:12px;box-shadow:none}
        .audio-player{margin-top:8px;height:32px;width:100%;opacity:0.8;border-radius:16px;display:block}
        #input-area{display:flex;padding:10px;background:white;border-top:1px solid #eee;flex-shrink:0}
        #user-input{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;font-size:16px;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:25px;font-weight:bold}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal-box{background:white;padding:25px;border-radius:20px;width:90%;max-width:450px;max-height:80vh;overflow-y:auto}
        #login-overlay{z-index:10000} #studio-overlay{display:none;z-index:9000}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold;transition:all 0.3s}
        #login-btn:disabled{background:#b2bec3;cursor:not-allowed;opacity:0.7}
        .admin-only{display:none}
        .slider-container{margin:10px 0}
        .slider-label{font-size:12px;color:#666;display:flex;justify-content:space-between}
        input[type="range"]{width:100%;margin-top:5px}
        .upload-box{border:2px dashed #ccc;padding:15px;text-align:center;border-radius:10px;margin-top:10px;cursor:pointer}
        .model-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .model-card{background:#f8f9fa;padding:10px;border-radius:8px;text-align:center;cursor:pointer;border:2px solid transparent}
        .model-card.active{border-color:#6c5ce7;background:#e0dfff;font-weight:bold}
        .chip{display:inline-block;background:#eee;padding:6px 12px;border-radius:15px;margin:5px;cursor:pointer}
        .btn-del{color:red;font-size:12px;display:block;margin-top:5px}
        #toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:11000;text-align:center;width:100%}
        .toast{display:inline-block;background:rgba(0,0,0,0.8);color:white;padding:8px 20px;border-radius:20px;margin-top:10px;animation:fadeOut 3s forwards 2s}
        @keyframes fadeOut{to{opacity:0;visibility:hidden}}
        #debug-pos { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.5); padding: 5px; font-size: 10px; pointer-events: none; z-index: 100; }
    </style>
</head>
<body>
    <!-- ... (HTML ç»“æ„ä¿æŒä¸å˜ï¼Œç›´æ¥å¤ç”¨å³å¯) ... -->
    <div id="toast-container"></div>
    <div id="login-overlay" class="overlay"><div class="modal-box" style="text-align:center"><h2>Pico ç›´æ’­é—´</h2><input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off"><br><button id="login-btn" disabled>è¿æ¥ä¸­...</button></div></div>
    <div id="studio-overlay" class="overlay"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center"><h3>ğŸ› ï¸ å·¥ä½œå®¤</h3><div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div></div><div id="model-list" class="model-list">åŠ è½½ä¸­...</div><div class="admin-only"><hr><h4>âš™ï¸ è°ƒéŸ³ & ä½ç½®</h4><label style="font-size:12px;color:#666">äººè®¾æç¤ºè¯:</label><textarea id="persona-text" style="width:100%;height:60px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:5px"></textarea><label style="font-size:12px;color:#666">å£°çº¿é€‰æ‹©:</label><select id="voice-select" style="width:100%;padding:8px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd"><option value="zh-CN-XiaoxiaoNeural">ğŸ‡¨ğŸ‡³ æ™“æ™“ (é»˜è®¤)</option></select><div class="slider-container"><div class="slider-label"><span>è¯­é€Ÿ</span><span id="rate-val">0%</span></div><input type="range" id="rate-range" min="-50" max="50" oninput="updateVal('rate', this.value)"></div><div class="slider-container"><div class="slider-label"><span>éŸ³è°ƒ</span><span id="pitch-val">0Hz</span></div><input type="range" id="pitch-range" min="-50" max="50" oninput="updateVal('pitch', this.value)"></div><div class="slider-container"><div class="slider-label"><span>ä½ç½® X</span><span id="x-val">0.5</span></div><input type="range" id="model-x" min="0" max="1" step="0.01" oninput="previewTransform()"></div><div class="slider-container"><div class="slider-label"><span>ä½ç½® Y</span><span id="y-val">0.5</span></div><input type="range" id="model-y" min="0" max="2" step="0.01" oninput="previewTransform()"></div><div class="slider-container"><div class="slider-label"><span>ç¼©æ”¾</span><span id="scale-val">0.5</span></div><input type="range" id="model-scale" min="0.1" max="2.0" step="0.05" oninput="previewTransform()"></div><button id="save-settings-btn" style="width:100%;padding:10px;margin-top:10px;background:#6c5ce7;color:white;border:none;border-radius:10px">ä¿å­˜æ‰€æœ‰é…ç½®</button><hr><h4>â˜ï¸ ä¸Šä¼ /ä¸‹è½½</h4><div class="upload-box" onclick="document.getElementById('file-input').click()">ç‚¹å‡»ä¸Šä¼  .zip<input type="file" id="file-input" accept=".zip" style="display:none" onchange="uploadFile(this.files[0])"></div><div style="margin-top:10px"><span class="chip" onclick="dlModel('Mao')">Mao</span><span class="chip" onclick="dlModel('Natori')">Natori</span></div></div><hr><h4>ğŸ§¹ ç¼“å­˜</h4><div><span class="chip" onclick="clearLocalMemories()">æ¸…é™¤è®°å¿†</span></div></div></div>
    <div id="stage-container"><canvas id="live2d-canvas"></canvas><div id="debug-pos"></div></div>
    <div id="chat-container"><div id="header"><span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span><div style="display:flex;gap:10px"><div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div><div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div></div></div><div id="chat-window"></div><div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div></div>

    <script>
        const socket = io({reconnection:true});
        let app_pixi, model, myUser="", currentModelId="", currentCfg={scale:0.5,x:0.5,y:0.5}, audioCtx, analyser, dataArray, isTalking=false;
        let iAmAdmin=false;

        // --- å†å²åŒæ­¥é€»è¾‘ (æ ¸å¿ƒ) ---
        socket.on('history_sync', (history) => {
            const win = document.getElementById('chat-window');
            win.innerHTML = ""; // æ¸…ç©ºå½“å‰æ˜¾ç¤º
            
            history.forEach(item => {
                let type = 'other';
                if (item.sender === myUser) type = 'self';
                if (item.role === 'pico') type = 'pico';
                if (item.role === 'system') type = 'system';
                
                addMsg(item.text, item.sender, type, item.emotion);
            });
            win.scrollTop = 99999;
        });

        // ... (å…¶ä»–é€»è¾‘ï¼šupdateVal, previewTransform, applyToModel, applyConfig, loadModel, initInteraction, lipSync, triggerMotion ç­‰ä¿æŒä¸å˜) ...
        // è¯·åŠ¡å¿…å¤ç”¨ Turn 88 ä¸­çš„ JS ä»£ç ï¼Œåªæ›¿æ¢ socket.on('history_sync') éƒ¨åˆ†
        // ä¸ºäº†ç¯‡å¹…ï¼Œè¿™é‡Œç®€å†™äº†ï¼Œä½†ä½ éœ€è¦å®Œæ•´çš„
        
        // --- JS è¡¥å…¨ ---
        function updateVal(t,v){document.getElementById(`${t}-val`).textContent=(v>0?'+':'')+v+(t==='rate'?'%':'Hz');}
        function updateValLabels(s,x,y){document.getElementById('scale-val').textContent=s.toFixed(2);document.getElementById('x-val').textContent=x.toFixed(2);document.getElementById('y-val').textContent=y.toFixed(2);}
        function previewTransform(){if(!model)return;const s=parseFloat(document.getElementById('model-scale').value),x=parseFloat(document.getElementById('model-x').value),y=parseFloat(document.getElementById('model-y').value);updateValLabels(s,x,y);applyToModel(s,x,y);}
        function applyToModel(s,x,y){if(!model)return;const st=document.getElementById('stage-container'),absScale=(st.clientHeight/model.height)*s;model.scale.set(absScale);model.x=(st.clientWidth*x)-(model.width/2);model.y=(st.clientHeight*y)-(model.height/2);document.getElementById('debug-pos').textContent=`S:${s.toFixed(2)} X:${x.toFixed(2)} Y:${y.toFixed(2)}`;}
        function applyConfig(c){if(!model)return;const t=c||currentCfg||{scale:0.5,x:0.5,y:0.5},s=t.scale??0.5,x=t.x??0.5,y=t.y??0.5;if(document.getElementById('model-scale')){document.getElementById('model-scale').value=s;document.getElementById('model-x').value=x;document.getElementById('model-y').value=y;updateValLabels(s,x,y);}applyToModel(s,x,y);}
        document.getElementById('reset-btn').onclick=()=>{applyConfig(currentCfg);showToast("ğŸ¯ å·²æ¢å¤","info");};window.addEventListener('resize',()=>setTimeout(()=>applyConfig(currentCfg),100));
        
        const loginBtn=document.getElementById('login-btn');
        socket.on('connect',()=>loginBtn.disabled=false);
        socket.on('disconnect',()=>loginBtn.disabled=true);
        loginBtn.onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;loginBtn.disabled=true;socket.emit('login',{username:n});initAudio();}};
        socket.on('login_success',(d)=>{document.getElementById('login-overlay').style.display='none';document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`;currentCfg=d.current_model;if(d.current_model.path)loadModel(d.current_model.path,d.current_model);});

        async function loadModel(p,c){if(!app_pixi){app_pixi=new PIXI.Application({view:document.getElementById('live2d-canvas'),autoStart:true,resizeTo:document.getElementById('stage-container'),transparent:true});initInteraction();}try{if(model){app_pixi.stage.removeChild(model);model.destroy();model=null;}app_pixi.stage.removeChildren();model=await PIXI.live2d.Live2DModel.from(p);app_pixi.stage.addChild(model);setTimeout(()=>applyConfig(c||currentCfg),100);app_pixi.ticker.remove(lipSync);app_pixi.ticker.add(lipSync);if(model.internalModel.motionManager)model.internalModel.motionManager.startRandomMotion('Idle');}catch(e){console.error(e);}}
        function initInteraction(){const s=document.getElementById('stage-container');app_pixi.stage.interactive=true;app_pixi.stage.on('pointerdown',(e)=>{if(model){isDragging=true;dragData=e.data;model.alpha=0.8;}}).on('pointerup',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointerupoutside',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointermove',()=>{if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;}});}
        function lipSync(){if(!model||!analyser||!isTalking)return;analyser.getByteFrequencyData(dataArray);let sum=0;for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];if(model.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',Math.min(1.0,(sum/dataArray.length)/30));}
        function triggerMotion(e){if(!model?.internalModel?.motionManager)return;try{let m=model.internalModel.motionManager;switch(e){case 'HAPPY':m.startRandomMotion('TapBody');break;default:m.startRandomMotion('Idle');}}catch(e){}}

        document.getElementById('studio-btn').onclick=()=>{document.getElementById('studio-overlay').style.display='flex';socket.emit('get_studio_data');};
        socket.on('studio_data',(d)=>{const l=document.getElementById('model-list');l.innerHTML="";currentModelId=d.current_id;d.models.forEach(m=>{let e=document.createElement('div');e.className=`model-card ${m.id===d.current_id?'active':''}`;e.innerHTML=`<div>${m.name}</div>`;if(iAmAdmin&&m.id!==d.current_id)e.innerHTML+=`<div class="btn-del" onclick="delModel('${m.id}',event)">ğŸ—‘ï¸</div>`;e.onclick=()=>socket.emit('switch_model',{id:m.id});l.appendChild(e);if(m.id===d.current_id){document.getElementById('persona-model-name').textContent=m.name;document.getElementById('persona-text').value=m.persona;const s=document.getElementById('voice-select');if(d.voices)d.voices.forEach(v=>{if(!Array.from(s.options).some(o=>o.value===v.id)){let o=document.createElement('option');o.value=v.id;o.textContent=v.name;s.appendChild(o);}});if(m.voice)s.value=m.voice;let r=parseInt(m.rate)||0,p=parseInt(m.pitch)||0;document.getElementById('rate-range').value=r;updateVal('rate',r);document.getElementById('pitch-range').value=p;updateVal('pitch',p);let sc=m.scale??0.5,x=m.x??0.5,y=m.y??0.5;updateValLabels(sc,x,y);}});});
        socket.on('model_switched',(m)=>{currentCfg=m;loadModel(m.path,m);document.getElementById('room-title').textContent=`ğŸ¤– ${m.name}`;if(document.getElementById('studio-overlay').style.display==='flex')socket.emit('get_studio_data');});
        document.getElementById('save-settings-btn').onclick=()=>{let r=document.getElementById('rate-range').value,p=document.getElementById('pitch-range').value;socket.emit('save_settings',{id:currentModelId,persona:document.getElementById('persona-text').value,voice:document.getElementById('voice-select').value,rate:(r>=0?'+':'')+r+'%',pitch:(p>=0?'+':'')+p+'Hz',scale:document.getElementById('model-scale').value,x:document.getElementById('model-x').value,y:document.getElementById('model-y').value});};
        window.delModel=(id,e)=>{e.stopPropagation();if(confirm('åˆ é™¤?'))socket.emit('delete_model',{id});};window.dlModel=(n)=>socket.emit('download_model',{name:n});window.uploadFile=(f)=>{let fd=new FormData();fd.append('file',f);fetch('/upload_model',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){showToast("âœ… æˆåŠŸ");socket.emit('get_studio_data');}else showToast("âŒ "+d.msg,"error")});};
        socket.on('admin_unlocked',()=>{iAmAdmin=true;document.querySelectorAll('.admin-only').forEach(e=>e.style.display='block');});
        
        const M_KEY='pico_mem';
        window.clearLocalMemories=()=>{localStorage.removeItem(M_KEY);showToast('ğŸ§  è®°å¿†å·²æ¸…é™¤');};
        function getLocalMemories(){return JSON.parse(localStorage.getItem(M_KEY))||[];}
        function saveLocalMemory(f){let m=getLocalMemories();if(f&&!m.includes(f)){m.push(f);if(m.length>50)m=m.slice(-50);localStorage.setItem(M_KEY,JSON.stringify(m));return true;}return false;}
        
        socket.on('chat_message',(d)=>{addMsg(d.text,d.sender,d.sender===myUser?'self':'other');});
        socket.on('system_message',(d)=>{addMsg(d.text,'ç³»ç»Ÿ','system');});
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        let lastPico=null;
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);if(audioCtx){if(audioCtx.state==='suspended')audioCtx.resume();try{let s=audioCtx.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioCtx.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        socket.on('toast',(d)=>showToast(d.text,d.type));
        
        function initAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${e?`<span class="emotion-tag">${e}</span>`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        function showToast(m,t='success'){let d=document.createElement('div');d.className='toast';d.textContent=m;if(t==='error')d.style.background='#d63031';document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3500);}
        const send=()=>{let i=document.getElementById('user-input'),t=i.value.trim();if(!t)return;if(t.startsWith('/')){if(t.startsWith('/è®° ')){if(saveLocalMemory(t.substring(3).trim()))showToast('ğŸ§  å·²è®°');}else if(t==='/æ¸…é™¤è®°å¿†')clearLocalMemories();else if(t.toLowerCase()==='/ç®¡ç†å‘˜'){socket.emit('message',{text:t});}else{showToast('æœªçŸ¥æŒ‡ä»¤','error');}}else{socket.emit('message',{text:t,memories:getLocalMemories()});}i.value='';};
        document.getElementById('send-btn').onclick=send; document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')send();};
    </script>
</body>
</html>

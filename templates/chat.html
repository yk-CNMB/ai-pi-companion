<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Studio</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <style>
        /* --- Ê†∑Âºè (Á≤æÁÆÄÁâàÔºåÂäüËÉΩ‰∏çÂèò) --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden;color:#333}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden;cursor:move}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:2;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4}#chat-container{width:100%;flex:6}}
        #header{background:#6c5ce7;color:white;padding:15px;text-align:center;font-weight:bold;position:relative;display:flex;justify-content:space-between;align-items:center}
        #studio-btn{cursor:pointer;padding:5px 10px;background:rgba(0,0,0,0.1);border-radius:5px}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:85%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:white;color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:#fff0f6;color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:#eee;color:#666;font-size:12px;padding:4px 12px;border-radius:12px;box-shadow:none}
        #input-area{display:flex;padding:10px;background:white;border-top:1px solid #eee}
        #user-input{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;font-size:16px;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:25px;font-weight:bold}
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        #login-box{background:white;padding:30px;border-radius:20px;text-align:center;width:85%;max-width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold;transition:all 0.3s}
        #login-btn:disabled{background:#b2bec3;cursor:not-allowed;opacity:0.7}
        #studio-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:8888;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal-box{background:white;padding:20px;border-radius:20px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
        .model-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:10px}
        .model-card{background:#f0f0f0;padding:10px;border-radius:8px;text-align:center;cursor:pointer;border:2px solid transparent}
        .model-card.active{border-color:#6c5ce7;background:#e0dfff}
        .btn-del{color:red;font-size:12px;display:block;margin-top:5px}
        #toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:10000}
        .toast{background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:25px;margin-bottom:10px;font-size:14px;animation:fadeOut 3s forwards}
        @keyframes fadeOut{0%{opacity:1}80%{opacity:1}100%{opacity:0}}
        .audio-player{margin-top:8px;height:32px;width:100%;opacity:0.8;border-radius:16px}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-overlay"><div id="login-box"><h2>Pico Áõ¥Êí≠Èó¥</h2><input id="username-input" placeholder="ËØ∑ËæìÂÖ•ÊòµÁß∞" maxlength="10" autocomplete="off"><br><button id="login-btn" disabled>ËøûÊé•‰∏≠...</button></div></div>
    <div id="studio-overlay"><div class="modal-box"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><h3>üõ†Ô∏è Â∑•‰ΩúÂÆ§</h3><button onclick="document.getElementById('studio-overlay').style.display='none'" style="border:none;background:none;font-size:24px;">√ó</button></div><div id="model-list" class="model-list">Âä†ËΩΩ‰∏≠...</div><hr><h3>üß† ‰∫∫ËÆæÁºñËæë</h3><textarea id="persona-text" style="width:100%;height:100px;margin-bottom:10px;"></textarea><button id="save-persona-btn" style="width:100%;padding:10px;background:#6c5ce7;color:white;border:none;border-radius:10px;">‰øùÂ≠ò‰∫∫ËÆæ</button><hr><h3>‚òÅÔ∏è ‰∏ãËΩΩÊõ¥Â§ö</h3><div style="display:flex;gap:10px;flex-wrap:wrap;"><button onclick="dlModel('Mao')">Mao</button><button onclick="dlModel('Natori')">Natori</button><button onclick="dlModel('Rice')">Rice</button><button onclick="dlModel('Wanko')">Wanko</button></div></div></div>
    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container"><div id="header"><span id="room-title">ü§ñ ‰∫íÂä®Âå∫</span><div id="studio-btn">üõ†Ô∏è ËÆæÁΩÆ</div></div><div id="chat-window"></div><div id="input-area"><input id="user-input" placeholder="ÂèëÈÄÅÂºπÂπï..."><button id="send-btn">ÂèëÈÄÅ</button></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        const socket = io({reconnection: true});
        let app_pixi, model, myUser="", currentModelId="", audioContext, analyser, dataArray, isTalking=false, isDragging=false, dragData;

        // --- ËøûÊé•Áä∂ÊÄÅÁõëÊéß (Ê†∏ÂøÉ‰øÆÂ§ç) ---
        const loginBtn = document.getElementById('login-btn');
        socket.on('connect', () => { 
            // ËøûÊé•ÊàêÂäüÔºå‰ΩÜÊåâÈíÆ‰ªçÁÑ∂Á¶ÅÁî®ÔºåÁ≠âÂæÖ server_ready ‰ø°Âè∑
            console.log("Socket connected, waiting for server ready...");
        });
        socket.on('server_ready', (d) => {
            console.log("Server is ready!", d);
            loginBtn.textContent = "ËøõÂÖ•Áõ¥Êí≠Èó¥";
            loginBtn.disabled = false;
        });
        socket.on('disconnect', () => { loginBtn.textContent="Â∑≤Êñ≠ÂºÄ..."; loginBtn.disabled=true; });

        // --- ÁôªÂΩï ---
        loginBtn.onclick = () => {
            let n = document.getElementById('username-input').value.trim();
            if(n) {
                myUser = n;
                loginBtn.disabled = true; loginBtn.textContent = "ÁôªÂΩï‰∏≠...";
                socket.emit('login', {username: n});
                if(!audioContext) try{audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}
            }
        };
        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('room-title').textContent=`ü§ñ ${d.current_model.name} (${myUser})`;
            if(d.current_model.path) loadModel(d.current_model.path);
        });
        socket.on('login_failed', (d) => { alert(d.error); loginBtn.disabled=false; loginBtn.textContent="ÈáçËØï"; });

        // --- Live2D ---
        async function loadModel(path) {
            if(!app_pixi) {
                app_pixi = new PIXI.Application({ view:document.getElementById('live2d-canvas'), autoStart:true, resizeTo:document.getElementById('stage-container'), transparent:true });
                app_pixi.stage.interactive=true; app_pixi.stage.on('pointerdown',onDragStart).on('pointerup',onDragEnd).on('pointerupoutside',onDragEnd).on('pointermove',onDragMove);
                document.getElementById('stage-container').addEventListener('wheel',onWheel,{passive:false});
            }
            try {
                if(model) app_pixi.stage.removeChild(model);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resetModel();
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) { console.error(e); showToast("‚ùå Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•","error"); }
        }
        function resetModel() { if(model&&app_pixi){ const st=document.getElementById('stage-container'); const sc=Math.min(st.clientWidth/model.width, st.clientHeight/model.height)*1.2; model.scale.set(sc); model.x=(st.clientWidth-model.width*sc)/2; model.y=st.clientHeight-model.height*sc+100; } }
        window.onresize = resetModel;
        function onDragStart(e){ if(model){isDragging=true;dragData=e.data;model.alpha=0.8;} }
        function onDragEnd(){ isDragging=false;if(model)model.alpha=1; }
        function onDragMove(){ if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;} }
        function onWheel(e){ e.preventDefault();if(model){model.scale.x*=(e.deltaY<0?1.1:0.9);model.scale.y=model.scale.x;} }

        function lipSync() { if(!model||!analyser||!isTalking)return; analyser.getByteFrequencyData(dataArray); let sum=0; for(let i=0;i<dataArray.length;i++)sum+=dataArray[i]; if(model.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0,(sum/dataArray.length)/30)); }
        function triggerMotion(emo) { if(!model?.internalModel?.motionManager)return; try{ let m=model.internalModel.motionManager; switch(emo){ case 'HAPPY':m.startRandomMotion(m.motionGroups.includes('Charm')?'Charm':'TapBody');break; case 'ANGRY':case 'SHOCK':m.startRandomMotion(m.motionGroups.includes('Shame')?'Shame':'Shake');break; default:m.startRandomMotion('Idle'); } if(model.internalModel.settings.expressions){ let idx=0;if(emo==='SAD')idx=1;else if(emo==='ANGRY')idx=3;else if(emo==='HAPPY')idx=4;else if(emo==='SHOCK')idx=5; if(model.internalModel.settings.expressions[idx]) model.expression(model.internalModel.settings.expressions[idx].Name); } }catch(e){} }

        // --- Â∑•‰ΩúÂÆ§ ---
        document.getElementById('studio-btn').onclick=()=>{ document.getElementById('studio-overlay').style.display='flex'; socket.emit('get_studio_data'); };
        socket.on('studio_data',(d)=>{ const list=document.getElementById('model-list'); list.innerHTML=""; currentModelId=d.current_id; d.models.forEach(m=>{ let el=document.createElement('div'); el.className=`model-card ${m.id===d.current_id?'active':''}`; el.innerHTML=`<div>${m.name}</div>${m.id!==d.current_id?`<span class="btn-del" onclick="delModel('${m.id}',event)">üóëÔ∏è</span>`:''}`; el.onclick=()=>socket.emit('switch_model',{id:m.id}); list.appendChild(el); if(m.id===d.current_id)document.getElementById('persona-text').value=m.persona; }); });
        socket.on('model_switched',(m)=>{ loadModel(m.path); document.getElementById('room-title').textContent=`ü§ñ ${m.name} (${myUser})`; if(document.getElementById('studio-overlay').style.display==='flex')socket.emit('get_studio_data'); showToast(`‚ú® Â∑≤ÂàáÊç¢‰∏∫ ${m.name}`); });
        window.delModel=(id,e)=>{e.stopPropagation();if(confirm('Á°ÆÂÆöÂà†Èô§Ôºü'))socket.emit('delete_model',{id});};
        window.dlModel=(n)=>socket.emit('download_model',{name:n});
        document.getElementById('save-persona-btn').onclick=()=>socket.emit('save_persona',{id:currentModelId,text:document.getElementById('persona-text').value});

        // --- Ê∂àÊÅØ ---
        socket.on('chat',(d)=>addMsg(d.text,d.sender,d.sender===myUser?'self':'other'));
        socket.on('sys',(d)=>addMsg(d.text,'Á≥ªÁªü','system'));
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);document.getElementById('chat-window').scrollTop=99999;if(audioContext){if(audioContext.state==='suspended')audioContext.resume();try{let s=audioContext.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioContext.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        socket.on('toast',(d)=>showToast(d.text,d.type));
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${e?`[${e}]`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        function showToast(msg,type='success'){let t=document.createElement('div');t.className='toast';t.textContent=msg;if(type==='error'||type==='info')t.style.backgroundColor=type==='error'?'#d63031':'#0984e3';document.getElementById('toast-container').appendChild(t);setTimeout(()=>t.remove(),3500);}
        document.getElementById('send-btn').onclick=()=>{let i=document.getElementById('user-input');if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
        document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')document.getElementById('send-btn').click();};
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Studio</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* --- å¸ƒå±€ä¸æ ·å¼ (ä¿æŒä¸å˜) --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden;color:#333}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden;cursor:move;touch-action:none}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:10;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4;min-height:35vh}#chat-container{width:100%;flex:6;min-height:0}}
        #header{background:#6c5ce7;color:white;padding:12px 15px;text-align:center;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .icon-btn{cursor:pointer;padding:6px 10px;background:rgba(0,0,0,0.15);border-radius:6px;user-select:none} .icon-btn:hover{background:rgba(0,0,0,0.25)}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa;overscroll-behavior:contain}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:85%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:white;color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:#fff0f6;color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .emotion-tag{display:inline-block;font-size:0.8em;padding:1px 4px;border-radius:4px;background:rgba(232,67,147,0.1);color:#e84393;margin-left:5px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:#eee;color:#666;font-size:12px;padding:4px 12px;border-radius:12px;box-shadow:none}
        .audio-player{margin-top:8px;height:32px;width:100%;opacity:0.8;border-radius:16px}
        #input-area{display:flex;padding:10px;background:white;border-top:1px solid #eee;flex-shrink:0}
        #user-input{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;font-size:16px;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:25px;font-weight:bold}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal-box{background:white;padding:20px;border-radius:20px;width:90%;max-width:450px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
        #login-overlay{z-index:10000} #studio-overlay{display:none;z-index:9000}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold;transition:all 0.2s}
        #login-btn:disabled{background:#b2bec3;cursor:not-allowed;opacity:0.7}
        .model-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:10px}
        .model-card{background:#f8f9fa;padding:10px;border-radius:8px;text-align:center;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
        .model-card:hover{border-color:#a29bfe;transform:translateY(-2px)}
        .model-card.active{border-color:#6c5ce7;background:#e0dfff;font-weight:bold}
        .chip{display:inline-block;background:#eee;padding:6px 12px;border-radius:15px;margin:5px;font-size:14px;cursor:pointer} .chip:hover{background:#dfe6e9}
        #toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:11000;width:auto;text-align:center}
        .toast{display:inline-block;background:rgba(0,0,0,0.8);color:white;padding:8px 20px;border-radius:25px;margin-top:10px;font-size:14px;animation:fadeOut 4s forwards 2s}
        @keyframes fadeOut{to{opacity:0;visibility:hidden}}
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-overlay" class="overlay"><div class="modal-box" style="text-align:center"><h2>Pico ç›´æ’­é—´</h2><input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off"><br><button id="login-btn" disabled>è¿æ¥ä¸­...</button></div></div>
    <div id="studio-overlay" class="overlay"><div class="modal-box"><div style="display:flex;justify-content:space-between;align-items:center"><h3>ğŸ› ï¸ å·¥ä½œå®¤</h3><div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div></div><div id="model-list" class="model-list">åŠ è½½ä¸­...</div><hr><h4>ğŸ§  äººè®¾</h4><textarea id="persona-text" style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px"></textarea><button id="save-persona-btn" class="chip" style="background:#6c5ce7;color:white;border:none;width:100%">ä¿å­˜äººè®¾</button><hr><h4>â˜ï¸ ä¸‹è½½</h4><div><span class="chip" onclick="dlModel('Mao')">Mao</span><span class="chip" onclick="dlModel('Natori')">Natori</span><span class="chip" onclick="dlModel('Rice')">Rice</span><span class="chip" onclick="dlModel('Wanko')">Wanko</span></div><hr><h4>ğŸ è°ƒè¯•</h4><button class="chip" onclick="debugMotions()">æ‰“å°å¯ç”¨åŠ¨ä½œ (çœ‹æ§åˆ¶å°)</button></div></div>

    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container"><div id="header"><span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span><div style="display:flex;gap:10px"><div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div><div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div></div></div><div id="chat-window"></div><div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off"><button id="send-btn">å‘é€</button></div></div>

    <script>
        const socket = io({reconnection:true});
        let app_pixi, model, myUser="", currentModelId="", audioCtx, analyser, dataArray, isTalking=false, isDragging=false, dragData, initialScale, initialDist;

        // --- 1. è¿æ¥ä¸ç™»å½• ---
        const loginBtn = document.getElementById('login-btn');
        socket.on('connect',()=>{}); socket.on('server_ready',()=>{loginBtn.textContent="è¿›å…¥ç›´æ’­é—´";loginBtn.disabled=false;}); socket.on('disconnect',()=>{loginBtn.textContent="å·²æ–­å¼€...";loginBtn.disabled=true;});
        loginBtn.onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;loginBtn.disabled=true;loginBtn.textContent="ç™»å½•ä¸­...";socket.emit('login',{username:n});initAudio();}};
        socket.on('login_success',(d)=>{document.getElementById('login-overlay').style.display='none';document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`;if(d.current_model.path)loadModel(d.current_model.path);});
        socket.on('login_failed',(d)=>{alert(d.error);loginBtn.disabled=false;loginBtn.textContent="é‡è¯•";});

        // --- 2. Live2D å¼•æ“ (å«äº¤äº’) ---
        async function loadModel(path) {
            if(!app_pixi) {
                app_pixi = new PIXI.Application({ view:document.getElementById('live2d-canvas'), autoStart:true, resizeTo:document.getElementById('stage-container'), transparent:true });
                initInteraction();
            }
            try {
                if(model) app_pixi.stage.removeChild(model);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resetModel();
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) { console.error(e); showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥","error"); }
        }
        function resetModel() { if(model&&app_pixi){const st=document.getElementById('stage-container');const isPortrait=st.clientHeight>st.clientWidth;const scale=Math.min(st.clientWidth/model.width,st.clientHeight/model.height)*(isPortrait?0.85:0.95);model.scale.set(scale);model.x=(st.clientWidth-model.width*scale)/2;model.y=st.clientHeight-model.height*scale;if(isPortrait)model.y-=30;} }
        document.getElementById('reset-btn').onclick=resetModel; window.addEventListener('resize',()=>setTimeout(resetModel,100));
        function initInteraction() {
            const s=document.getElementById('stage-container');
            app_pixi.stage.interactive=true;
            app_pixi.stage.on('pointerdown',(e)=>{if(model&&(!e.data.originalEvent.touches||e.data.originalEvent.touches.length===1)){isDragging=true;dragData=e.data;model.alpha=0.8;}});
            app_pixi.stage.on('pointerup',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointerupoutside',()=>{isDragging=false;if(model)model.alpha=1;});
            app_pixi.stage.on('pointermove',()=>{if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;}});
            s.addEventListener('wheel',(e)=>{e.preventDefault();if(model){model.scale.x*=(e.deltaY<0?1.1:0.9);model.scale.y=model.scale.x;}},{passive:false});
            s.addEventListener('touchstart',(e)=>{if(e.touches.length===2&&model){isDragging=false;initialDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);initialScale=model.scale.x;}});
            s.addEventListener('touchmove',(e)=>{if(e.touches.length===2&&model&&initialDist){e.preventDefault();model.scale.set(initialScale*(Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)/initialDist));}});
        }

        // --- 3. æ™ºèƒ½æƒ…æ„Ÿå¼•æ“ (æ ¸å¿ƒå‡çº§) ---
        function lipSync(){if(!model||!analyser||!isTalking)return;analyser.getByteFrequencyData(dataArray);let sum=0;for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];if(model.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',Math.min(1.0,(sum/dataArray.length)/30));}

        // æ™ºèƒ½æŸ¥æ‰¾æœ€ä½³åŠ¨ä½œ
        function playBestMatch(keywords, defaultGroup='Idle') {
            const mgr = model.internalModel.motionManager;
            const groups = mgr.motionGroups || [];
            // 1. å°è¯•ç²¾ç¡®åŒ¹é…æˆ–æ¨¡ç³ŠåŒ¹é…
            for (let kw of keywords) {
                let match = groups.find(g => g.toLowerCase().includes(kw.toLowerCase()));
                if (match) {
                    console.log(`âœ… åŒ¹é…åˆ°åŠ¨ä½œ [${kw}] -> ${match}`);
                    mgr.startRandomMotion(match);
                    return;
                }
            }
            // 2. æ²¡æ‰¾åˆ°ï¼Œå°è¯•æ’­æ”¾é€šç”¨åŠ¨ä½œ
            if (groups.includes('TapBody')) mgr.startRandomMotion('TapBody');
            else if (groups.includes(defaultGroup)) mgr.startRandomMotion(defaultGroup);
            else console.warn(`âŒ æœªæ‰¾åˆ°åˆé€‚çš„åŠ¨ä½œ: ${keywords}`);
        }

        function triggerMotion(emo) {
            if(!model?.internalModel?.motionManager) return;
            console.log("ğŸ­ æ”¶åˆ°æƒ…æ„Ÿ:", emo);
            try {
                // A. ä¼˜å…ˆè®¾ç½®é¢éƒ¨è¡¨æƒ… (Expression)
                // å¾ˆå¤šæ¨¡å‹çš„è¡¨æƒ…å‘½åæ˜¯ F01, f01, exp_01 ç­‰ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                if (model.internalModel.settings.expressions) {
                    let expTarget = "";
                    switch(emo) {
                        case 'HAPPY': expTarget = "f05"; break; // å¤§ç¬‘
                        case 'ANGRY': expTarget = "f04"; break; // ç”Ÿæ°”
                        case 'SHOCK': expTarget = "f06"; break; // æƒŠè®¶
                        case 'SAD':   expTarget = "f02"; break; // æ‚²ä¼¤
                        case 'NORMAL':default: expTarget = "f01"; break; // å¹³é™
                    }
                    // åœ¨æ‰€æœ‰å¯ç”¨è¡¨æƒ…ä¸­æŸ¥æ‰¾æœ€æ¥è¿‘çš„
                    let bestExp = model.internalModel.settings.expressions.find(e => e.Name.toLowerCase().includes(expTarget.toLowerCase()));
                    if (bestExp) {
                        console.log(`ğŸ˜Š åˆ‡æ¢è¡¨æƒ…: ${bestExp.Name}`);
                        model.expression(bestExp.Name);
                    }
                }

                // B. è§¦å‘èº«ä½“åŠ¨ä½œ (Motion) - ä½¿ç”¨æ™ºèƒ½åŒ¹é…
                switch(emo) {
                    case 'HAPPY': playBestMatch(['charm', 'joy', 'smile', 'happy'], 'TapBody'); break;
                    case 'ANGRY': playBestMatch(['angry', 'anger', 'shame', 'shake'], 'Shake'); break;
                    case 'SHOCK': playBestMatch(['shock', 'surprise', 'flick', 'shake'], 'Shake'); break;
                    case 'SAD':   playBestMatch(['sad', 'sorrow', 'idle'], 'Idle'); break;
                    default:      playBestMatch(['tap', 'interact', 'idle'], 'Idle'); break;
                }
            } catch(e) { console.warn("åŠ¨ä½œè§¦å‘å¼‚å¸¸:", e); }
        }

        // è°ƒè¯•å·¥å…·ï¼šæ‰“å°å½“å‰æ¨¡å‹çš„æ‰€æœ‰åŠ¨ä½œç»„
        window.debugMotions = () => {
            if (model && model.internalModel.motionManager.motionGroups) {
                console.log("ğŸ“‹ å½“å‰æ¨¡å‹å¯ç”¨åŠ¨ä½œç»„:", model.internalModel.motionManager.motionGroups);
                alert("å·²æ‰“å°åˆ°æ§åˆ¶å° (F12 -> Console)ï¼Œè¯·æŸ¥çœ‹ã€‚");
            } else {
                alert("æ¨¡å‹å°šæœªåŠ è½½æˆ–ä¸æ”¯æŒåŠ¨ä½œç»„ã€‚");
            }
        };

        // --- 4. UI & æ¶ˆæ¯ ---
        document.getElementById('studio-btn').onclick=()=>{document.getElementById('studio-overlay').style.display='flex';socket.emit('get_studio_data');};
        document.getElementById('save-persona-btn').onclick=()=>{socket.emit('save_persona',{id:currentModelId,text:document.getElementById('persona-text').value});};
        socket.on('studio_data',(d)=>{const list=document.getElementById('model-list');list.innerHTML="";currentModelId=d.current_id;d.models.forEach(m=>{let el=document.createElement('div');el.className=`model-card ${m.id===d.current_id?'active':''}`;el.innerHTML=`<div>${m.name}</div>${m.id!==d.current_id?`<div class="btn-del" onclick="delModel('${m.id}',event)">ğŸ—‘ï¸</div>`:''}`;el.onclick=()=>socket.emit('switch_model',{id:m.id});list.appendChild(el);if(m.id===d.current_id)document.getElementById('persona-text').value=m.persona;});});
        socket.on('model_switched',(m)=>{loadModel(m.path);document.getElementById('room-title').textContent=`ğŸ¤– ${m.name}`;if(document.getElementById('studio-overlay').style.display==='flex')socket.emit('get_studio_data');showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);});
        window.delModel=(id,e)=>{e.stopPropagation();if(confirm('åˆ é™¤ï¼Ÿ'))socket.emit('delete_model',{id});};window.dlModel=(n)=>socket.emit('download_model',{name:n});

        // æ¶ˆæ¯å¤„ç†
        let lastPico=null;
        socket.on('chat_message',(d)=>addMsg(d.text,d.sender,d.sender===myUser?'self':'other'));
        socket.on('system_message',(d)=>addMsg(d.text,'ç³»ç»Ÿ','system'));
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);document.getElementById('chat-window').scrollTop=99999;if(audioCtx){if(audioCtx.state==='suspended')audioCtx.resume();try{let s=audioCtx.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioCtx.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        socket.on('toast',(d)=>showToast(d.text,d.type));

        function initAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${y==='pico'&&e?`<span class="emotion-tag">${e}</span>`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        function showToast(m,t='success'){let d=document.createElement('div');d.className='toast';d.textContent=m;if(t==='error'||t==='info')d.style.backgroundColor=t==='error'?'#d63031':(t==='info'?'#0984e3':'#00b894');document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3500);}
        const send=()=>{let i=document.getElementById('user-input');if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
        document.getElementById('send-btn').onclick=send; document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')send();};
    </script>
</body>
</html>

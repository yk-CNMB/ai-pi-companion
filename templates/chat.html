<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live (Debug)</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <style>
        /* --- æ ·å¼ä¿æŒä¸å˜ --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);box-shadow:-5px 0 15px rgba(0,0,0,0.2);z-index:2}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4}#chat-container{width:100%;flex:6;box-shadow:0 -5px 15px rgba(0,0,0,0.2)}}
        #header{background:#6c5ce7;color:white;padding:15px;text-align:center;font-weight:bold}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa}
        #input-area{display:flex;padding:10px;background:white;border-top:1px solid #eee}
        #user-input{flex:1;padding:10px;border:2px solid #eee;border-radius:20px;outline:none;transition:border 0.3s}
        #user-input:focus{border-color:#6c5ce7}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:20px;font-weight:bold}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:90%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:white;color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:#fff0f6;color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:#eee;color:#666;font-size:12px;padding:4px 12px;border-radius:12px;box-shadow:none}
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999;display:flex;align-items:center;justify-content:center}
        #login-box{background:white;padding:30px;border-radius:20px;text-align:center;width:85%;max-width:320px}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold}
        .audio-player{margin-top:6px;height:32px;max-width:80%;border-radius:16px;opacity:0.8}

        /* --- è¯Šæ–­ä¿¡æ¯æ ·å¼ --- */
        #debug-status {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 20px; text-align: center; z-index: 10;
            background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>
    <div id="login-overlay"><div id="login-box"><h2>Pico ç›´æ’­é—´</h2><input type="text" id="username-input" placeholder="ä½ çš„æ˜µç§°" maxlength="10" autocomplete="off"><br><button id="login-btn">è¿›å…¥</button></div></div>

    <div id="stage-container">
        <canvas id="live2d-canvas"></canvas>
        <!-- è¯Šæ–­ä¿¡æ¯æ˜¾ç¤ºåŒº -->
        <div id="debug-status">å‡†å¤‡åŠ è½½æ¨¡å‹...</div>
    </div>

    <div id="chat-container"><div id="header">ğŸ¤– äº’åŠ¨åŒº</div><div id="chat-window"></div><div id="input-area"><input type="text" id="user-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off"><button id="send-btn">å‘é€</button></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        let app_pixi, model, audioContext, analyser, dataArray, isTalking = false;
        const debug = document.getElementById('debug-status');
        function showStatus(msg, isError=false) {
            debug.innerHTML = msg;
            debug.style.color = isError ? '#ff4757' : 'white';
            console.log("[Live2D Status]", msg);
        }

        async function initLive2D() {
            showStatus("1. æ­£åœ¨åˆå§‹åŒ–å›¾å½¢å¼•æ“...");
            const stage = document.getElementById('stage-container');
            app_pixi = new PIXI.Application({
                view: document.getElementById('live2d-canvas'),
                autoStart: true, resizeTo: stage, transparent: true
            });

            try {
                showStatus("2. æ­£åœ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶ (å¯èƒ½éœ€è¦å‡ ç§’)...");
                // å°è¯•åŠ è½½ - å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶åé”™äº†
                model = await PIXI.live2d.Live2DModel.from('/static/live2d/hiyori/Hiyori.model3.json');
                
                showStatus("3. æ¨¡å‹ä¸‹è½½æˆåŠŸï¼æ­£åœ¨æ¸²æŸ“...");
                app_pixi.stage.addChild(model);
                resizeModel();
                app_pixi.ticker.add(lipSyncLoop);
                
                showStatus(""); // æ¸…ç©ºçŠ¶æ€ï¼Œè¯´æ˜æˆåŠŸäº†
                // å¦‚æœæˆåŠŸäº†ä½†æ²¡çœ‹åˆ°ï¼Œå¯èƒ½æ˜¯ä½ç½®é—®é¢˜ï¼Œæˆ‘ä»¬å»¶è¿Ÿ 1 ç§’å†å¼ºåˆ¶è°ƒæ•´ä¸€æ¬¡
                setTimeout(() => {
                    resizeModel();
                    if (debug.innerHTML === "") debug.style.display = 'none';
                }, 1000);

            } catch (e) {
                console.error(e);
                showStatus("âŒ åŠ è½½å¤±è´¥ï¼<br>è¯·æ£€æŸ¥æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶åæ˜¯å¦ä¸º<br>Hiyori.model3.json", true);
            }
        }
        if (typeof PIXI !== 'undefined') initLive2D(); else showStatus("âŒ ä¸¥é‡é”™è¯¯ï¼šæ ¸å¿ƒåº“æœªåŠ è½½ï¼", true);

        function resizeModel() {
            if (!model || !app_pixi) return;
            const stage = document.getElementById('stage-container');
            const w = stage.clientWidth || window.innerWidth; // å¢åŠ ä¿åº•
            const h = stage.clientHeight || window.innerHeight;
            if (w === 0 || h === 0) return; // é˜²æ­¢é™¤ä»¥é›¶

            const scale = Math.min(w / model.width, h / model.height) * 0.9;
            model.scale.set(scale);
            model.x = (w - model.width * scale) / 2;
            model.y = (h - model.height * scale);
            console.log(`æ¨¡å‹è°ƒæ•´: x=${model.x}, y=${model.y}, scale=${scale}`);
        }
        window.addEventListener('resize', resizeModel);

        // --- å…¶ä»–é€»è¾‘ä¿æŒä¸å˜ ---
        function triggerMotion(emotion) { if(model?.internalModel?.motionManager) { try { switch(emotion) { case 'HAPPY': model.internalModel.motionManager.startRandomMotion('Charm'); break; case 'ANGRY': case 'SHOCK': model.internalModel.motionManager.startRandomMotion('Shame'); break; case 'SAD': model.internalModel.motionManager.startRandomMotion('Idle'); break; default: model.internalModel.motionManager.startRandomMotion('TapBody'); break; } } catch(e){} } }
        function lipSyncLoop() { if(!model||!analyser||!isTalking)return; analyser.getByteFrequencyData(dataArray); let sum=0; for(let i=0;i<dataArray.length;i++)sum+=dataArray[i]; if(model.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0, (sum/dataArray.length)/30)); }
        
        const socket = io({ reconnection: true });
        let myUser="", lastPico=null;
        document.getElementById('login-btn').onclick = () => { let n=document.getElementById('username-input').value.trim(); if(n){myUser=n;socket.emit('login',{username:n}); if(!audioContext)try{audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}};
        socket.on('login_success',()=>document.getElementById('login-overlay').style.display='none');
        socket.on('login_failed',(d)=>alert(d.error));
        socket.on('chat_message',(d)=>addMsg(d.text,d.sender,d.sender===myUser?'self':'other'));
        socket.on('system_message',(d)=>addMsg(d.text,'ç³»ç»Ÿ','system'));
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);document.getElementById('chat-window').scrollTop=document.getElementById('chat-window').scrollHeight;if(audioContext){if(audioContext.state==='suspended')audioContext.resume();try{let src=audioContext.createMediaElementSource(a);src.connect(analyser);analyser.connect(audioContext.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${y==='pico'&&e?`<span style="opacity:0.6">[${e}]</span>`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=document.getElementById('chat-window').scrollHeight;if(y==='pico')lastPico=d;}
        document.getElementById('send-btn').onclick=()=>{let i=document.getElementById('user-input');if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pico Studio</title>
    
    <!-- æ ¸å¿ƒä¾èµ–åº“ -->
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    
    <style>
        /* ==========================================================================
           1. å…¨å±€åŸºç¡€é‡ç½® (å®Œæ•´æœªå‹ç¼©)
           ========================================================================== */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif; 
            margin: 0; padding: 0; 
            height: 100dvh; 
            width: 100vw; 
            background-color: #2d3436; 
            overflow: hidden; 
            color: #333; 
        }

        #live2d-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        #orientation-lock { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #2d3436; z-index: 99999; 
            color: white; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; 
        }
        @media screen and (max-width: 1024px) and (orientation: landscape) { 
            #orientation-lock { display: flex !important; } 
        }

        /* ==========================================================================
           2. PC ç«¯å¸ƒå±€æ ·å¼ (å®Œæ•´æœªå‹ç¼©)
           ========================================================================== */
        @media (min-width: 1025px) {
            body { display: flex; flex-direction: row; }
            #stage-container { 
                flex: 1; position: relative; 
                background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); 
                overflow: hidden; background-size: cover; background-position: center; z-index: 1; 
            }
            #chat-container { 
                width: 420px; display: flex; flex-direction: column; background: #fff; 
                z-index: 10; box-shadow: -5px 0 20px rgba(0,0,0,0.15); border-left: 1px solid #eee; height: 100%; 
            }
            #header { 
                background: #6c5ce7; color: white; padding: 0 20px; display: flex; 
                justify-content: space-between; align-items: center; height: 60px; flex-shrink: 0; 
                font-weight: bold; font-size: 18px; 
            }
            #chat-window { flex: 1; overflow-y: auto; padding: 20px; background: #f5f7fa; }
            #input-area { 
                padding: 20px; background: white; border-top: 1px solid #eee; flex-shrink: 0; 
                display: flex; align-items: center; height: 80px; 
            }
            #user-input { 
                flex: 1; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 16px; 
            }
            #send-btn { 
                background: #6c5ce7; color: white; border: none; padding: 0 30px; 
                margin-left: 12px; border-radius: 25px; height: 46px; font-weight: bold; cursor: pointer; 
            }
            .message-bubble { background: white; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .self .message-bubble { background: #6c5ce7; color: white; }
            .pico .message-bubble { background: #fff0f6; border: 2px solid #f8a5c2; }
            
            .icon-btn { background: rgba(0,0,0,0.1); padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
            .icon-btn:hover { background: rgba(0,0,0,0.2); }

            /* ç›´æ’­æ¨¡å¼ */
            body.live-mode #header, body.live-mode #input-area, body.live-mode #debug-pos { display: none !important; }
            body.live-mode #chat-container { 
                position: absolute; right: 30px; top: 30px; bottom: 30px; width: 350px; 
                height: auto; background: rgba(0, 0, 0, 0.5); border-radius: 12px; pointer-events: none; 
            }
            body.live-mode #chat-window { background: transparent; }
            body.live-mode .message-bubble { background: rgba(255,255,255,0.95); backdrop-filter: blur(4px); }
        }

        /* ==========================================================================
           3. ç§»åŠ¨ç«¯å¸ƒå±€æ ·å¼ (å®Œæ•´æœªå‹ç¼©)
           ========================================================================== */
        @media (max-width: 1024px) {
            body { display: block; background: #2d3436; }
            #stage-container { 
                position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; 
                z-index: 0; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); 
                background-size: cover; background-position: center; 
            }
            #chat-container { 
                position: fixed; top: 0; left: 0; width: 100vw; height: 100dvh; 
                z-index: 10; background: transparent; display: flex; flex-direction: column; 
                justify-content: flex-end; pointer-events: none; 
            }
            #header { 
                position: absolute; top: 0; left: 0; width: 100%; padding: max(10px, env(safe-area-inset-top)) 15px 10px; 
                background: transparent; display: flex; justify-content: space-between; align-items: center; 
                pointer-events: auto; z-index: 20; 
            }
            #room-title { text-shadow: 0 1px 3px rgba(0,0,0,0.8); color: white; font-weight: 800; font-size: 18px; }
            .icon-btn { background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); color: white; padding: 8px 12px; border-radius: 8px; }
            
            #chat-window { 
                flex: 0 1 60%; overflow-y: auto; padding: 15px; 
                background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%); 
                pointer-events: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; 
            }
            #input-area { 
                pointer-events: auto; background: rgba(255, 255, 255, 0.9); 
                backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); 
                margin: 0 10px; margin-bottom: max(10px, env(safe-area-inset-bottom)); 
                border-radius: 20px 20px 0 0; padding: 10px; display: flex; align-items: center; 
                box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            }
            #user-input { 
                flex: 1; padding: 10px; border: 1px solid rgba(0,0,0,0.1); 
                border-radius: 20px; background: rgba(255,255,255,0.8); font-size: 16px; 
            }
            #send-btn { 
                background: #6c5ce7; color: white; border: none; width: 44px; height: 44px; 
                border-radius: 50%; margin-left: 8px; font-weight: bold; display: flex; 
                align-items: center; justify-content: center; 
            }
            .message-bubble { 
                background: rgba(255, 255, 255, 0.9) !important; backdrop-filter: blur(5px); 
                border: 1px solid rgba(255,255,255,0.5); color: #2d3436 !important; 
                box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            }
            .self .message-bubble { background: rgba(108, 92, 231, 0.95) !important; color: white !important; border: none; }
            .message-info { color: rgba(255,255,255,0.9); text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        }

        /* ==========================================================================
           4. ç»„ä»¶ä¸å·¥å…·æ ·å¼ (å®Œæ•´æœªå‹ç¼©)
           ========================================================================== */
        .message-container { display: flex; margin-bottom: 15px; flex-direction: column; width: 100%; }
        .message-info { font-size: 12px; margin-bottom: 4px; padding: 0 5px; color: #888; }
        .message-bubble { padding: 10px 15px; border-radius: 18px; max-width: 85%; word-wrap: break-word; position: relative; line-height: 1.5; }
        .self { align-items: flex-end; } .self .message-bubble { border-bottom-right-radius: 4px; }
        .other { align-items: flex-start; } .other .message-bubble { border-bottom-left-radius: 4px; }
        
        .emotion-tag { display: inline-block; font-size: 0.8em; padding: 1px 4px; border-radius: 4px; background: rgba(232, 67, 147, 0.1); color: #e84393; margin-left: 5px; font-weight: bold;}
        .message-img { max-width: 100%; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .audio-player {
            display: block !important; margin-top: 8px; height: 40px; width: 100%; min-width: 200px; 
            border-radius: 20px; background: #f1f3f5; border: 1px solid #ddd; 
            opacity: 1 !important; pointer-events: auto !important; z-index: 999; 
        }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #login-overlay { z-index: 10000; } 
        #studio-overlay { display: none; z-index: 9000; }
        
        #username-input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #6c5ce7; border-radius: 10px; font-size: 18px; text-align: center; outline: none; }
        #login-btn { background: #6c5ce7; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; transition: all 0.3s; cursor: pointer; }
        #login-btn:disabled { background: #b2bec3; cursor: not-allowed; opacity: 0.7; }
        
        .admin-only { display: none; }
        .slider-container { margin: 12px 0; }
        .slider-label { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        .upload-box { border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 12px; margin-top: 15px; cursor: pointer; transition: background 0.2s; background: #fafafa; }
        .model-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .model-card { background: #f8f9fa; padding: 12px; border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; font-size: 14px; }
        .model-card.active { border-color: #6c5ce7; background: #ecebff; font-weight: bold; color: #6c5ce7; }
        
        .chip { display: inline-block; background: #eee; padding: 6px 12px; border-radius: 15px; margin: 5px; cursor: pointer; font-size: 13px; }
        .bg-chip { display: inline-block; background: #fff; padding: 5px 10px; border-radius: 8px; margin: 5px; cursor: pointer; font-size: 12px; border: 1px solid #ddd; }
        .bg-chip.active { background: #d1ecf1; border-color: #17a2b8; font-weight: bold; }
        .btn-del { color: red; font-size: 12px; display: block; margin-top: 5px; }
        
        #preview-area { position: absolute; bottom: 90px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 10px; display: none; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.15); z-index: 100; pointer-events: auto; text-align: center; }
        #preview-img { max-height: 120px; max-width: 100%; border-radius: 8px; }
        #close-preview { position: absolute; top: -10px; right: -10px; width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: pointer; font-weight: bold; line-height: 24px; }
        
        #toast-container { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); z-index: 11000; text-align: center; width: 100%; pointer-events: none; }
        .toast { display: inline-block; background: rgba(0, 0, 0, 0.85); color: white; padding: 10px 25px; border-radius: 30px; margin-top: 10px; animation: fadeOut 3s forwards 2s; backdrop-filter: blur(4px); font-weight: 500; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
        
        #debug-pos { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0, 0, 0, 0.5); padding: 5px; font-size: 10px; pointer-events: none; z-index: 100; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="orientation-lock">
        <div style="font-size: 40px; margin-bottom: 20px;">ğŸ“±</div>
        <h2>ä¸ºäº†æœ€ä½³ä½“éªŒï¼Œè¯·ç«–å±ä½¿ç”¨</h2>
        <p>æ£€æµ‹åˆ°å±å¹•ç¿»è½¬ï¼Œè¿™ä¼šå¯¼è‡´æ¨¡å‹æ¯”ä¾‹å˜å½¢ã€‚</p>
    </div>
    
    <div id="toast-container"></div>
    
    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-overlay" class="overlay">
        <div class="modal-box" style="text-align:center">
            <h2 style="color:#6c5ce7;margin-bottom:20px;">Pico ç›´æ’­é—´</h2>
            <input id="username-input" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="12" autocomplete="off"><br>
            <button id="login-btn" disabled>è¿æ¥ä¸­...</button>
        </div>
    </div>
    
    <!-- å·¥ä½œå®¤é¢æ¿ -->
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <h3 style="margin:0;">ğŸ› ï¸ å·¥ä½œå®¤æ§åˆ¶å°</h3>
                <div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div>
            </div>
            
            <h4>ğŸ­ æ¨¡å‹é€‰æ‹©</h4>
            <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            <hr>
            
            <h4>ğŸ–¼ï¸ èˆå°èƒŒæ™¯</h4>
            <div class="upload-box" onclick="document.getElementById('bg-input').click()">
                ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ (JPG/PNG)
                <input type="file" id="bg-input" accept="image/*" style="display:none" onchange="uploadBackground(this.files[0])">
            </div>
            <div id="bg-list" style="margin-top:10px; max-height:100px; overflow-y:auto"></div>
            <div style="margin-top:5px"><span class="bg-chip" onclick="changeBackground('')">ğŸš« é»˜è®¤ç°è‰²</span></div>

            <div class="admin-only">
                <hr>
                <h4>ğŸ”‘ API Key</h4>
                <div style="display:flex; gap:5px;">
                    <input id="api-key-input" placeholder="è¾“å…¥ Gemini API Key (AIza...)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:8px;">
                    <button onclick="saveGeminiKey()" style="background:#6c5ce7; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">ä¿å­˜</button>
                </div>
                
                <hr>
                <h4>âš™ï¸ å‚æ•°è°ƒæ•´</h4>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                    <div style="font-size:12px;color:#666;margin-bottom:5px;">äººè®¾æç¤ºè¯ (System Prompt):</div>
                    <textarea id="persona-text" style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;font-size:12px;"></textarea>
                    
                    <label style="font-size:12px;color:#666">å£°çº¿é€‰æ‹© (Voice):</label>
                    <select id="voice-select" style="width:100%;padding:8px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd"></select>

                    <div class="slider-container"><div class="slider-label"><span>è¯­é€Ÿ (Rate)</span><span id="rate-val">0%</span></div><input type="range" id="rate-range" min="-50" max="50" oninput="updateVal('rate', this.value)"></div>
                    <div class="slider-container"><div class="slider-label"><span>éŸ³è°ƒ (Pitch)</span><span id="pitch-val">0Hz</span></div><input type="range" id="pitch-range" min="-50" max="50" oninput="updateVal('pitch', this.value)"></div>
                    <div class="slider-container"><div class="slider-label"><span>ç¼©æ”¾ (Scale)</span><span id="scale-val">0.5</span></div><input type="range" id="model-scale" min="0.1" max="2.0" step="0.05" oninput="previewTransform()"></div>
                    <div class="slider-container"><div class="slider-label"><span>ä½ç½® X</span><span id="x-val">0.5</span></div><input type="range" id="model-x" min="0" max="1" step="0.01" oninput="previewTransform()"></div>
                    <div class="slider-container"><div class="slider-label"><span>ä½ç½® Y</span><span id="y-val">0.5</span></div><input type="range" id="model-y" min="0" max="2" step="0.01" oninput="previewTransform()"></div>
                </div>
                <button id="save-settings-btn" style="width:100%;padding:12px;margin-top:15px;background:#6c5ce7;color:white;border:none;border-radius:10px;font-weight:bold;cursor:pointer;">ä¿å­˜æ‰€æœ‰é…ç½®</button>
                
                <hr>
                <h4>â˜ï¸ ä¸Šä¼ æ¨¡å‹ (zip)</h4>
                <div class="upload-box" onclick="document.getElementById('file-input').click()">
                    ç‚¹å‡»ä¸Šä¼ æ¨¡å‹åŒ… (.zip)
                    <input type="file" id="file-input" accept=".zip" style="display:none" onchange="uploadFile(this.files[0])">
                </div>
                <div style="margin-top:10px">
                    <span class="chip" onclick="dlModel('Mao')">â¬‡ï¸ ä¸‹è½½ Mao</span>
                    <span class="chip" onclick="dlModel('Natori')">â¬‡ï¸ ä¸‹è½½ Natori</span>
                </div>
            </div>
            
            <hr>
            <h4>ğŸ§¹ ç¼“å­˜æ¸…ç†</h4>
            <div>
                <span class="chip" onclick="clearLocalHistory()" style="color:red;background:#ffeaea;">æ¸…é™¤èŠå¤©è®°å½•</span>
                <span class="chip" onclick="clearLocalMemories()" style="color:red;background:#ffeaea;">æ¸…é™¤æœ¬åœ°è®°å¿†</span>
            </div>
        </div>
    </div>

    <!-- èˆå°åŒº -->
    <div id="stage-container">
        <canvas id="live2d-canvas"></canvas>
        <div id="debug-pos"></div>
    </div>

    <!-- èŠå¤©åŒº -->
    <div id="chat-container">
        <div id="header">
            <span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span>
            <div style="display:flex;gap:10px">
                <div class="icon-btn" id="live-btn" title="ç›´æ’­æ¨¡å¼ (ä»…PC)" onclick="toggleLiveMode()">ğŸ“º</div>
                <div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div>
                <div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div>
            </div>
        </div>
        
        <div id="chat-window"></div>
        
        <div id="preview-area">
            <img id="preview-img">
            <div id="close-preview" onclick="clearPreview()">Ã—</div>
        </div>

        <div id="input-area">
            <div class="icon-btn" onclick="document.getElementById('img-input').click()" style="margin-right:10px;display:flex;align-items:center;justify-content:center;">ğŸ“·</div>
            <input type="file" id="img-input" accept="image/*" style="display:none" onchange="handleImgSelect(this.files[0])">
            <input id="user-input" placeholder="å‘é€å¼¹å¹•...">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <script>
        const socket = io({reconnection:true});
        let app_pixi, model, myUser="", currentModelId="", currentCfg={scale:0.5,x:0.5,y:0.5}, audioCtx, analyser, dataArray, isTalking=false;
        let isDragging=false, dragData, initialScale, initialDist, iAmAdmin=false;
        window.model = null; let currentImgBase64 = null; 

        // è¾…åŠ©å‡½æ•°
        function updateVal(type, val) { document.getElementById(`${type}-val`).textContent = (val > 0 ? '+' : '') + val + (type==='rate'?'%':'Hz'); }
        function showToast(m,t='success'){let d=document.createElement('div');d.className='toast';d.textContent=m;if(t==='error'||t==='info')d.style.backgroundColor=t==='error'?'#d63031':(t==='info'?'#0984e3':'#00b894');document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3500);}

        // Live2D å˜æ¢é¢„è§ˆ
        function previewTransform() {
            if(!model) return;
            const s = parseFloat(document.getElementById('model-scale').value);
            const x = parseFloat(document.getElementById('model-x').value);
            const y = parseFloat(document.getElementById('model-y').value);
            document.getElementById('scale-val').textContent = s.toFixed(2);
            document.getElementById('x-val').textContent = x.toFixed(2);
            document.getElementById('y-val').textContent = y.toFixed(2);
            applyToModel(s, x, y);
        }

        function applyToModel(s, x, y) {
            if(!model || !app_pixi) return;
            const st = document.getElementById('stage-container');
            if(!model.width) return;
            
            // è®¡ç®—ç¼©æ”¾ (é€‚é…å±å¹•)
            const absScale = (st.clientHeight / model.height) * s;
            model.scale.set(absScale);
            model.x = (st.clientWidth * x) - (model.width / 2);
            model.y = (st.clientHeight * y) - (model.height / 2);
            
            document.getElementById('debug-pos').textContent = `S:${s.toFixed(2)} X:${x.toFixed(2)} Y:${y.toFixed(2)}`;
        }

        function applyConfig(cfg) {
            if(!model || !app_pixi) return;
            const target = cfg || currentCfg || {scale:0.5, x:0.5, y:0.5};
            const s = (target.scale !== undefined) ? target.scale : 0.5;
            const x = (target.x !== undefined) ? target.x : 0.5;
            const y = (target.y !== undefined) ? target.y : 0.5;
            
            // æ›´æ–° UI æ§ä»¶
            if(document.getElementById('model-scale')) {
                document.getElementById('model-scale').value = s;
                document.getElementById('model-x').value = x;
                document.getElementById('model-y').value = y;
                // æ›´æ–°éŸ³è°ƒè¯­é€Ÿæ˜¾ç¤º
                let r = parseInt(target.rate)||0;
                let p = parseInt(target.pitch)||0;
                updateVal('rate', r);
                updateVal('pitch', p);
                document.getElementById('rate-range').value = r;
                document.getElementById('pitch-range').value = p;
            }
            applyToModel(s, x, y);
        }

        document.getElementById('reset-btn').onclick = () => { applyConfig(currentCfg); showToast("ğŸ¯ ä½ç½®å·²é‡ç½®", "info"); };
        
        window.addEventListener('resize', () => { 
            if(app_pixi) app_pixi.renderer.resize(document.getElementById('stage-container').clientWidth, document.getElementById('stage-container').clientHeight); 
            setTimeout(() => applyConfig(currentCfg), 100); 
        });
        
        // ç›´æ’­æ¨¡å¼åˆ‡æ¢
        window.toggleLiveMode = () => { 
            if(window.innerWidth > 1024) {
                document.body.classList.toggle('live-mode'); 
                showToast("ğŸ“º ç›´æ’­æ¨¡å¼ (å†æ¬¡ç‚¹å‡»æˆ–åŒå‡»é€€å‡º)"); 
                window.dispatchEvent(new Event('resize')); 
            } else {
                showToast("æ‰‹æœºç«¯å·²é»˜è®¤å¼€å¯æ²‰æµ¸æ¨¡å¼", "info");
            }
        };
        document.body.addEventListener('dblclick', (e) => { 
            if(document.body.classList.contains('live-mode')) { 
                document.body.classList.remove('live-mode'); 
                showToast("å·²é€€å‡ºç›´æ’­æ¨¡å¼"); 
                window.dispatchEvent(new Event('resize')); 
            } 
        });

        // å›¾ç‰‡å¤„ç†
        window.handleImgSelect = (f) => {
            if(!f) return;
            if (f.size > 50 * 1024 * 1024) { showToast("âŒ å›¾ç‰‡å¤ªå¤§äº† (é™50MB)", "error"); return; }
            const reader = new FileReader();
            reader.onload = (e) => { currentImgBase64 = e.target.result; document.getElementById('preview-img').src = currentImgBase64; document.getElementById('preview-area').style.display = 'block'; };
            reader.readAsDataURL(f);
        };
        window.clearPreview = () => { currentImgBase64 = null; document.getElementById('preview-area').style.display = 'none'; document.getElementById('img-input').value = ""; };

        // ç™»å½•é€»è¾‘
        const loginBtn = document.getElementById('login-btn');
        socket.on('server_ready', ()=>{loginBtn.textContent="è¿›å…¥ç›´æ’­é—´";loginBtn.disabled=false;});
        socket.on('disconnect', ()=>{loginBtn.textContent="å·²æ–­å¼€...";loginBtn.disabled=true;});
        loginBtn.onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;loginBtn.disabled=true;loginBtn.textContent="ç™»å½•ä¸­...";socket.emit('login',{username:n});initAudio();}};

        socket.on('login_success',(d)=>{ 
            document.getElementById('login-overlay').style.display='none'; 
            document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`; 
            currentCfg = d.current_model; 
            if(d.current_model.path) loadModel(d.current_model.path, d.current_model); 
            if(d.current_background) changeBackgroundUI(d.current_background); 
        });
        
        socket.on('history_sync', (d) => { 
            if(d.history && Array.isArray(d.history)){ 
                const win = document.getElementById('chat-window'); 
                win.innerHTML = ""; 
                d.history.forEach(item => { 
                    let type = item.type === 'response' ? 'pico' : (item.sender === myUser ? 'self' : 'other'); 
                    if (item.type === 'system') type = 'system'; 
                    addMsg(item.text, item.sender, type, item.emotion, item.image); 
                }); 
                win.scrollTop = win.scrollHeight; 
            } 
        });

        // Key ç®¡ç†
        window.saveGeminiKey = () => { 
            const key = document.getElementById('api-key-input').value.trim(); 
            if(!key.startsWith("AIza")) { showToast("Key æ ¼å¼é”™è¯¯", "error"); return; } 
            showToast("æ­£åœ¨æ›´æ–° Key..."); 
            fetch('/update_key', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({key: key})})
            .then(r=>r.json()).then(d=>{
                if(d.success){showToast("âœ… Key å·²æ›´æ–°å¹¶ç”Ÿæ•ˆï¼"); document.getElementById('api-key-input').value = "";} 
                else {showToast("âŒ " + d.msg, "error");}
            }); 
        };

        // æ¨¡å‹åŠ è½½
        async function loadModel(path, cfg) {
            console.log("ğŸ“¥ Loading Model:", path);
            if(!app_pixi) { 
                app_pixi = new PIXI.Application({ 
                    view:document.getElementById('live2d-canvas'), 
                    autoStart:true, 
                    resizeTo:document.getElementById('stage-container'), 
                    transparent:true 
                }); 
                initInteraction(); 
            }
            try { 
                if(model) { app_pixi.stage.removeChild(model); model.destroy(); model=null; } 
                app_pixi.stage.removeChildren(); 
                model = await PIXI.live2d.Live2DModel.from(path); 
                app_pixi.stage.addChild(model); 
                window.model = model; 
                setTimeout(() => applyConfig(cfg || currentCfg), 100); 
                app_pixi.ticker.remove(lipSync); 
                app_pixi.ticker.add(lipSync); 
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle'); 
                console.log("âœ… Model Loaded Successfully"); 
            } catch(e) { 
                console.error("âŒ Model Load Failed:", e); 
                showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥", "error"); 
            }
        }

        // äº¤äº’é€»è¾‘
        function initInteraction() { 
            const s=document.getElementById('stage-container');
            app_pixi.stage.interactive=true;
            app_pixi.stage.on('pointerdown',(e)=>{if(model&&(!e.data.originalEvent.touches||e.data.originalEvent.touches.length===1)){isDragging=true;dragData=e.data;model.alpha=0.8;}});
            app_pixi.stage.on('pointerup',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointerupoutside',()=>{isDragging=false;if(model)model.alpha=1;});
            app_pixi.stage.on('pointermove',()=>{if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;}});
            s.addEventListener('wheel',(e)=>{e.preventDefault();if(model){model.scale.x*=(e.deltaY<0?1.1:0.9);model.scale.y=model.scale.x;}},{passive:false});
            s.addEventListener('touchstart',(e)=>{if(e.touches.length===2&&model){isDragging=false;initialDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);initialScale=model.scale.x;}});
            s.addEventListener('touchmove',(e)=>{if(e.touches.length===2&&model&&initialDist){e.preventDefault();model.scale.set(initialScale*(Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)/initialDist));}}); 
        }

        // å£å‹åŒæ­¥ (Server Audio)
        function lipSync(){if(!model||!analyser||!isTalking)return;analyser.getByteFrequencyData(dataArray);let sum=0;for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];if(model.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',Math.min(1.0,(sum/dataArray.length)/30));}
        
        // åŠ¨ä½œè§¦å‘
        function triggerMotion(emo){ 
            if(!model) return; 
            try { 
                const im = model.internalModel; emo = emo.toUpperCase(); 
                // è¡¨æƒ…
                if (im.settings.expressions && im.settings.expressions.length > 0) { 
                    let exprMap = {'HAPPY': ['happy', 'smile', 'joy', 'f01'], 'ANGRY': ['angry', 'mad', 'f02'], 'SAD': ['sad', 'cry', 'f03'], 'SHOCK': ['shock', 'surprise', 'f04']}; 
                    let exprKeywords = exprMap[emo] || []; 
                    let targetExpr = im.settings.expressions.find(e => exprKeywords.some(k => e.Name.toLowerCase().includes(k.toLowerCase())))?.Name; 
                    if (targetExpr) { if (im.expressionManager) im.expressionManager.setExpression(targetExpr); else model.expression(targetExpr); } 
                } 
                // åŠ¨ä½œ
                const definitions = im.motionManager.definitions?.Motions || im.motionManager.motionGroups || im.motionManager.definitions; 
                if (!definitions) return; 
                const groupAliases = {'HAPPY': ['Happy', 'Joy', 'Smile'], 'ANGRY': ['Angry', 'Mad'], 'SAD': ['Sad', 'Cry'], 'SHOCK': ['Shock', 'Surprise'], 'IDLE': ['Idle', 'Wait'], 'NORMAL': ['TapBody']}; 
                let targetGroups = groupAliases[emo] || []; 
                for (let g of targetGroups) { if (definitions[g]) { im.motionManager.startRandomMotion(g, 3); return; } } 
                if (emo !== 'IDLE' && definitions['TapBody']) { im.motionManager.startRandomMotion('TapBody', 3); } 
            } catch(e) { console.error("Trigger Error:", e); } 
        }

        // å·¥ä½œå®¤é€»è¾‘
        document.getElementById('studio-btn').onclick=()=>{document.getElementById('studio-overlay').style.display='flex';socket.emit('get_studio_data');};
        
        socket.on('studio_data',(d)=>{ 
            const list=document.getElementById('model-list');list.innerHTML="";currentModelId=d.current_id; 
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šä¼˜å…ˆå¡«å……è¯­éŸ³åˆ—è¡¨ï¼Œä¸ä¾èµ–æ¨¡å‹ â˜…â˜…â˜…
            const vSelect = document.getElementById('voice-select');
            vSelect.innerHTML = "";
            if(d.voices && d.voices.length > 0) {
                d.voices.forEach(v => {
                    let opt = document.createElement('option');
                    opt.value = v.id;
                    opt.textContent = v.name;
                    vSelect.appendChild(opt);
                });
            } else {
                // ä¿åº•
                let opt = document.createElement('option');
                opt.value = "zh-CN-XiaoxiaoNeural";
                opt.textContent = "é»˜è®¤ (æ™“æ™“)";
                vSelect.appendChild(opt);
            }

            // æ¸²æŸ“æ¨¡å‹åˆ—è¡¨
            if(!d.models||d.models.length===0){list.innerHTML="<div style='grid-column:1/-1;text-align:center;color:red'>âŒ æœªæ‰¾åˆ°æ¨¡å‹</div>";} 
            else{ 
                d.models.forEach(m=>{ 
                    let el=document.createElement('div');
                    el.className=`model-card ${m.id===d.current_id?'active':''}`; 
                    let delBtn=iAmAdmin&&m.id!==d.current_id?`<div class=\"btn-del\" onclick=\"delModel('${m.id}',event)\">ğŸ—‘ï¸</div>`:""; 
                    el.innerHTML=`<div>${m.name}</div>${delBtn}`;
                    el.onclick=()=>socket.emit('switch_model',{id:m.id});
                    list.appendChild(el); 
                    
                    // å¦‚æœæ˜¯å½“å‰æ¨¡å‹ï¼Œå¡«å……è®¾ç½®é¢æ¿
                    if(m.id===d.current_id){ 
                        document.getElementById('persona-text').value=m.persona||""; 
                        
                        // é€‰ä¸­å½“å‰è¯­éŸ³
                        if(m.voice) vSelect.value = m.voice;
                        
                        // å¡«å……éŸ³è°ƒè¯­é€Ÿ
                        let r = parseInt(m.rate)||0;
                        let p = parseInt(m.pitch)||0;
                        document.getElementById('rate-range').value = r; updateVal('rate', r);
                        document.getElementById('pitch-range').value = p; updateVal('pitch', p);
                        
                        // å¡«å……ä½ç½®ç¼©æ”¾
                        let s=m.scale!==undefined?m.scale:0.5, x=m.x!==undefined?m.x:0.5, y=m.y!==undefined?m.y:0.5;
                        if(document.getElementById('model-scale')) {
                            document.getElementById('model-scale').value = s;
                            document.getElementById('model-x').value = x;
                            document.getElementById('model-y').value = y;
                        }
                    } 
                }); 
            } 
            
            // æ¸²æŸ“èƒŒæ™¯åˆ—è¡¨
            const bgList = document.getElementById('bg-list'); bgList.innerHTML = ""; 
            if(d.backgrounds) { d.backgrounds.forEach(bg => { let chip = document.createElement('span'); chip.className = `bg-chip ${bg===d.current_bg ? 'active' : ''}`; chip.textContent = bg; chip.onclick = () => changeBackground(bg); bgList.appendChild(chip); }); } 
        });

        // èƒŒæ™¯ä¸æ¨¡å‹ä¸Šä¼ 
        window.uploadBackground = (f) => { if(!f) return; let fd = new FormData(); fd.append('file', f); showToast("ğŸ–¼ï¸ ä¸Šä¼ èƒŒæ™¯..."); fetch('/upload_bg', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{if(d.success){ showToast("âœ… ä¸Šä¼ æˆåŠŸ"); socket.emit('get_studio_data'); } else showToast("âŒ " + d.msg, "error");}); };
        window.changeBackground = (name) => { socket.emit('switch_background', {name: name}); };
        socket.on('background_update', (d) => { changeBackgroundUI(d.url ? d.url.split('/').pop() : ''); });
        function changeBackgroundUI(filename) { const el = document.getElementById('stage-container'); if (filename) { el.style.backgroundImage = `url('/static/backgrounds/${filename}')`; } else { el.style.backgroundImage = 'radial-gradient(circle,#636e72 10%,#2d3436 90%)'; } }
        
        socket.on('model_switched',(m)=>{currentCfg=m;loadModel(m.path,m);document.getElementById('room-title').textContent=`ğŸ¤– ${m.name}`;if(document.getElementById('studio-overlay').style.display==='flex')socket.emit('get_studio_data');showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);});
        
        // ä¿å­˜é…ç½®
        document.getElementById('save-settings-btn').onclick=()=>{
            let r=document.getElementById('rate-range').value;
            let p=document.getElementById('pitch-range').value;
            socket.emit('save_settings',{
                id:currentModelId,
                persona:document.getElementById('persona-text').value,
                voice:document.getElementById('voice-select').value,
                rate:(r>=0?'+':'')+r+'%',
                pitch:(p>=0?'+':'')+p+'Hz',
                scale:document.getElementById('model-scale').value,
                x:document.getElementById('model-x').value,
                y:document.getElementById('model-y').value
            });
        };
        
        window.delModel=(id,e)=>{e.stopPropagation();if(confirm('åˆ é™¤ï¼Ÿ'))socket.emit('delete_model',{id});};
        window.dlModel=(n)=>socket.emit('download_model',{name:n});
        window.uploadFile=(f)=>{let fd=new FormData();fd.append('file',f);showToast("ğŸ“¤ ä¸Šä¼ ä¸­...");fetch('/upload_model',{method:'POST',body:fd}).then(r=>r.json()).then(d=>{if(d.success){showToast("âœ… æˆåŠŸ");socket.emit('get_studio_data');}else showToast("âŒ "+d.msg,"error")});}
        
        socket.on('admin_unlocked', () => { iAmAdmin = true; showToast("ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²è§£é”ï¼"); document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block'); if(document.getElementById('studio-overlay').style.display==='flex')socket.emit('get_studio_data'); });
        
        // æœ¬åœ°è®°å¿†
        const MEMORY_KEY='pico_user_memories';
        window.clearLocalHistory=()=>{if(confirm('ç¡®å®šæ¸…é™¤èŠå¤©è®°å½•ï¼Ÿ')){document.getElementById('chat-window').innerHTML="";showToast('ğŸ§¹ å·²æ¸…é™¤');}}
        window.clearLocalMemories=()=>{if(confirm('ç¡®å®šæ¸…é™¤ä¸“å±è®°å¿†ï¼Ÿ')){localStorage.removeItem(MEMORY_KEY);showToast('ğŸ§  å·²æ¸…é™¤');}}
        function getLocalMemories(){return JSON.parse(localStorage.getItem(MEMORY_KEY))||[];}
        function saveLocalMemory(f){let m=getLocalMemories();if(f&&!m.includes(f)){m.push(f);if(m.length>50)m=m.slice(-50);localStorage.setItem(MEMORY_KEY,JSON.stringify(m));return true;}return false;}
        
        // èŠå¤©é€»è¾‘
        socket.on('chat_message',(d)=>{addMsg(d.text,d.sender,d.sender===myUser?'self':'other', null, d.image);});
        socket.on('system_message',(d)=>{addMsg(d.text,'ç³»ç»Ÿ','system');});
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        
        // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šéŸ³é¢‘å¤±è´¥åé¦ˆ + è‡ªåŠ¨è°ƒç”¨æœ¬åœ° â˜…â˜…â˜…
        socket.on('audio_failed', (d) => {
            // æ ¹æ®åç«¯ä¼ é€’çš„ type æ¥å†³å®šæ˜¯ error è¿˜æ˜¯ warning (info)
            if (d.type === 'warning' || d.type === 'info') {
                showToast("ğŸ”Š " + d.msg, "info");
            } else {
                showToast("âš ï¸ " + d.msg, "error");
            }
            console.error("Audio Failed:", d.msg);
            
            // è‡ªåŠ¨é™çº§åˆ°æœ¬åœ°æµè§ˆå™¨ TTS
            if (d.text) {
                console.log("Fallback to local TTS for:", d.text);
                speakLocal(d.text);
            }
        });

        // æµè§ˆå™¨æœ¬åœ°æœ—è¯» + æ¨¡æ‹Ÿå£å‹
        function speakLocal(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-CN'; 
            utterance.rate = 1.0;

            utterance.onstart = () => { isTalking = true; simulateMouth(true); };
            utterance.onend = () => { isTalking = false; simulateMouth(false); if(model?.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0); };
            
            window.speechSynthesis.speak(utterance);
        }

        // ç®€å•çš„éšæœºå£å‹æ¨¡æ‹Ÿ
        let mouthInterval;
        function simulateMouth(start) {
            if (mouthInterval) clearInterval(mouthInterval);
            if (!start) return;

            mouthInterval = setInterval(() => {
                if (!model?.internalModel?.coreModel) return;
                const val = Math.random() * 0.6;
                model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', val);
            }, 100);
        }

        let lastPico = null;
        socket.on('audio_response',(d)=>{
            if(d.audio){
                let a = new Audio(); a.crossOrigin = "anonymous"; a.src = d.audio;
                let ui = document.createElement('audio'); ui.className = 'audio-player'; ui.controls = true; ui.src = d.audio;
                if(lastPico) lastPico.appendChild(ui); else document.getElementById('chat-window').appendChild(ui);
                if(audioCtx){if(audioCtx.state==='suspended')audioCtx.resume();try{let s=audioCtx.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioCtx.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}
                a.play().catch(e=>console.log("Auto-play blocked:",e));
            }
        });
        socket.on('toast',(d)=>showToast(d.text,d.type));
        function initAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}
        function addMsg(t,u,y,e,img){
            let d=document.createElement('div');d.className=`message-container ${y}`;
            if(y!=='system') d.innerHTML=`<div class=\"message-info\">${u} ${e?`<span class=\"emotion-tag\">${e}</span>`:''}</div>`;
            let contentHtml = `<div class=\"message-bubble\">`;
            if(img) contentHtml += `<img src=\"${img}\" class=\"message-img\" onclick=\"window.open(this.src)\">`;
            if(t) contentHtml += `<div>${t}</div>`;
            contentHtml += `</div>`;
            d.innerHTML+=contentHtml;
            document.getElementById('chat-window').appendChild(d);
            document.getElementById('chat-window').scrollTop=99999;
            if(y==='pico') lastPico = d;
        }
        const send=()=>{
            let i=document.getElementById('user-input');let t=i.value.trim();
            if(!t && !currentImgBase64) return;
            if(t.startsWith('/')){
                if(t.startsWith('/è®° ')){let f=t.substring(3).trim();if(f&&saveLocalMemory(f)){addMsg(`(æœ¬åœ°) è®°ä½äº†: ${f}`,'æˆ‘','self');showToast('ğŸ§  è®°å¿†å·²ä¿å­˜');}}
                else if(t==='/æ¸…é™¤è®°å¿†'){clearLocalMemories();}
                else if(t.toLowerCase()==='/ç®¡ç†å‘˜'){socket.emit('message',{text:t,memories:getLocalMemories()});}
                else{showToast('æœªçŸ¥æŒ‡ä»¤','error');}
            } else { socket.emit('message', {text:t, image: currentImgBase64, memories:getLocalMemories()}); }
            i.value=''; clearPreview(); 
        };
        document.getElementById('send-btn').onclick=send; document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')send();};
    </script>
</body>
</html>

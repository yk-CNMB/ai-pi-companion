<!-- templates/chat.html (Gunicorn ç¨³å®šç‰ˆ) -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico AI</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            background-color: #f0f2f5; display: flex; flex-direction: column;
        }
        /* --- ç™»å½•ç•Œé¢ --- */
        #login-view {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; padding: 20px; box-sizing: border-box;
        }
        #login-box {
            background: white; padding: 30px; border-radius: 12px;
            text-align: center; width: 90%; max-width: 320px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        #username-input {
            width: calc(100% - 30px); padding: 15px; margin: 15px 0;
            border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
        }
        #login-btn {
            background: #6c5ce7; color: white; border: none;
            width: 100%; padding: 15px; border-radius: 8px; font-size: 18px;
            cursor: pointer; transition: background 0.3s;
        }
        #login-btn:disabled { background: #ccc; }
        #status-msg { margin-top: 15px; color: #d63031; font-size: 14px; }

        /* --- èŠå¤©ç•Œé¢ (é»˜è®¤éšè—) --- */
        #chat-view {
            display: none; flex-direction: column; height: 100%;
        }
        #header {
            background-color: #6c5ce7; color: white; padding: 15px;
            text-align: center; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; }
        .message-container { display: flex; margin-bottom: 12px; }
        .user { justify-content: flex-end; }
        .pico { justify-content: flex-start; }
        .message {
            padding: 10px 15px; border-radius: 18px; max-width: 75%;
            word-wrap: break-word; line-height: 1.5;
        }
        .user .message { background: #6c5ce7; color: white; }
        .pico .message { background: #e4e6eb; color: #050505; }
        #input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #ddd; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 16px; }
        #send-btn {
            background: #6c5ce7; color: white; border: none;
            padding: 0 20px; margin-left: 10px; border-radius: 20px; font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- è§†å›¾ 1: ç™»å½• -->
    <div id="login-view">
        <div id="login-box">
            <h2>ç™»å½• Pico AI</h2>
            <input type="text" id="username-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§° " autocomplete="off">
            <button id="login-btn">è¿æ¥å¹¶ç™»å½•</button>
            <p id="status-msg"></p>
        </div>
    </div>

    <!-- è§†å›¾ 2: èŠå¤© -->
    <div id="chat-view">
        <div id="header">ğŸ¤– Pico (èŠå¤©ä¸­)</div>
        <div id="chat-window"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="å‘é€æ¶ˆæ¯...">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // å…ƒç´ å¼•ç”¨
        const loginView = document.getElementById('login-view');
        const chatView = document.getElementById('chat-view');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username-input');
        const statusMsg = document.getElementById('status-msg');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const header = document.getElementById('header');

        let socket; // æˆ‘ä»¬å°†æ‰‹åŠ¨åˆ›å»º Socket

        // --- 1. ç‚¹å‡»ç™»å½•æŒ‰é’® ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            if (!username) {
                statusMsg.textContent = 'æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼';
                return;
            }

            // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºçŠ¶æ€
            loginBtn.disabled = true;
            statusMsg.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';

            // --- æ‰‹åŠ¨åˆ›å»ºè¿æ¥ ---
            // è¿™ä¼šè§¦å‘åç«¯çš„ 'connect' (å¦‚æœæˆåŠŸ)
            socket = io(); 

            // --- ç»‘å®šæ ¸å¿ƒäº‹ä»¶ ---

            // A. è¿æ¥æˆåŠŸ
            socket.on('connect', () => {
                statusMsg.textContent = 'è¿æ¥æˆåŠŸï¼æ­£åœ¨ç™»å½•...';
                // è¿æ¥æˆåŠŸåï¼Œç«‹åˆ»å‘é€ç™»å½•è¯·æ±‚
                socket.emit('login', { username: username });
            });

            // B. ç™»å½•æˆåŠŸ (ç”±åç«¯ 'login_success' è§¦å‘)
            socket.on('login_success', (data) => {
                statusMsg.textContent = 'ç™»å½•æˆåŠŸï¼';
                // åˆ‡æ¢ç•Œé¢
                loginView.style.display = 'none';
                chatView.style.display = 'flex';
                header.textContent = `ğŸ¤– Pico (ä¸ ${data.username} èŠå¤©ä¸­)`;
            });

            // C. ç™»å½•å¤±è´¥ (ç”±åç«¯ 'login_failed' è§¦å‘)
            socket.on('login_failed', (data) => {
                statusMsg.textContent = `ç™»å½•å¤±è´¥: ${data.error}`;
                loginBtn.disabled = false;
                socket.disconnect(); // ç™»å½•å¤±è´¥ï¼Œæ–­å¼€è¿æ¥
            });

            // D. ä»»ä½•è¿æ¥é”™è¯¯
            socket.on('connect_error', (err) => {
                statusMsg.textContent = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œå’ŒæœåŠ¡å™¨æ—¥å¿—ã€‚';
                loginBtn.disabled = false;
            });

            // E. æ–­å¼€è¿æ¥
            socket.on('disconnect', () => {
                // å¦‚æœä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨åˆ‡æ¢ç•Œé¢çš„ï¼Œå°±æ˜¾ç¤ºç™»å½•ç•Œé¢
                if (chatView.style.display === 'flex') {
                    alert('ä¸æœåŠ¡å™¨çš„è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
                    location.reload(); // å¼ºåˆ¶åˆ·æ–°é¡µé¢
                }
            });

            // --- ç»‘å®šèŠå¤©äº‹ä»¶ ---
            socket.on('response', (data) => appendMessage(data.text, 'pico'));
            socket.on('typing_status', (data) => { /* å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ â€œæ­£åœ¨è¾“å…¥â€ */ });
        });

        // --- èŠå¤©åŠŸèƒ½ ---
        function appendMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message-container ${sender}`;
            div.innerHTML = `<div class="message">${text}</div>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        function sendMessage() {
            const text = userInput.value.trim();
            if (text && socket) {
                appendMessage(text, 'user');
                socket.emit('message', { text: text });
                userInput.value = '';
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Studio</title>
    
    <!-- ========================================= -->
    <!-- 1. æ ¸å¿ƒä¾èµ–åº“ (å¿…é¡»åŠ è½½) -->
    <!-- ========================================= -->
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>

    <!-- ========================================= -->
    <!-- 2. å®Œæ•´æ ·å¼è¡¨ (æ— å‹ç¼©) -->
    <!-- ========================================= -->
    <style>
        /* å…¨å±€å¸ƒå±€ */
        body {
            font-family: "Segoe UI", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            background-color: #2d3436;
            display: flex;
            flex-direction: row; /* é»˜è®¤æ¨ªå‘æ’åˆ— */
            overflow: hidden;
            color: #333;
        }

        /* å·¦ä¾§ï¼šLive2D èˆå° */
        #stage-container {
            flex: 1;
            position: relative;
            background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%);
            overflow: hidden;
            touch-action: none; /* é˜²æ­¢è§¦æ‘¸æ‹–åŠ¨ç½‘é¡µ */
        }

        #live2d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* è°ƒè¯•ä¿¡æ¯ (å·¦ä¸Šè§’) */
        #debug-pos {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00ff00;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
            z-index: 100;
            display: none; /* é»˜è®¤éšè—ï¼Œè°ƒè¯•æ—¶å¯å¼€å¯ */
        }

        /* å³ä¾§ï¼šèŠå¤©çª—å£ */
        #chat-container {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            z-index: 10;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.2);
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #stage-container { flex: 4; min-height: 35vh; }
            #chat-container { width: 100%; flex: 6; min-height: 0; }
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        #header {
            background: #6c5ce7;
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .icon-btn {
            cursor: pointer;
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 6px;
            user-select: none;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(0, 0, 0, 0.3); }

        /* æ¶ˆæ¯åˆ—è¡¨åŒº */
        #chat-window {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f5f7fa;
            overscroll-behavior: contain;
        }

        /* æ¶ˆæ¯æ°”æ³¡é€šç”¨æ ·å¼ */
        .message-container {
            display: flex;
            margin-bottom: 15px;
            flex-direction: column;
        }
        .message-info {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
            padding: 0 5px;
        }
        .message-bubble {
            padding: 10px 14px;
            border-radius: 16px;
            max-width: 85%;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }

        /* è‡ªå·±å‘çš„æ¶ˆæ¯ (å³ä¾§) */
        .self { align-items: flex-end; }
        .self .message-bubble {
            background: #6c5ce7;
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* åˆ«äººå‘çš„æ¶ˆæ¯ (å·¦ä¾§) */
        .other { align-items: flex-start; }
        .other .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        /* Pico çš„å›å¤ (å·¦ä¾§ï¼Œç²‰è‰²) */
        .pico { align-items: flex-start; }
        .pico .message-info { color: #e84393; font-weight: bold; }
        .pico .message-bubble {
            background: #fff0f6;
            color: #333;
            border: 2px solid #f8a5c2;
            border-bottom-left-radius: 4px;
        }

        /* ç³»ç»Ÿæ¶ˆæ¯ */
        .system { align-items: center; margin: 10px 0; }
        .system .message-bubble {
            background: #eee;
            color: #666;
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            box-shadow: none;
        }

        /* æƒ…æ„Ÿæ ‡ç­¾ */
        .emotion-tag {
            display: inline-block;
            font-size: 0.8em;
            padding: 1px 4px;
            border-radius: 4px;
            background: rgba(232, 67, 147, 0.1);
            color: #e84393;
            margin-left: 5px;
        }

        /* éŸ³é¢‘æ’­æ”¾å™¨æ§ä»¶ */
        .audio-player {
            margin-top: 8px;
            height: 32px;
            width: 100%;
            opacity: 0.9;
            border-radius: 16px;
            display: block; /* å¼ºåˆ¶æ˜¾ç¤º */
        }

        /* åº•éƒ¨è¾“å…¥æ¡† */
        #input-area {
            display: flex;
            padding: 10px;
            background: white;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }
        #user-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
        }
        #user-input:focus { border-color: #6c5ce7; }
        #send-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 0 20px;
            margin-left: 10px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
        }

        /* å…¨å±é®ç½© (ç™»å½•/å·¥ä½œå®¤) */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #login-overlay { z-index: 10000; }
        #studio-overlay { display: none; z-index: 9000; }

        /* ç™»å½•è¡¨å• */
        #username-input {
            width: 80%;
            padding: 12px;
            margin: 20px 0;
            border: 2px solid #6c5ce7;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            outline: none;
        }
        #login-btn {
            background: #6c5ce7;
            color: white;
            border: none;
            padding: 12px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
            cursor: pointer;
        }
        #login-btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* å·¥ä½œå®¤å†…éƒ¨å…ƒç´  */
        .admin-only { display: none; } /* é»˜è®¤éšè—ï¼Œç®¡ç†å‘˜å¯è§ */
        
        .model-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .model-card {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .model-card:hover { border-color: #a29bfe; }
        .model-card.active {
            border-color: #6c5ce7;
            background: #e0dfff;
            font-weight: bold;
        }

        /* æ ‡ç­¾ä¸å°æŒ‰é’® */
        .chip {
            display: inline-block;
            background: #eee;
            padding: 6px 12px;
            border-radius: 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .chip:hover { background: #dfe6e9; }
        .btn-del {
            color: red;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }

        /* æ»‘å—æ¡ */
        .slider-container { margin: 12px 0; }
        .slider-label {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        input[type="range"] { width: 100%; }

        /* ä¸Šä¼ æ¡† */
        .upload-box {
            border: 2px dashed #ccc;
            padding: 15px;
            text-align: center;
            border-radius: 10px;
            margin-top: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .upload-box:hover { background: #f0f0ff; border-color: #6c5ce7; }

        /* æç¤ºæ¡† (Toast) */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 11000;
            text-align: center;
            width: 100%;
            pointer-events: none;
        }
        .toast {
            display: inline-block;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            margin-top: 10px;
            font-size: 14px;
            animation: fadeOut 3s forwards 2s;
        }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
    </style>
</head>
<body>
    <!-- å…¨å±€æç¤ºå®¹å™¨ -->
    <div id="toast-container"></div>

    <!-- ==================== ç™»å½•å±‚ ==================== -->
    <div id="login-overlay" class="overlay">
        <div class="modal-box" style="text-align: center;">
            <h2>Pico ç›´æ’­é—´</h2>
            <input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off">
            <br>
            <button id="login-btn" disabled>è¿æ¥ä¸­...</button>
        </div>
    </div>
    
    <!-- ==================== å·¥ä½œå®¤å±‚ ==================== -->
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ› ï¸ å·¥ä½œå®¤</h3>
                <!-- å…³é—­æŒ‰é’® -->
                <div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size: 24px; padding: 0 10px; cursor: pointer;">Ã—</div>
            </div>
            
            <!-- æ¨¡å‹åˆ—è¡¨ (æ‰€æœ‰äººå¯è§) -->
            <div class="studio-section">
                <h4>ğŸ­ æ¨¡å‹åˆ—è¡¨</h4>
                <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- ç®¡ç†å‘˜åŒºåŸŸ (é»˜è®¤éšè—) -->
            <div class="admin-only">
                <hr>
                <h4>âš™ï¸ è¯¦ç»†é…ç½® (<span id="persona-model-name"></span>)</h4>
                
                <!-- äººè®¾ -->
                <label style="font-size:12px; color:#666;">äººè®¾æç¤ºè¯:</label>
                <textarea id="persona-text" style="width:100%; height:60px; padding:8px; border-radius:8px; border:1px solid #ddd; margin-bottom:5px;"></textarea>
                
                <!-- å£°çº¿é€‰æ‹© (ç¡¬ç¼–ç é»˜è®¤å€¼ï¼Œé˜²æ­¢åˆ—è¡¨ä¸ºç©º) -->
                <label style="font-size:12px; color:#666;">å£°çº¿é€‰æ‹©:</label>
                <select id="voice-select" style="width:100%; padding:8px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
                    <!-- è¿™é‡Œçš„é€‰é¡¹æ˜¯â€œä¿åº•â€çš„ï¼Œåç«¯å‘æ¥çš„æ–°æ¨¡å‹ä¼šè¿½åŠ åœ¨åé¢ -->
                    <option value="zh-CN-XiaoxiaoNeural">ğŸ‡¨ğŸ‡³ æ™“æ™“ (é»˜è®¤Â·å…ƒæ°”)</option>
                    <option value="zh-CN-YunxiNeural">ğŸ‡¨ğŸ‡³ äº‘å¸Œ (é˜³å…‰Â·å°‘å¹´)</option>
                    <option value="zh-TW-HsiaoChenNeural">ğŸ‡¹ğŸ‡¼ æ™“è‡» (å°æ¹¾è…”)</option>
                    <option value="en-US-AnaNeural">ğŸ‡ºğŸ‡¸ Ana (è‹±è¯­Â·èè‰)</option>
                </select>

                <!-- è°ƒéŸ³å° -->
                <div class="slider-container">
                    <div class="slider-label"><span>è¯­é€Ÿ</span><span id="rate-val">0%</span></div>
                    <input type="range" id="rate-range" min="-50" max="50" oninput="updateVal('rate', this.value)">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>éŸ³è°ƒ</span><span id="pitch-val">0Hz</span></div>
                    <input type="range" id="pitch-range" min="-50" max="50" oninput="updateVal('pitch', this.value)">
                </div>

                <!-- æ¨¡å‹ä½ç½®æ ¡å‡† -->
                <hr style="border-top: 1px dashed #ccc;">
                <label style="font-size:12px; color:#666;">ç”»é¢ä½ç½®æ ¡å‡†:</label>
                <div class="slider-container">
                    <div class="slider-label"><span>ç¼©æ”¾ (Scale)</span><span id="scale-val">0.5</span></div>
                    <input type="range" id="model-scale" min="0.1" max="3.0" step="0.05" oninput="previewTransform()">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>æ°´å¹³ (X)</span><span id="x-val">0.5</span></div>
                    <input type="range" id="model-x" min="-1.0" max="2.0" step="0.01" oninput="previewTransform()">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>å‚ç›´ (Y)</span><span id="y-val">0.5</span></div>
                    <input type="range" id="model-y" min="-1.0" max="2.0" step="0.01" oninput="previewTransform()">
                </div>

                <!-- ä¿å­˜æŒ‰é’® -->
                <button id="save-settings-btn" style="width:100%; padding:12px; margin-top:15px; background:#6c5ce7; color:white; border:none; border-radius:10px; cursor:pointer; font-weight:bold; font-size:16px;">ä¿å­˜æ‰€æœ‰é…ç½®</button>
                
                <hr>
                <h4>â˜ï¸ ä¸Šä¼  / ä¸‹è½½</h4>
                <div class="upload-box" onclick="document.getElementById('file-input').click()">
                    ç‚¹å‡»ä¸Šä¼ æ¨¡å‹ (.zip)
                    <input type="file" id="file-input" accept=".zip" style="display:none" onchange="uploadFile(this.files[0])">
                </div>
                <div style="margin-top: 10px;">
                    <span class="chip" onclick="dlModel('Mao')">Mao</span>
                    <span class="chip" onclick="dlModel('Natori')">Natori</span>
                    <span class="chip" onclick="dlModel('Rice')">Rice</span>
                </div>
            </div>
            
            <hr>
            <h4>ğŸ§¹ ç¼“å­˜ç®¡ç†</h4>
            <div>
                <span class="chip" onclick="clearLocalHistory()">æ¸…é™¤èŠå¤©è®°å½•</span>
                <span class="chip" onclick="clearLocalMemories()">æ¸…é™¤æˆ‘çš„è®°å¿†</span>
            </div>
        </div>
    </div>

    <!-- ==================== ä¸»ç•Œé¢ ==================== -->
    <div id="stage-container">
        <canvas id="live2d-canvas"></canvas>
        <!-- è°ƒè¯•åæ ‡æ˜¾ç¤º -->
        <div id="debug-pos">Pos: -</div>
    </div>

    <div id="chat-container">
        <div id="header">
            <span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span>
            <div style="display: flex; gap: 10px;">
                <div class="icon-btn" id="reset-btn" title="æ¢å¤ç®¡ç†å‘˜ä¿å­˜çš„ä½ç½®">ğŸ¯</div>
                <div class="icon-btn" id="studio-btn" title="å·¥ä½œå®¤è®¾ç½®">ğŸ› ï¸</div>
            </div>
        </div>
        <div id="chat-window"></div>
        <div id="input-area">
            <input type="text" id="user-input" placeholder="å‘é€å¼¹å¹•..." autocomplete="off">
            <button id="send-btn">å‘é€</button>
        </div>
    </div>

    <!-- ==================== æ ¸å¿ƒé€»è¾‘ ==================== -->
    <script>
        const socket = io({reconnection: true});
        let app_pixi, model, myUser="", currentModelId="", currentCfg={scale:0.5,x:0.5,y:0.5};
        let audioCtx, analyser, dataArray, isTalking=false;
        let isDragging=false, dragData;
        let iAmAdmin = false; // æ˜¯å¦æ˜¯ç®¡ç†å‘˜

        // å·¥å…·å‡½æ•°ï¼šæ›´æ–°æ»‘å—æ•°å€¼æ˜¾ç¤º
        function updateVal(type, val) { 
            document.getElementById(`${type}-val`).textContent = (val > 0 ? '+' : '') + val + (type==='rate'?'%':'Hz'); 
        }
        function updateValLabels(s, x, y) {
            document.getElementById('scale-val').textContent = parseFloat(s).toFixed(2);
            document.getElementById('x-val').textContent = parseFloat(x).toFixed(2);
            document.getElementById('y-val').textContent = parseFloat(y).toFixed(2);
        }

        // --- Live2D ä½ç½®é€»è¾‘ ---
        // 1. å®æ—¶é¢„è§ˆ (ä¸ä¿å­˜)
        function previewTransform() {
            if(!model) return;
            const s = parseFloat(document.getElementById('model-scale').value);
            const x = parseFloat(document.getElementById('model-x').value);
            const y = parseFloat(document.getElementById('model-y').value);
            updateValLabels(s, x, y);
            applyToModel(s, x, y);
        }

        // 2. åº•å±‚åº”ç”¨å‡½æ•°
        function applyToModel(s, x, y) {
            if(!model || !app_pixi) return;
            const st = document.getElementById('stage-container');
            if(!model.width) return; // æ¨¡å‹è¿˜æ²¡åŠ è½½å¥½
            
            const absScale = (st.clientHeight / model.height) * s;
            model.scale.set(absScale);
            model.x = (st.clientWidth * x) - (model.width / 2);
            model.y = (st.clientHeight * y) - (model.height / 2);
            
            document.getElementById('debug-pos').textContent = `S:${s.toFixed(2)} X:${x.toFixed(2)} Y:${y.toFixed(2)}`;
        }

        // 3. åº”ç”¨é…ç½® (å¸¦ç•Œé¢åŒæ­¥)
        function applyConfig(cfg) {
            if(!model || !app_pixi) return;
            // å¦‚æœ cfg ä¸ºç©ºï¼Œä½¿ç”¨å…¨å±€é…ç½®ï¼›å¦‚æœå…¨å±€ä¹Ÿç©ºï¼Œä½¿ç”¨é»˜è®¤
            const target = cfg || currentCfg || {scale:0.5, x:0.5, y:0.5};
            
            // ç¡®ä¿æ•°å€¼æœ‰æ•ˆ
            const s = (target.scale !== undefined) ? target.scale : 0.5;
            const x = (target.x !== undefined) ? target.x : 0.5;
            const y = (target.y !== undefined) ? target.y : 0.5;
            
            // å¦‚æœè®¾ç½®é¢æ¿æ‰“å¼€ï¼ŒåŒæ­¥æ»‘å—ä½ç½®
            if(document.getElementById('model-scale')) {
                document.getElementById('model-scale').value = s;
                document.getElementById('model-x').value = x;
                document.getElementById('model-y').value = y;
                updateValLabels(s, x, y);
            }
            
            applyToModel(s, x, y);
        }

        // å½’ä½æŒ‰é’®
        document.getElementById('reset-btn').onclick = () => {
            applyConfig(currentCfg); 
            showToast("ğŸ¯ å·²æ¢å¤ä¿å­˜çš„ä½ç½®", "info");
        };
        
        // çª—å£ç¼©æ”¾è‡ªé€‚åº”
        window.addEventListener('resize', () => setTimeout(() => applyConfig(currentCfg), 100));

        // --- Socket è¿æ¥ ---
        const loginBtn = document.getElementById('login-btn');
        socket.on('connect', () => {});
        socket.on('server_ready', () => { loginBtn.textContent="è¿›å…¥ç›´æ’­é—´"; loginBtn.disabled=false; });
        socket.on('disconnect', () => { loginBtn.textContent="å·²æ–­å¼€..."; loginBtn.disabled=true; });
        
        loginBtn.onclick = () => {
            let n = document.getElementById('username-input').value.trim();
            if(n) {
                myUser = n;
                loginBtn.disabled = true;
                loginBtn.textContent = "ç™»å½•ä¸­...";
                socket.emit('login', { username: n });
                initAudio();
            }
        };

        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('room-title').textContent = `ğŸ¤– ${d.current_model.name}`;
            currentCfg = d.current_model;
            if(d.current_model.path) loadModel(d.current_model.path, d.current_model);
            // å°è¯•æ¢å¤å†å²
            loadHistory();
        });

        socket.on('login_failed', (d) => {
            alert(d.error);
            loginBtn.disabled = false;
            loginBtn.textContent = "é‡è¯•";
        });

        // --- Live2D åŠ è½½ ---
        async function loadModel(path, cfg) {
            if(!app_pixi) {
                app_pixi = new PIXI.Application({ 
                    view: document.getElementById('live2d-canvas'), 
                    autoStart: true, 
                    resizeTo: document.getElementById('stage-container'), 
                    transparent: true 
                });
                initInteraction();
            }
            try {
                if(model) { 
                    app_pixi.stage.removeChild(model); 
                    model.destroy(); 
                    model = null; 
                }
                app_pixi.stage.removeChildren(); 
                
                console.log("Load Model:", path);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                
                // åŠ è½½å®Œæ¯•åï¼Œå»¶è¿Ÿä¸€ä¸‹åº”ç”¨ä½ç½®
                setTimeout(() => applyConfig(cfg || currentCfg), 100);
                
                app_pixi.ticker.remove(lipSync); 
                app_pixi.ticker.add(lipSync);
                
                if(model.internalModel.motionManager) {
                    model.internalModel.motionManager.startRandomMotion('Idle');
                }
            } catch(e) { 
                console.error(e); 
                showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥", "error"); 
            }
        }

        function initInteraction() {
            const s = document.getElementById('stage-container');
            app_pixi.stage.interactive = true;
            app_pixi.stage.on('pointerdown', (e) => {
                if(model && (!e.data.originalEvent.touches || e.data.originalEvent.touches.length === 1)) {
                    isDragging = true; dragData = e.data; model.alpha = 0.8;
                }
            });
            app_pixi.stage.on('pointerup', () => { isDragging = false; if(model) model.alpha = 1; });
            app_pixi.stage.on('pointerupoutside', () => { isDragging = false; if(model) model.alpha = 1; });
            app_pixi.stage.on('pointermove', () => {
                if(isDragging && model) {
                    const p = dragData.getLocalPosition(model.parent);
                    model.x = p.x - model.width / 2;
                    model.y = p.y - model.height / 2;
                }
            });
            s.addEventListener('wheel', (e) => {
                e.preventDefault();
                if(model) {
                    model.scale.x *= (e.deltaY < 0 ? 1.1 : 0.9);
                    model.scale.y = model.scale.x;
                }
            }, {passive: false});
        }

        function lipSync() {
            if(!model || !analyser || !isTalking) return;
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            // ç®€å•çš„å£å‹æ˜ å°„
            let val = Math.min(1.0, (sum / dataArray.length) / 30);
            if(model.internalModel?.coreModel) {
                model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', val);
            }
        }

        function triggerMotion(emo) {
            if(!model?.internalModel?.motionManager) return;
            try {
                let m = model.internalModel.motionManager;
                // åŠ¨ä½œæ˜ å°„è¡¨
                let map = {
                    'HAPPY': ['Happy', 'Joy', 'Smile', '02', '04', 'é«˜å…´', 'å¼€å¿ƒ'],
                    'ANGRY': ['Angry', 'Mad', '10', '01', 'ç”Ÿæ°”', 'æ„¤æ€’'],
                    'SAD':   ['Sad', 'Cry', '06', 'æ‚²ä¼¤', 'å“­'],
                    'SHOCK': ['Shock', 'Surprise', '05', 'æƒŠè®¶'],
                    'IDLE':  ['Idle', 'Stand', 'Wait', 'å¾…æœº']
                };
                
                let groups = [];
                if(m.definitions && m.definitions.Motions) groups = Object.keys(m.definitions.Motions);
                else if(m.motionGroups) groups = Object.keys(m.motionGroups);

                const keywords = map[emo] || [];
                let target = groups.find(g => keywords.some(k => g.toLowerCase().includes(k.toLowerCase())));
                
                if(target) {
                    console.log(`æ’­æ”¾åŠ¨ä½œ: ${target}`);
                    m.startRandomMotion(target);
                }
            } catch(e) { console.error(e); }
        }

        // --- å·¥ä½œå®¤é€»è¾‘ ---
        document.getElementById('studio-btn').onclick = () => {
            document.getElementById('studio-overlay').style.display = 'flex';
            socket.emit('get_studio_data');
        };

        socket.on('studio_data', (d) => {
            const list = document.getElementById('model-list');
            list.innerHTML = "";
            currentModelId = d.current_id;
            
            d.models.forEach(m => {
                let el = document.createElement('div');
                el.className = `model-card ${m.id === d.current_id ? 'active' : ''}`;
                let delBtn = iAmAdmin && m.id !== d.current_id ? `<div class="btn-del" onclick="delModel('${m.id}',event)">ğŸ—‘ï¸</div>` : "";
                el.innerHTML = `<div>${m.name}</div>${delBtn}`;
                el.onclick = () => socket.emit('switch_model', {id: m.id});
                list.appendChild(el);

                if(m.id === d.current_id) {
                    // å¡«å……äººè®¾
                    document.getElementById('persona-model-name').textContent = m.name;
                    document.getElementById('persona-text').value = m.persona;
                    
                    // å¡«å……å£°çº¿åˆ—è¡¨
                    const vSelect = document.getElementById('voice-select');
                    // ã€å…³é”®ã€‘è¿½åŠ åç«¯å‘æ¥çš„æ–°æ¨¡å‹ (æ¯”å¦‚æœ¬åœ° Piper)
                    if(d.voices) {
                        d.voices.forEach(v => {
                            // é˜²æ­¢é‡å¤æ·»åŠ ç¡¬ç¼–ç çš„é€‰é¡¹
                            if(!Array.from(vSelect.options).some(o => o.value === v.id)) {
                                let opt = document.createElement('option');
                                opt.value = v.id;
                                opt.textContent = v.name;
                                vSelect.appendChild(opt);
                            }
                        });
                    }
                    // é€‰ä¸­å½“å‰
                    if(m.voice) vSelect.value = m.voice;

                    // å¡«å……æ»‘å—
                    let r = parseInt(m.rate) || 0;
                    let p = parseInt(m.pitch) || 0;
                    document.getElementById('rate-range').value = r; updateVal('rate', r);
                    document.getElementById('pitch-range').value = p; updateVal('pitch', p);
                    
                    // å¡«å……ä½ç½®
                    let s = m.scale !== undefined ? m.scale : 0.5;
                    let x = m.x !== undefined ? m.x : 0.5;
                    let y = m.y !== undefined ? m.y : 0.5;
                    document.getElementById('model-scale').value = s;
                    document.getElementById('model-x').value = x;
                    document.getElementById('model-y').value = y;
                    updateValLabels(s, x, y);
                }
            });
        });

        socket.on('model_switched', (m) => {
            currentCfg = m;
            loadModel(m.path, m);
            document.getElementById('room-title').textContent = `ğŸ¤– ${m.name}`;
            if(document.getElementById('studio-overlay').style.display === 'flex') socket.emit('get_studio_data');
            showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);
        });

        document.getElementById('save-settings-btn').onclick = () => {
            let r = document.getElementById('rate-range').value;
            let p = document.getElementById('pitch-range').value;
            socket.emit('save_settings', {
                id: currentModelId,
                persona: document.getElementById('persona-text').value,
                voice: document.getElementById('voice-select').value,
                rate: (r >= 0 ? '+' : '') + r + '%',
                pitch: (p >= 0 ? '+' : '') + p + 'Hz',
                scale: document.getElementById('model-scale').value,
                x: document.getElementById('model-x').value,
                y: document.getElementById('model-y').value
            });
        };

        window.delModel = (id, e) => { e.stopPropagation(); if(confirm('åˆ é™¤ï¼Ÿ')) socket.emit('delete_model', {id}); };
        window.dlModel = (n) => socket.emit('download_model', {name: n});
        window.uploadFile = (f) => {
            let fd = new FormData(); fd.append('file', f);
            showToast("ğŸ“¤ ä¸Šä¼ ä¸­...");
            fetch('/upload_model', {method: 'POST', body: fd})
                .then(r => r.json())
                .then(d => {
                    if(d.success) { showToast("âœ… æˆåŠŸ"); socket.emit('get_studio_data'); }
                    else showToast("âŒ " + d.msg, "error");
                });
        };

        // ç®¡ç†å‘˜è§£é”
        socket.on('admin_unlocked', () => {
            iAmAdmin = true;
            showToast("ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²è§£é”ï¼");
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            if(document.getElementById('studio-overlay').style.display === 'flex') socket.emit('get_studio_data');
        });

        // è®°å¿†ä¸æ¶ˆæ¯
        const H_KEY = 'pico_chat_history';
        const M_KEY = 'pico_user_memories';
        const H_LIMIT = 200; const M_LIMIT = 50;

        function saveHistory(type, data) {
            let h = JSON.parse(localStorage.getItem(H_KEY)) || [];
            h.push({type, data, ts: Date.now()});
            if(h.length > H_LIMIT) h = h.slice(-H_LIMIT);
            localStorage.setItem(H_KEY, JSON.stringify(h));
        }
        function loadHistory() {
            const h = JSON.parse(localStorage.getItem(H_KEY)) || [];
            document.getElementById('chat-window').innerHTML = "";
            h.forEach(i => {
                if(i.type === 'chat_message') addMsg(i.data.text, i.data.sender, i.data.sender === myUser ? 'self' : 'other');
                else if(i.type === 'response') addMsg(i.data.text, 'Pico', 'pico', i.data.emotion);
                else if(i.type === 'system_message') addMsg(i.data.text, 'ç³»ç»Ÿ', 'system');
            });
            document.getElementById('chat-window').scrollTop = 99999;
        }
        window.clearLocalHistory = () => { localStorage.removeItem(H_KEY); document.getElementById('chat-window').innerHTML=""; showToast('ğŸ§¹ å·²æ¸…é™¤'); };
        window.clearLocalMemories = () => { localStorage.removeItem(M_KEY); showToast('ğŸ§  å·²æ¸…é™¤'); };
        function getLocalMemories() { return JSON.parse(localStorage.getItem(M_KEY)) || []; }
        function saveLocalMemory(f) {
            let m = getLocalMemories();
            if(f && !m.includes(f)) {
                m.push(f);
                if(m.length > M_LIMIT) m = m.slice(-M_LIMIT);
                localStorage.setItem(M_KEY, JSON.stringify(m));
                return true;
            }
            return false;
        }

        socket.on('chat_message', (d) => { addMsg(d.text, d.sender, d.sender === myUser ? 'self' : 'other'); saveHistory('chat_message', d); });
        socket.on('system_message', (d) => { addMsg(d.text, 'ç³»ç»Ÿ', 'system'); saveHistory('system_message', d); });
        socket.on('response', (d) => { addMsg(d.text, 'Pico', 'pico', d.emotion); triggerMotion(d.emotion || 'NORMAL'); saveHistory('response', d); });
        socket.on('toast', (d) => showToast(d.text, d.type));

        // éŸ³é¢‘æ’­æ”¾ (å¸¦è‡ªåŠ¨æ’­æ”¾å°è¯•)
        let lastPico = null;
        socket.on('audio_response', (d) => {
            if(d.audio && lastPico) {
                let a = new Audio(); a.crossOrigin = "anonymous"; a.src = d.audio;
                let ui = document.createElement('audio'); ui.className = 'audio-player'; ui.controls = true; ui.src = d.audio;
                lastPico.appendChild(ui);
                document.getElementById('chat-window').scrollTop = 99999;

                if(audioCtx) {
                    if(audioCtx.state === 'suspended') audioCtx.resume();
                    try {
                        let s = audioCtx.createMediaElementSource(a);
                        s.connect(analyser); analyser.connect(audioCtx.destination);
                        a.onplay = () => { isTalking = true; };
                        a.onpause = a.onended = () => { 
                            isTalking = false; 
                            if(model?.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', 0);
                        };
                    } catch(e) {}
                }
                a.play().catch(() => {}); // å°è¯•è‡ªåŠ¨æ’­æ”¾
            }
        });

        function initAudio() {
            if(!audioCtx) try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
            } catch(e) {}
        }

        function addMsg(t, u, y, e) {
            let d = document.createElement('div'); d.className = `message-container ${y}`;
            if(y !== 'system') d.innerHTML = `<div class="message-info">${u} ${e ? `<span class="emotion-tag">${e}</span>` : ''}</div>`;
            d.innerHTML += `<div class="message-bubble">${t}</div>`;
            document.getElementById('chat-window').appendChild(d);
            document.getElementById('chat-window').scrollTop = 99999;
            if(y === 'pico') lastPico = d;
        }

        function showToast(m, t = 'success') {
            let d = document.createElement('div'); d.className = 'toast'; d.textContent = m;
            if(t === 'error' || t === 'info') d.style.backgroundColor = t === 'error' ? '#d63031' : '#0984e3';
            document.getElementById('toast-container').appendChild(d);
            setTimeout(() => d.remove(), 3500);
        }

        const send = () => {
            let i = document.getElementById('user-input'); let t = i.value.trim();
            if(!t) return;
            if(t.startsWith('/')) {
                if(t.startsWith('/è®° ')) {
                    let f = t.substring(3).trim();
                    if(f && saveLocalMemory(f)) { addMsg(`(æœ¬åœ°) è®°ä½äº†: ${f}`, 'æˆ‘', 'self'); showToast('ğŸ§  è®°å¿†å·²ä¿å­˜'); }
                } else if(t === '/æ¸…é™¤è®°å¿†') {
                    clearLocalMemories();
                } else if(t.toLowerCase() === '/ç®¡ç†å‘˜') {
                    socket.emit('message', { text: t });
                } else {
                    showToast('æœªçŸ¥æŒ‡ä»¤', 'error');
                }
            } else {
                socket.emit('message', { text: t, memories: getLocalMemories() });
            }
            i.value = '';
        };
        document.getElementById('send-btn').onclick = send;
        document.getElementById('user-input').onkeypress = (e) => { if(e.key === 'Enter') send(); };
    </script>
</body>
</html>

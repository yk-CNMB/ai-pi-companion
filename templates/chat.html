<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* --- å¸ƒå±€ --- */
        body { font-family: "Segoe UI", sans-serif; margin: 0; padding: 0; height: 100vh; background-color: #2d3436; display: flex; flex-direction: row; overflow: hidden; color: #333; }
        #stage-container { flex: 1; position: relative; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); overflow: hidden; touch-action: none; }
        #live2d-canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        #chat-container { width: 400px; display: flex; flex-direction: column; background: rgba(255,255,255,0.95); z-index: 10; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        @media(max-width:768px) { body { flex-direction: column; } #stage-container { flex: 4; min-height: 35vh; } #chat-container { width: 100%; flex: 6; min-height: 0; } }

        /* --- èŠå¤©ç»„ä»¶ --- */
        #header { background: #6c5ce7; color: white; padding: 12px 15px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .icon-btn { cursor: pointer; padding: 6px 10px; background: rgba(0,0,0,0.15); border-radius: 6px; user-select: none; }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; background: #f5f7fa; overscroll-behavior: contain; }
        .message-container { display: flex; flex-direction: column; margin-bottom: 15px; }
        .message-info { font-size: 12px; color: #999; margin-bottom: 4px; padding: 0 5px; }
        .message-bubble { padding: 10px 14px; border-radius: 16px; max-width: 85%; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .self { align-items: flex-end; } .self .message-bubble { background: #6c5ce7; color: white; border-bottom-right-radius: 4px; }
        .other { align-items: flex-start; } .other .message-bubble { background: white; color: #333; border-bottom-left-radius: 4px; }
        .pico { align-items: flex-start; } .pico .message-info { color: #e84393; font-weight: bold; } .pico .message-bubble { background: #fff0f6; color: #333; border: 2px solid #f8a5c2; border-bottom-left-radius: 4px; }
        .system { align-items: center; margin: 10px 0; } .system .message-bubble { background: #eee; color: #666; font-size: 12px; padding: 4px 12px; }
        #input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; flex-shrink: 0; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; }
        #send-btn { background: #6c5ce7; color: white; border: none; padding: 0 20px; margin-left: 10px; border-radius: 25px; font-weight: bold; }
        
        /* --- æµ®å±‚ --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 450px; max-height: 80vh; overflow-y: auto; }
        #login-overlay { z-index: 10000; } #studio-overlay { display: none; z-index: 9000; }
        #username-input { width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #6c5ce7; border-radius: 10px; font-size: 18px; text-align: center; outline: none; }
        #login-btn { background: #6c5ce7; color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 18px; font-weight: bold; }
        #login-btn:disabled { background: #b2bec3; opacity: 0.7; }
        
        /* ã€å…³é”®ã€‘ç”¨äºéšè—/æ˜¾ç¤ºç®¡ç†å‘˜åŠŸèƒ½çš„ CSS */
        .admin-only { display: none; }

        .model-list { display: grid; grid-template-columns: repeat(auto-fill,minmax(90px,1fr)); gap:10px; margin-top:15px; }
        .model-card { background:#f8f9fa; padding:10px; border-radius:10px; text-align:center; border:2px solid transparent; cursor:pointer; }
        .model-card.active { border-color:#6c5ce7; background:#e0dfff; font-weight:bold; }
        .btn-del { color: red; font-size: 12px; display: block; margin-top: 5px; }
        .chip { display:inline-block; background:#eee; padding:6px 12px; border-radius:15px; margin:5px; cursor:pointer; }
        
        #toast-container { position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:11000; text-align:center; width:100%; }
        .toast { display:inline-block; background:rgba(0,0,0,0.8); color:white; padding:8px 20px; border-radius:20px; margin-top:10px; animation:fadeOut 3s forwards 2s; }
        @keyframes fadeOut{to{opacity:0;visibility:hidden}}
        .audio-player { margin-top:8px; height:32px; width:100%; opacity:0.8; border-radius:16px; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-overlay" class="overlay"><div class="modal-box" style="text-align:center"><h2>Pico ç›´æ’­é—´</h2><input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off"><br><button id="login-btn" disabled>è¿æ¥ä¸­...</button></div></div>
    
    <!-- å·¥ä½œå®¤æµ®å±‚ -->
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;align-items:center"><h3>ğŸ› ï¸ å·¥ä½œå®¤</h3><div onclick="closeStudio()" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div></div>
            
            <div class="studio-section">
                <h4>ğŸ­ æ¨¡å‹åˆ‡æ¢ (æ‰€æœ‰äººå¯è§)</h4>
                <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            </div>
            
            <!-- ã€å…³é”®ã€‘ç®¡ç†å‘˜ä¸“å±åŒºåŸŸ -->
            <div class="admin-only">
                <hr>
                <h4>ğŸ§  äººè®¾ç¼–è¾‘ (<span id="persona-model-name"></span>)</h4>
                <textarea id="persona-text" style="width:100%;height:80px;padding:8px;border-radius:8px;border:1px solid #ddd"></textarea>
                <button id="save-persona-btn" style="width:100%;padding:10px;margin-top:10px;background:#6c5ce7;color:white;border:none;border-radius:10px">ä¿å­˜äººè®¾</button>
            </div>
            <div class="admin-only">
                <hr>
                <h4>â˜ï¸ ä¸‹è½½ (ç®¡ç†å‘˜)</h4>
                <div><span class="chip" onclick="dlModel('Mao')">Mao</span><span class="chip" onclick="dlModel('Natori')">Natori</span><span class="chip" onclick="dlModel('Rice')">Rice</span><span class="chip" onclick="dlModel('Wanko')">Wanko</span></div>
            </div>
            
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container">
        <div id="header">
            <span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span>
            <div style="display:flex;gap:10px">
                <div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div>
                <!-- ã€å…³é”®ã€‘å·¥ä½œå®¤æŒ‰é’®é»˜è®¤æ˜¾ç¤º -->
                <div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div>
            </div>
        </div>
        <div id="chat-window"></div>
        <div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <script>
        const socket = io({reconnection:true});
        let app_pixi, model, myUser="", currentModelId="", audioCtx, analyser, dataArray, isTalking=false;
        let isDragging=false, dragData, initialScale, initialDist;
        
        // ã€å…³é”®ã€‘å¢åŠ ç®¡ç†å‘˜æ ‡è®°
        let iAmAdmin = false;

        // --- 1. è¿æ¥ & ç™»å½• ---
        const loginBtn = document.getElementById('login-btn');
        socket.on('connect', ()=>{});
        socket.on('server_ready', ()=>{ loginBtn.textContent="è¿›å…¥ç›´æ’­é—´"; loginBtn.disabled=false; });
        socket.on('disconnect', ()=>{ loginBtn.textContent="å·²æ–­å¼€..."; loginBtn.disabled=true; });
        loginBtn.onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;loginBtn.disabled=true;loginBtn.textContent="ç™»å½•ä¸­...";socket.emit('login',{username:n});initAudio();}};
        socket.on('login_success',(d)=>{document.getElementById('login-overlay').style.display='none';document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`;if(d.current_model.path)loadModel(d.current_model.path);});
        socket.on('login_failed',(d)=>{alert(d.error);loginBtn.disabled=false;loginBtn.textContent="é‡è¯•";});

        // --- 2. Live2D ---
        async function loadModel(path) {
            if(!app_pixi) {
                app_pixi = new PIXI.Application({ view:document.getElementById('live2d-canvas'), autoStart:true, resizeTo:document.getElementById('stage-container'), transparent:true });
                initInteraction();
            }
            try {
                if(model) app_pixi.stage.removeChild(model);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resetModel();
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) { console.error(e); showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥","error"); }
        }
        function resetModel() { if(model&&app_pixi){const st=document.getElementById('stage-container');const isPortrait=st.clientHeight>st.clientWidth;const scale=Math.min(st.clientWidth/model.width,st.clientHeight/model.height)*(isPortrait?0.85:0.95);model.scale.set(scale);model.x=(st.clientWidth-model.width*scale)/2;model.y=st.clientHeight-model.height*scale;if(isPortrait)model.y-=30;} }
        document.getElementById('reset-btn').onclick=resetModel; window.addEventListener('resize',()=>setTimeout(resetModel,100));

        // --- 3. äº¤äº’ & åŠ¨ä½œ ---
        function initInteraction() {
            const s=document.getElementById('stage-container'); app_pixi.stage.interactive=true;
            app_pixi.stage.on('pointerdown',(e)=>{if(model&&(!e.data.originalEvent.touches||e.data.originalEvent.touches.length===1)){isDragging=true;dragData=e.data;model.alpha=0.8;}});
            app_pixi.stage.on('pointerup',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointerupoutside',()=>{isDragging=false;if(model)model.alpha=1;});
            app_pixi.stage.on('pointermove',()=>{if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;}});
            s.addEventListener('wheel',(e)=>{e.preventDefault();if(model){model.scale.x*=(e.deltaY<0?1.1:0.9);model.scale.y=model.scale.x;}},{passive:false});
            s.addEventListener('touchstart',(e)=>{if(e.touches.length===2&&model){isDragging=false;initialDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);initialScale=model.scale.x;}});
            s.addEventListener('touchmove',(e)=>{if(e.touches.length===2&&model&&initialDist){e.preventDefault();model.scale.set(initialScale*(Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)/initialDist));}});
        }
        function lipSync(){if(!model||!analyser||!isTalking)return;analyser.getByteFrequencyData(dataArray);let sum=0;for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];if(model.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',Math.min(1.0,(sum/dataArray.length)/30));}
        function triggerMotion(emo){if(!model?.internalModel?.motionManager)return;try{let m=model.internalModel.motionManager;switch(emo){case 'HAPPY':if(m.motionGroups.includes('Charm'))m.startRandomMotion('Charm');else m.startRandomMotion('TapBody');break;case 'ANGRY':case 'SHOCK':if(m.motionGroups.includes('Shame'))m.startRandomMotion('Shame');else m.startRandomMotion('Shake');break;default:m.startRandomMotion('Idle');}if(model.internalModel.settings.expressions){let idx=0;if(emo==='SAD')idx=1;else if(emo==='ANGRY')idx=3;else if(emo==='HAPPY')idx=4;else if(emo==='SHOCK')idx=5;if(model.internalModel.settings.expressions[idx])model.expression(model.internalModel.settings.expressions[idx].Name);}}catch(e){}}

        // --- 4. å·¥ä½œå®¤ (åˆ†çº§æƒé™) ---
        const studioOverlay = document.getElementById('studio-overlay');
        document.getElementById('studio-btn').onclick = openStudio;
        function openStudio() {
            studioOverlay.style.display = 'flex';
            // ã€å…³é”®ã€‘æ ¹æ®ç®¡ç†å‘˜çŠ¶æ€ï¼Œæ˜¾ç¤º/éšè—ä¸“å±åŠŸèƒ½
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = iAmAdmin ? 'block' : 'none';
            });
            socket.emit('get_studio_data');
        }
        function closeStudio() { studioOverlay.style.display = 'none'; }
        
        socket.on('studio_data',(d)=>{
            const list=document.getElementById('model-list');list.innerHTML="";currentModelId=d.current_id;
            d.models.forEach(m=>{
                let el=document.createElement('div');
                el.className=`model-card ${m.id===d.current_id?'active':''}`;
                let delBtn = "";
                // ã€å…³é”®ã€‘åªæœ‰ç®¡ç†å‘˜æ‰èƒ½çœ‹åˆ°åˆ é™¤æŒ‰é’®
                if (iAmAdmin && m.id !== d.current_id) {
                    delBtn = `<div class="btn-del" onclick="delModel('${m.id}',event)">ğŸ—‘ï¸åˆ é™¤</div>`;
                }
                el.innerHTML=`<div>${m.name}</div>${delBtn}`;
                el.onclick=()=>socket.emit('switch_model',{id:m.id}); // æ‰€æœ‰äººéƒ½èƒ½åˆ‡æ¢
                list.appendChild(el);
                if(m.id===d.current_id)document.getElementById('persona-text').value=m.persona;
            });
        });
        socket.on('model_switched',(m)=>{loadModel(m.path);document.getElementById('room-title').textContent=`ğŸ¤– ${m.name} (${myUser})`;if(studioOverlay.style.display==='flex')socket.emit('get_studio_data');showToast(`âœ¨ å·²åˆ‡æ¢ä¸º ${m.name}`);});
        window.delModel=(id,e)=>{e.stopPropagation();if(confirm('åˆ é™¤ï¼Ÿ'))socket.emit('delete_model',{id});};
        window.dlModel=(n)=>socket.emit('download_model',{name:n});
        document.getElementById('save-persona-btn').onclick=()=>socket.emit('save_persona',{id:currentModelId,text:document.getElementById('persona-text').value});

        // --- 5. æ¶ˆæ¯ä¸å¤šåª’ä½“ ---
        socket.on('chat_message',(d)=>addMsg(d.text,d.sender,d.sender===myUser?'self':'other'));
        socket.on('system_message',(d)=>addMsg(d.text,'ç³»ç»Ÿ','system'));
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        let lastPico=null;
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);document.getElementById('chat-window').scrollTop=99999;if(audioCtx){if(audioCtx.state==='suspended')audioCtx.resume();try{let s=audioCtx.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioCtx.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        socket.on('toast',(d)=>showToast(d.text,d.type));
        
        // ã€å…³é”®ã€‘ç®¡ç†å‘˜è§£é”
        socket.on('admin_unlocked', () => {
            iAmAdmin = true;
            showToast("ğŸ‘‘ ç®¡ç†å‘˜æƒé™å·²è§£é”ï¼");
            // é‡æ–°æ‰“å¼€å·¥ä½œå®¤ç•Œé¢ä»¥åˆ·æ–°æƒé™
            if (studioOverlay.style.display === 'flex') {
                openStudio();
            }
        });

        // --- 6. å·¥å…·å‡½æ•° ---
        function initAudio(){if(!audioCtx)try{audioCtx=new(window.AudioContext||window.webkitAudioContext)();analyser=audioCtx.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${e?`<span class="emotion-tag">${e}</span>`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        function showToast(m,t='success'){let d=document.createElement('div');d.className='toast';d.textContent=m;if(t==='error'||t==='info')d.style.backgroundColor=t==='error'?'#d63031':'#0984e3';document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3500);}
        const send=()=>{let i=document.getElementById('user-input');if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
        document.getElementById('send-btn').onclick=send; document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')send();};
    </script>
</body>
</html>

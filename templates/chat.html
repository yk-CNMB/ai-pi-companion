<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Studio</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <!-- å¼•å…¥ä¸€ä¸ªç®€å•çš„å›¾æ ‡åº“ (å¯é€‰ï¼Œè¿™é‡Œç”¨ emoji ä»£æ›¿äº†) -->
    <style>
        /* --- å…¨å±€ & å¸ƒå±€ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; height: 100vh; background-color: #2d3436; display: flex; flex-direction: row; overflow: hidden; color: #333; }
        #stage-container { flex: 1; position: relative; background-image: radial-gradient(circle, #636e72 10%, #2d3436 90%); overflow: hidden; }
        #live2d-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #chat-container { width: 400px; display: flex; flex-direction: column; background: rgba(255,255,255,0.95); z-index: 2; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        @media(max-width:768px) { body { flex-direction: column; } #stage-container { flex: 4; } #chat-container { width: 100%; flex: 6; } }

        /* --- èŠå¤©ç»„ä»¶ --- */
        #header { background: #6c5ce7; color: white; padding: 15px; text-align: center; font-weight: bold; position: relative; display: flex; justify-content: space-between; align-items: center; }
        #studio-btn { cursor: pointer; font-size: 20px; padding: 5px 10px; border-radius: 5px; background: rgba(0,0,0,0.1); }
        #chat-window { flex: 1; overflow-y: auto; padding: 15px; background: #f5f7fa; }
        .message-container { display: flex; margin-bottom: 15px; flex-direction: column; }
        .message-info { font-size: 12px; color: #999; margin-bottom: 4px; padding: 0 5px; }
        .message-bubble { padding: 10px 14px; border-radius: 16px; max-width: 85%; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .self { align-items: flex-end; } .self .message-bubble { background: #6c5ce7; color: white; border-bottom-right-radius: 4px; }
        .other { align-items: flex-start; } .other .message-bubble { background: white; color: #333; border-bottom-left-radius: 4px; }
        .pico { align-items: flex-start; } .pico .message-info { color: #e84393; font-weight: bold; } .pico .message-bubble { background: #fff0f6; color: #333; border: 2px solid #f8a5c2; border-bottom-left-radius: 4px; }
        .system { align-items: center; margin: 10px 0; } .system .message-bubble { background: #eee; color: #666; font-size: 12px; padding: 4px 12px; border-radius: 12px; box-shadow: none; }
        #input-area { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; }
        #user-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; font-size: 16px; outline: none; }
        #send-btn { background: #6c5ce7; color: white; border: none; padding: 0 20px; margin-left: 10px; border-radius: 20px; font-weight: bold; }

        /* --- æµ®å±‚ (ç™»å½• & å·¥ä½œå®¤) --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* --- å·¥ä½œå®¤ç•Œé¢ --- */
        #studio-overlay { display: none; } /* é»˜è®¤éšè— */
        .studio-section { margin-bottom: 25px; }
        .studio-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .model-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .model-card { background: #f5f7fa; border: 2px solid transparent; border-radius: 10px; padding: 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .model-card:hover { border-color: #a29bfe; }
        .model-card.active { border-color: #6c5ce7; background: #e9e9ff; font-weight: bold; }
        .model-actions { margin-top: 5px; display: flex; justify-content: space-around; font-size: 12px; }
        .btn-del { color: #ff7675; cursor: pointer; }
        #persona-text { width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 10px; resize: vertical; font-family: monospace; }
        .btn-primary { background: #6c5ce7; color: white; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .download-chips { display: flex; flex-wrap: wrap; gap: 10px; }
        .chip { background: #eee; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .chip:hover { background: #dfe6e9; }

        /* --- Toast æç¤º --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; }
        .toast { background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 25px; margin-bottom: 10px; font-size: 14px; animation: fadeOut 3s forwards; }
        @keyframes fadeOut { 0% { opacity: 1; } 80% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- ç™»å½•å±‚ -->
    <div id="login-overlay" class="overlay">
        <div class="modal-box" style="text-align: center; max-width: 300px;">
            <h2>Pico ç›´æ’­é—´</h2>
            <input id="username-input" placeholder="ä½ çš„æ˜µç§°" style="width: 80%; padding: 12px; margin: 20px 0; border: 2px solid #6c5ce7; border-radius: 10px; text-align: center; outline: none;">
            <br><button id="login-btn" class="btn-primary">è¿›å…¥</button>
        </div>
    </div>

    <!-- å·¥ä½œå®¤å±‚ (æ–°å¢) -->
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">ğŸ› ï¸ Pico å·¥ä½œå®¤</h2>
                <button onclick="closeStudio()" style="background:none; border:none; font-size:24px; cursor:pointer;">Ã—</button>
            </div>

            <div class="studio-section">
                <div class="studio-title">ğŸ­ æ¨¡å‹é€‰æ‹©</div>
                <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            </div>

            <div class="studio-section">
                <div class="studio-title">ğŸ§  äººè®¾ç¼–è¾‘ (<span id="persona-model-name">å½“å‰æ¨¡å‹</span>)</div>
                <textarea id="persona-text" placeholder="åœ¨è¿™é‡Œè¾“å…¥è¿™ä¸ªæ¨¡å‹çš„äººè®¾..."></textarea>
                <div style="text-align: right; margin-top: 10px;">
                    <button id="save-persona-btn" class="btn-primary">ä¿å­˜äººè®¾</button>
                </div>
            </div>

            <div class="studio-section">
                <div class="studio-title">â˜ï¸ ä¸‹è½½æ–°æ¨¡å‹</div>
                <div class="download-chips">
                    <div class="chip" onclick="downloadModel('Mao')">Mao (çŒ«è€³å¨˜)</div>
                    <div class="chip" onclick="downloadModel('Natori')">Natori (å†›è£…)</div>
                    <div class="chip" onclick="downloadModel('Rice')">Rice (ç±³å¨˜)</div>
                    <div class="chip" onclick="downloadModel('Wanko')">Wanko (å…½è€³)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container">
        <div id="header">
            <span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span>
            <div id="studio-btn" title="æ‰“å¼€å·¥ä½œå®¤">ğŸ› ï¸ è®¾ç½®</div>
        </div>
        <div id="chat-window"></div>
        <div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // --- å…¨å±€å˜é‡ ---
        const socket = io({reconnection:true});
        let app_pixi, model, myUser="", currentModelId="";
        let audioContext, analyser, dataArray, isTalking=false;

        // --- Live2D å¼•æ“ ---
        async function loadModel(path) {
            if(!app_pixi) app_pixi = new PIXI.Application({ view:document.getElementById('live2d-canvas'), autoStart:true, resizeTo:document.getElementById('stage-container'), transparent:true });
            try {
                if(model) app_pixi.stage.removeChild(model);
                console.log("Load:", path);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resizeModel();
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) { console.error(e); showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥", "error"); }
        }
        function resizeModel() { if(model&&app_pixi) { 
            const st = document.getElementById('stage-container');
            const sc = Math.min(st.clientWidth/model.width, st.clientHeight/model.height) * 0.9;
            model.scale.set(sc); model.x=(st.clientWidth-model.width*sc)/2; model.y=st.clientHeight-model.height*sc; 
        }}
        window.onresize = resizeModel;

        // --- åŠ¨ä½œä¸å£å‹ ---
        function lipSync() {
            if(!model||!analyser||!isTalking)return;
            analyser.getByteFrequencyData(dataArray);
            let sum=0; for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];
            if(model.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0, (sum/dataArray.length)/30));
        }
        function triggerMotion(emo) {
            if(!model?.internalModel?.motionManager)return;
            try {
                let m = model.internalModel.motionManager;
                switch(emo) {
                    case 'HAPPY': if(m.motionGroups.includes('Charm')) m.startRandomMotion('Charm'); else m.startRandomMotion('TapBody'); break;
                    case 'ANGRY': case 'SHOCK': if(m.motionGroups.includes('Shame')) m.startRandomMotion('Shame'); else m.startRandomMotion('Shake'); break;
                    default: m.startRandomMotion('Idle'); break;
                }
            } catch(e){}
        }

        // --- å·¥ä½œå®¤ UI é€»è¾‘ ---
        document.getElementById('studio-btn').onclick = openStudio;
        function openStudio() {
            document.getElementById('studio-overlay').style.display='flex';
            socket.emit('get_studio_data');
        }
        function closeStudio() { document.getElementById('studio-overlay').style.display='none'; }
        
        socket.on('studio_data', (d) => {
            const list = document.getElementById('model-list');
            list.innerHTML = "";
            currentModelId = d.current_id;
            d.models.forEach(m => {
                let card = document.createElement('div');
                card.className = `model-card ${m.id===d.current_id ? 'active' : ''}`;
                card.innerHTML = `<div>${m.name}</div>`;
                if(m.id !== d.current_id) { // åªèƒ½åˆ é™¤éå½“å‰æ¨¡å‹
                    card.innerHTML += `<div class="model-actions"><span class="btn-del" onclick="deleteModel('${m.id}', event)">ğŸ—‘ï¸åˆ é™¤</span></div>`;
                }
                card.onclick = () => switchModel(m.id);
                list.appendChild(card);

                if(m.id === d.current_id) {
                    document.getElementById('persona-model-name').textContent = m.name;
                    document.getElementById('persona-text').value = m.persona;
                }
            });
        });

        function switchModel(id) { if(id!==currentModelId) socket.emit('switch_model', {id}); }
        function deleteModel(id, e) { e.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹å—ï¼Ÿ')) socket.emit('delete_model', {id}); }
        function downloadModel(name) { socket.emit('download_model', {name}); }
        document.getElementById('save-persona-btn').onclick = () => {
            socket.emit('save_persona', {id: currentModelId, text: document.getElementById('persona-text').value});
        };

        // --- åŸºç¡€äº¤äº’ ---
        document.getElementById('login-btn').onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;socket.emit('login',{username:n});if(!audioContext)try{audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}};
        
        socket.on('login_success', (d) => {
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('main-app').style.display='flex'; // ç¡®ä¿ä¸»ç•Œé¢æ˜¾ç¤º
            document.getElementById('room-title').textContent = `ğŸ¤– ${d.current_model.name} ç›´æ’­é—´ (${myUser})`;
            loadModel(d.current_model.path);
        });
        socket.on('model_switched', (m) => { 
            loadModel(m.path); 
            document.getElementById('room-title').textContent = `ğŸ¤– ${m.name} ç›´æ’­é—´ (${myUser})`;
            if(document.getElementById('studio-overlay').style.display==='flex') socket.emit('get_studio_data'); // åˆ·æ–°å·¥ä½œå®¤ç•Œé¢
            showToast(`âœ¨ æ¨¡å‹å·²åˆ‡æ¢ä¸º ${m.name}`, 'success');
        });

        // ã€å…³é”®ä¿®å¤ã€‘ä½¿ç”¨ myUser å˜é‡æ¥åˆ¤æ–­æ¶ˆæ¯å‘é€è€…
        socket.on('chat', (d) => addMsg(d.text, d.sender, d.sender===myUser?'self':'other'));
        socket.on('sys', (d) => addMsg(d.text, 'ç³»ç»Ÿ', 'system'));
        socket.on('response', (d) => { addMsg(d.text, 'Pico', 'pico', d.emotion); triggerMotion(d.emotion||'NORMAL'); });
        socket.on('audio_response', (d) => {
            if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);document.getElementById('chat-window').scrollTop=99999;if(audioContext){if(audioContext.state==='suspended')audioContext.resume();try{let s=audioContext.createMediaElementSource(a);s.connect(analyser);analyser.connect(audioContext.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model?.internalModel?.coreModel)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}
        });
        socket.on('toast', (d) => showToast(d.text, d.type));

        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;if(y!=='system')d.innerHTML=`<div class="message-info">${u} ${e?`[${e}]`:''}</div>`;d.innerHTML+=`<div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        function showToast(text, type) {
            let t = document.createElement('div'); t.className='toast'; t.textContent=text; t.style.backgroundColor=type==='error'?'#d63031':(type==='info'?'#0984e3':'#00b894');
            document.getElementById('toast-container').appendChild(t); setTimeout(()=>t.remove(), 3500);
        }
        document.getElementById('send-btn').onclick=()=>{let i=document.getElementById('user-input');if(i.value.trim()){socket.emit('message',{text:i.value.trim()});i.value='';}};
        document.getElementById('user-input').onkeypress=(e)=>{if(e.key==='Enter')document.getElementById('send-btn').click();};
    </script>
</body>
</html>


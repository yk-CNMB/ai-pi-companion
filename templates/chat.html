<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live</title>
    <!-- æ ¸å¿ƒåº“ -->
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <style>
        /* --- æ ·å¼åŒº (ä¿æŒç¨³å®š) --- */
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden;color:#333}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden;touch-action:none}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:10;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4;min-height:35vh}#chat-container{width:100%;flex:6;min-height:0}}
        #header{background:#6c5ce7;color:white;padding:12px 15px;text-align:center;font-weight:bold;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .icon-btn{cursor:pointer;padding:6px 10px;background:rgba(0,0,0,0.15);border-radius:6px;user-select:none}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:#f5f7fa;overscroll-behavior:contain}
        .message-container{display:flex;margin-bottom:15px;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .message-bubble{padding:10px 14px;border-radius:16px;max-width:85%;word-wrap:break-word;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white;border-bottom-right-radius:4px}
        .other{align-items:flex-start} .other .message-bubble{background:white;color:#333;border-bottom-left-radius:4px}
        .pico{align-items:flex-start} .pico .message-info{color:#e84393;font-weight:bold} .pico .message-bubble{background:#fff0f6;color:#333;border:2px solid #f8a5c2;border-bottom-left-radius:4px}
        .emotion-tag{display:inline-block;font-size:0.8em;padding:1px 4px;border-radius:4px;background:rgba(232,67,147,0.1);color:#e84393;margin-left:5px}
        .system{align-items:center;margin:10px 0} .system .message-bubble{background:#eee;color:#666;font-size:12px;padding:4px 12px;border-radius:12px;box-shadow:none}
        #input-area{display:flex;padding:10px;background:white;border-top:1px solid #eee;flex-shrink:0}
        #user-input{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;font-size:16px;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:25px;font-weight:bold}
        .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
        .modal-box{background:white;padding:25px;border-radius:20px;width:90%;max-width:450px;max-height:80vh;overflow-y:auto}
        #login-overlay{z-index:10000} #studio-overlay{display:none;z-index:9000}
        #username-input{width:80%;padding:12px;margin:20px 0;border:2px solid #6c5ce7;border-radius:10px;font-size:18px;text-align:center;outline:none}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:12px 40px;border-radius:30px;font-size:18px;font-weight:bold;transition:all 0.3s}
        #login-btn:disabled{background:#b2bec3;cursor:not-allowed;opacity:0.7}
        .model-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:10px;margin-top:15px}
        .model-card{background:#f8f9fa;padding:10px;border-radius:8px;text-align:center;cursor:pointer;border:2px solid transparent}
        .model-card.active{border-color:#6c5ce7;background:#e0dfff;font-weight:bold}
        .chip{display:inline-block;background:#eee;padding:6px 12px;border-radius:15px;margin:5px;cursor:pointer}
        #toast-container{position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:11000;text-align:center;width:100%}
        .toast{display:inline-block;background:rgba(0,0,0,0.8);color:white;padding:8px 20px;border-radius:20px;margin-top:10px;animation:fadeOut 3s forwards 2s}
        @keyframes fadeOut{to{opacity:0;visibility:hidden}}
        .audio-player{margin-top:8px;height:32px;width:100%;opacity:0.8;border-radius:16px;display:block}
        .admin-only { display: none; }
        .slider-container { margin: 10px 0; }
        .slider-label { font-size: 12px; color: #666; display: flex; justify-content: space-between; }
        input[type="range"] { width: 100%; margin-top: 5px; }
        .upload-box { border: 2px dashed #ccc; padding: 15px; text-align: center; border-radius: 10px; margin-top: 10px; cursor: pointer; }
        .btn-del { color: red; font-size: 12px; display: block; margin-top: 5px; }
        .advanced-settings { margin-top: 15px; padding: 15px; background: #f0f3ff; border-radius: 10px; border: 1px solid #c4cffa; }
        .advanced-settings h5 { margin: 0 0 10px 0; color: #4a69bd; font-size: 13px; display: flex; align-items: center; }
        .api-input { width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div id="login-overlay" class="overlay"><div class="modal-box" style="text-align:center"><h2>Pico ç›´æ’­é—´</h2><input id="username-input" placeholder="è¯·è¾“å…¥æ˜µç§°" maxlength="12" autocomplete="off"><br><button id="login-btn" disabled>è¿æ¥ä¸­...</button></div></div>
    
    <div id="studio-overlay" class="overlay">
        <div class="modal-box">
            <div style="display:flex;justify-content:space-between;align-items:center"><h3>ğŸ› ï¸ å·¥ä½œå®¤</h3><div onclick="document.getElementById('studio-overlay').style.display='none'" style="font-size:24px;padding:0 10px;cursor:pointer">Ã—</div></div>
            <div id="model-list" class="model-list">åŠ è½½ä¸­...</div>
            
            <div class="admin-only">
                <hr>
                <h4>âš™ï¸ è°ƒéŸ³ & ä½ç½® (<span id="persona-model-name"></span>)</h4>
                <label style="font-size:12px;color:#666">äººè®¾æç¤ºè¯:</label>
                <textarea id="persona-text" style="width:100%;height:60px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:5px"></textarea>
                
                <label style="font-size:12px;color:#666">å£°çº¿é€‰æ‹©:</label>
                <select id="voice-select" style="width:100%;padding:8px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd" onchange="toggleFishPanel()">
                    <option value="zh-CN-XiaoxiaoNeural">ğŸ‡¨ğŸ‡³ æ™“æ™“ (é»˜è®¤Â·å…ƒæ°”)</option>
                    <option value="zh-CN-YunxiNeural">ğŸ‡¨ğŸ‡³ äº‘å¸Œ (é˜³å…‰Â·å°‘å¹´)</option>
                    <option value="zh-TW-HsiaoChenNeural">ğŸ‡¹ğŸ‡¼ æ™“è‡» (å°æ¹¾è…”)</option>
                    <option value="ja-JP-NanamiNeural">ğŸ‡¯ğŸ‡µ ä¸ƒæµ· (æ—¥è¯­Â·ç”œç¾)</option>
                    <option value="fish-audio">ğŸŸ Fish Audio (è‡ªå®šä¹‰)</option>
                </select>

                <div id="fish-panel" class="advanced-settings" style="display:none">
                    <h5>Fish Audio é…ç½®</h5>
                    <input id="api-url" class="api-input" placeholder="API URL">
                    <input id="api-key" class="api-input" type="password" placeholder="API Key">
                    <input id="model-id" class="api-input" placeholder="Model ID">
                </div>

                <div class="slider-container"><div class="slider-label"><span>è¯­é€Ÿ</span><span id="rate-val">0%</span></div><input type="range" id="rate-range" min="-50" max="50" oninput="updateVal('rate', this.value)"></div>
                <div class="slider-container"><div class="slider-label"><span>éŸ³è°ƒ</span><span id="pitch-val">0Hz</span></div><input type="range" id="pitch-range" min="-50" max="50" oninput="updateVal('pitch', this.value)"></div>

                <div class="slider-container"><div class="slider-label"><span>ä½ç½® X</span><span id="x-val">0.5</span></div><input type="range" id="model-x" min="0" max="1" step="0.01" oninput="previewTransform()"></div>
                <div class="slider-container"><div class="slider-label"><span>ä½ç½® Y</span><span id="y-val">0.5</span></div><input type="range" id="model-y" min="0" max="2" step="0.01" oninput="previewTransform()"></div>
                <div class="slider-container"><div class="slider-label"><span>ç¼©æ”¾</span><span id="scale-val">0.5</span></div><input type="range" id="model-scale" min="0.1" max="2.0" step="0.05" oninput="previewTransform()"></div>

                <button id="save-settings-btn" style="width:100%;padding:10px;margin-top:10px;background:#6c5ce7;color:white;border:none;border-radius:10px">ä¿å­˜æ‰€æœ‰é…ç½®</button>
                
                <hr><h4>â˜ï¸ ä¸Šä¼ /ä¸‹è½½</h4>
                <div class="upload-box" onclick="document.getElementById('file-input').click()">ç‚¹å‡»ä¸Šä¼  .zip<input type="file" id="file-input" accept=".zip" style="display:none" onchange="uploadFile(this.files[0])"></div>
                <div style="margin-top:10px"><span class="chip" onclick="dlModel('Mao')">Mao</span><span class="chip" onclick="dlModel('Natori')">Natori</span><span class="chip" onclick="dlModel('Rice')">Rice</span></div>
            </div>
            <hr><h4>ğŸ§¹ æœ¬åœ°ç¼“å­˜</h4><div><span class="chip" onclick="clearLocalHistory()">æ¸…é™¤æœ¬åœ°èŠå¤©è®°å½•</span><span class="chip" onclick="clearLocalMemories()">æ¸…é™¤æˆ‘çš„ä¸“å±è®°å¿†</span></div>
        </div>
    </div>

    <div id="stage-container"><canvas id="live2d-canvas"></canvas></div>
    <div id="chat-container"><div id="header"><span id="room-title">ğŸ¤– äº’åŠ¨åŒº</span><div style="display:flex;gap:10px"><div class="icon-btn" id="reset-btn" title="å½’ä½">ğŸ¯</div><div class="icon-btn" id="studio-btn" title="è®¾ç½®">ğŸ› ï¸</div></div></div><div id="chat-window"></div><div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div></div>

    <script>
        const socket = io({reconnection:true});
        // ã€æ ¸å¿ƒä¿®å¤ã€‘åœ¨è¿™é‡ŒæŠŠ currentCfg è¡¥ä¸Šäº†ï¼Œåˆå§‹åŒ–ä¸ºç©ºå¯¹è±¡
        let app_pixi, model, myUser="", currentModelId="", currentCfg={}, audioCtx, analyser, dataArray, isTalking=false;
        let isDragging=false, dragData, initialScale, initialDist, iAmAdmin=false;

        function updateVal(type, val) { document.getElementById(`${type}-val`).textContent = (val > 0 ? '+' : '') + val + (type==='rate'?'%':'Hz'); }
        function toggleFishPanel() {
            document.getElementById('fish-panel').style.display = (document.getElementById('voice-select').value === 'fish-audio') ? 'block' : 'none';
        }

        function previewTransform() {
            if(!model) return;
            const s = parseFloat(document.getElementById('model-scale').value);
            const x = parseFloat(document.getElementById('model-x').value);
            const y = parseFloat(document.getElementById('model-y').value);
            document.getElementById('scale-val').textContent = s.toFixed(2);
            document.getElementById('x-val').textContent = x.toFixed(2);
            document.getElementById('y-val').textContent = y.toFixed(2);
            const st = document.getElementById('stage-container');
            const absScale = (st.clientHeight / model.height) * s;
            model.scale.set(absScale);
            model.x = (st.clientWidth * x) - (model.width / 2);
            model.y = (st.clientHeight * y) - (model.height / 2);
        }

        const loginBtn = document.getElementById('login-btn');
        socket.on('connect', ()=>{});
        socket.on('server_ready', ()=>{loginBtn.textContent="è¿›å…¥ç›´æ’­é—´";loginBtn.disabled=false;});
        socket.on('disconnect', ()=>{loginBtn.textContent="å·²æ–­å¼€...";loginBtn.disabled=true;});
        loginBtn.onclick=()=>{let n=document.getElementById('username-input').value.trim();if(n){myUser=n;loginBtn.disabled=true;loginBtn.textContent="ç™»å½•ä¸­...";socket.emit('login',{username:n});initAudio();}};
        socket.on('login_success',(d)=>{
            document.getElementById('login-overlay').style.display='none';
            document.getElementById('room-title').textContent=`ğŸ¤– ${d.current_model.name}`;
            currentCfg = d.current_model;
            if(d.current_model.path) loadModel(d.current_model.path, d.current_model);
            loadHistory();
        });
        socket.on('login_failed',(d)=>{alert(d.error);loginBtn.disabled=false;loginBtn.textContent="é‡è¯•";});

        async function loadModel(path, cfg) {
            if(!app_pixi) {
                app_pixi = new PIXI.Application({ view:document.getElementById('live2d-canvas'), autoStart:true, resizeTo:document.getElementById('stage-container'), transparent:true });
                initInteraction();
            }
            try {
                if(model) { app_pixi.stage.removeChild(model); model.destroy(); model=null; }
                app_pixi.stage.removeChildren(); 
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                setTimeout(() => applyTransform(cfg || {}), 100);
                app_pixi.ticker.remove(lipSync); app_pixi.ticker.add(lipSync);
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) { console.error(e); showToast("âŒ æ¨¡å‹åŠ è½½å¤±è´¥","error"); }
        }

        function applyTransform(cfg) {
            if(!model || !app_pixi) return;
            const s = cfg?.scale || 0.5;
            const x = cfg?.x || 0.5;
            const y = cfg?.y || 0.5;
            document.getElementById('model-scale').value = s;
            document.getElementById('model-x').value = x;
            document.getElementById('model-y').value = y;
            updateValLabels(s,x,y);
            const st = document.getElementById('stage-container');
            if (!model.width || !model.height) return;
            const absScale = (st.clientHeight / model.height) * s;
            model.scale.set(absScale);
            model.x = (st.clientWidth * x) - (model.width / 2);
            model.y = (st.clientHeight * y) - (model.height / 2);
        }
        function updateValLabels(s,x,y) { document.getElementById('scale-val').textContent=s.toFixed(2); document.getElementById('x-val').textContent=x.toFixed(2); document.getElementById('y-val').textContent=y.toFixed(2); }
        document.getElementById('reset-btn').onclick=()=>applyTransform(currentCfg);
        window.addEventListener('resize',()=>setTimeout(()=>applyTransform(currentCfg),100));

        function initInteraction() { const s=document.getElementById('stage-container');app_pixi.stage.interactive=true;app_pixi.stage.on('pointerdown',(e)=>{if(model&&(!e.data.originalEvent.touches||e.data.originalEvent.touches.length===1)){isDragging=true;dragData=e.data;model.alpha=0.8;}});app_pixi.stage.on('pointerup',()=>{isDragging=false;if(model)model.alpha=1;}).on('pointerupoutside',()=>{isDragging=false;if(model)model.alpha=1;});app_pixi.stage.on('pointermove',()=>{if(isDragging&&model){const p=dragData.getLocalPosition(model.parent);model.x=p.x-model.width/2;model.y=p.y-model.height/2;}});s.addEventListener('wheel',(e)=>{e.preventDefault();if(model){model.scale.x*=(e.deltaY<0?1.1:0.9);model.scale.y=model.scale.x;}},{passive:false});s.addEventListener('touchstart',(e)=>{if(e.touches.length===2&&model){isDragging=false;initialDist=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY);initialScale=model.scale.x;}});s.addEventListener('touchmove',(e)=>{if(e.touches.length===2&&model&&initialDist){e.preventDefault();model.scale.set(initialScale*(Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)/initialDist));}}); }
        function lipSync(){if(!model||!analyser||!isTalking)return;analyser.getByteFrequencyData(dataArray);let sum=0;for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];if(model.internalModel?.coreModel)model.

<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico Live (Debug)</title>
    <script src="/static/js/live2d.min.js"></script>
    <script src="/static/js/live2dcubismcore.min.js"></script>
    <script src="/static/js/pixi.min.js"></script>
    <script src="/static/js/index.min.js"></script>
    <style>
        body{font-family:"Segoe UI",sans-serif;margin:0;padding:0;height:100vh;background-color:#2d3436;display:flex;flex-direction:row;overflow:hidden}
        #stage-container{flex:1;position:relative;background-image:radial-gradient(circle,#636e72 10%,#2d3436 90%);overflow:hidden}
        #live2d-canvas{position:absolute;top:0;left:0;width:100%;height:100%}
        #chat-container{width:400px;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);z-index:2;box-shadow:-5px 0 15px rgba(0,0,0,0.2)}
        @media(max-width:768px){body{flex-direction:column}#stage-container{flex:4}#chat-container{width:100%;flex:6;box-shadow:0 -5px 15px rgba(0,0,0,0.2)}}
        #header{background:#6c5ce7;color:white;padding:15px;text-align:center;font-weight:bold;position:relative}
        #settings-btn{position:absolute;right:15px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:20px;opacity:0.8}
        #settings-btn:hover{opacity:1}
        #model-menu{position:absolute;top:50px;right:10px;background:white;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);padding:10px;display:none;z-index:100;max-height:60vh;overflow-y:auto}
        .model-item{padding:8px 12px;cursor:pointer;border-radius:5px;color:#333;white-space:nowrap}
        .model-item:hover{background:#f0f0f0} .model-item.active{background:#6c5ce7;color:white}
        #chat-window{flex:1;overflow-y:auto;padding:15px;background:linear-gradient(to bottom,rgba(255,255,255,0.5),rgba(255,255,255,0.8))}
        #input-area{display:flex;padding:10px;background:white}
        #user-input{flex:1;padding:10px;border-radius:20px;border:2px solid #eee;outline:none}
        #send-btn{background:#6c5ce7;color:white;border:none;padding:0 20px;margin-left:10px;border-radius:20px}
        #login-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999;display:flex;align-items:center;justify-content:center}
        #login-box{background:white;padding:30px;border-radius:20px;text-align:center;width:80%;max-width:300px}
        #username-input{width:80%;padding:10px;margin:20px 0;border-radius:10px;border:2px solid #6c5ce7;text-align:center}
        #login-btn{background:#6c5ce7;color:white;border:none;padding:10px 30px;border-radius:20px}
        .message-bubble{padding:10px;border-radius:15px;margin-bottom:10px;max-width:85%;word-wrap:break-word;background:white;box-shadow:0 1px 2px rgba(0,0,0,0.1)}
        .self{align-items:flex-end} .self .message-bubble{background:#6c5ce7;color:white}
        .message-container{display:flex;flex-direction:column}
        .message-info{font-size:12px;color:#999;margin-bottom:4px;padding:0 5px}
        .audio-player{width:80%;height:30px;margin-top:5px;opacity:0.8}
        
        /* --- è°ƒè¯•ä¿¡æ¯æ ·å¼ --- */
        #debug-status {
            position: absolute; top: 10px; left: 10px; color: #0f0;
            background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px;
            font-family: monospace; font-size: 12px; pointer-events: none; z-index: 999;
            max-width: 300px; word-break: break-all;
        }
    </style>
</head>
<body>
    <div id="login-overlay"><div id="login-box"><h2>AIå¦™å¦™å±‹</h2><input id="username-input" placeholder="æ˜µç§°"><br><button id="login-btn">è¿›å…¥</button></div></div>
    
    <div id="stage-container">
        <canvas id="live2d-canvas"></canvas>
        <div id="debug-status">ç­‰å¾…åˆå§‹åŒ–...</div>
    </div>

    <div id="chat-container">
        <div id="header">äº’åŠ¨åŒº <div id="settings-btn">âš™ï¸</div></div>
        <div id="model-menu">åŠ è½½ä¸­...</div>
        <div id="chat-window"></div>
        <div id="input-area"><input id="user-input" placeholder="å‘é€å¼¹å¹•..."><button id="send-btn">å‘é€</button></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // =========================================
        // ğŸ”§ å…¨å±€è°ƒè¯• & å¾®è°ƒåŒº
        // =========================================
        const DEBUG = true;        // æ˜¯å¦æ˜¾ç¤ºå·¦ä¸Šè§’çš„ç»¿è‰²è°ƒè¯•æ–‡å­—
        const MODEL_SCALE =1.5;   // å…¨å±€ç¼©æ”¾ç³»æ•° (0.5 ~ 1.5)
        const OFFSET_X = -250;        // å…¨å±€å·¦å³å¹³ç§» (è´Ÿå·¦æ­£å³)
        const OFFSET_Y = -600;        // å…¨å±€ä¸Šä¸‹å¹³ç§» (è´Ÿä¸Šæ­£ä¸‹)
        // =========================================

        let app_pixi, model, audioContext, analyser, dataArray, isTalking=false;
        const socket = io({reconnection:true});
        let myUser="", lastPico=null;

        function showStatus(msg, isError=false) {
            if(!DEBUG) return;
            const el = document.getElementById('debug-status');
            el.style.display = 'block';
            el.innerHTML = msg;
            el.style.color = isError ? '#ff4757' : '#2ed573';
            console.log("[Debug]", msg.replace(/<br>/g, ' '));
            if(!isError && msg.includes("æˆåŠŸ")) setTimeout(()=>el.style.display='none', 3000);
        }

        async function initPixi() {
            showStatus("1. åˆå§‹åŒ–å›¾å½¢å¼•æ“...");
            app_pixi = new PIXI.Application({
                view: document.getElementById('live2d-canvas'),
                autoStart: true, resizeTo: document.getElementById('stage-container'), transparent: true
            });
        }
        if(typeof PIXI!=='undefined') initPixi(); else showStatus("âŒ æ ¸å¿ƒåº“æœªåŠ è½½", true);

        async function loadModel(path) {
            if(!app_pixi) return;
            showStatus(`2. æ­£åœ¨åŠ è½½æ¨¡å‹: ${path.split('/').pop()}...`);
            try {
                if(model) app_pixi.stage.removeChild(model);
                model = await PIXI.live2d.Live2DModel.from(path);
                app_pixi.stage.addChild(model);
                resizeModel();
                showStatus("âœ… æ¨¡å‹åŠ è½½æˆåŠŸï¼");
                if(model.internalModel.motionManager) model.internalModel.motionManager.startRandomMotion('Idle');
            } catch(e) {
                console.error(e);
                showStatus(`âŒ åŠ è½½å¤±è´¥: ${path}<br>è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨`, true);
            }
        }

        function resizeModel() {
            if(!model||!app_pixi) return;
            const stage = document.getElementById('stage-container');
            // è‡ªåŠ¨è®¡ç®—æœ€ä½³ç¼©æ”¾æ¯”ï¼Œç„¶åä¹˜ä¸Šç”¨æˆ·çš„å¾®è°ƒç³»æ•°
            const scale = Math.min(stage.clientWidth/model.width, stage.clientHeight/model.height) * MODEL_SCALE;
            model.scale.set(scale);
            // å±…ä¸­ + åº•å¯¹é½ + ç”¨æˆ·å¾®è°ƒåç§»
            model.x = (stage.clientWidth - model.width*scale)/2 + OFFSET_X;
            model.y = (stage.clientHeight - model.height*scale) + OFFSET_Y;
        }
        window.onresize = resizeModel;

        // --- å£å‹ä¸åŠ¨ä½œ ---
        app_pixi.ticker.add(() => {
            if(!model||!analyser||!isTalking)return;
            analyser.getByteFrequencyData(dataArray);
            let sum=0; for(let i=0;i<dataArray.length;i++)sum+=dataArray[i];
            if(model.internalModel?.coreModel) model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY', Math.min(1.0, (sum/dataArray.length)/30));
        });
        function triggerMotion(emo) {
            if(!model?.internalModel?.motionManager)return;
            try {
                switch(emo) {
                    case 'HAPPY': model.expression('F05'); model.internalModel.motionManager.startRandomMotion('Charm'); break;
                    case 'ANGRY': model.expression('F04'); model.internalModel.motionManager.startRandomMotion('Shame'); break;
                    case 'SHOCK': model.expression('F06'); model.internalModel.motionManager.startRandomMotion('Shake'); break;
                    case 'SAD':   model.expression('F02'); model.internalModel.motionManager.startRandomMotion('Idle'); break;
                    default:      model.expression('F01'); model.internalModel.motionManager.startRandomMotion('TapBody'); break;
                }
            } catch(e){}
        }

        // --- UI & Socket ---
        const settingsBtn = document.getElementById('settings-btn');
        const modelMenu = document.getElementById('model-menu');
        settingsBtn.onclick = (e) => { e.stopPropagation(); if(modelMenu.style.display==='block') modelMenu.style.display='none'; else { socket.emit('get_models'); modelMenu.style.display='block'; }};
        document.onclick = () => modelMenu.style.display='none';
        socket.on('models_list', (d) => {
            modelMenu.innerHTML=""; d.models.forEach(m=>{
                let item=document.createElement('div'); item.className=`model-item ${m.path===d.current?'active':''}`;
                item.textContent=m.name; item.onclick=()=>socket.emit('change_model',{path:m.path});
                modelMenu.appendChild(item);
            });
        });
        socket.on('model_changed', (d) => loadModel(d.path));

        document.getElementById('login-btn').onclick=()=>{let n=document.getElementById('username-input').value;if(n){socket.emit('login',{username:n});if(!audioContext)try{audioContext=new(window.AudioContext||window.webkitAudioContext)();analyser=audioContext.createAnalyser();analyser.fftSize=512;dataArray=new Uint8Array(analyser.frequencyBinCount);}catch(e){}}};
        socket.on('login_success',(d)=>{document.getElementById('login-overlay').style.display='none'; if(d.current_model)loadModel(d.current_model);});
        socket.on('login_failed',(d)=>alert(d.error));
        function addMsg(t,u,y,e){let d=document.createElement('div');d.className=`message-container ${y}`;d.innerHTML=`<div class="message-info">${u} ${e?`[${e}]`:''}</div><div class="message-bubble">${t}</div>`;document.getElementById('chat-window').appendChild(d);document.getElementById('chat-window').scrollTop=99999;if(y==='pico')lastPico=d;}
        socket.on('chat_message',(d)=>addMsg(d.text,d.sender,d.sender===document.getElementById('username-input').value?'self':'other'));
        socket.on('system_message',(d)=>addMsg(d.text,'ç³»ç»Ÿ','system'));
        socket.on('response',(d)=>{addMsg(d.text,'Pico','pico',d.emotion);triggerMotion(d.emotion||'NORMAL');});
        socket.on('audio_response',(d)=>{if(d.audio&&lastPico){let a=new Audio();a.crossOrigin="anonymous";a.src=d.audio;let ui=document.createElement('audio');ui.className='audio-player';ui.controls=true;ui.src=d.audio;lastPico.appendChild(ui);if(audioContext){if(audioContext.state==='suspended')audioContext.resume();try{let src=audioContext.createMediaElementSource(a);src.connect(analyser);analyser.connect(audioContext.destination);a.onplay=()=>{isTalking=true};a.onpause=a.onended=()=>{isTalking=false;if(model)model.internalModel.coreModel.setParameterValueById('ParamMouthOpenY',0)};}catch(e){}}a.play().catch(()=>{});}});
        document.getElementById('send-btn').onclick=()=>{let i=document.getElementById('user-input');if(i.value){socket.emit('message',{text:i.value});i.value='';}};
    </script>
</body>
</html>




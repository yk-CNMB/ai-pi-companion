<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pico AI</title>
    <style>
        /* ÁÆÄÂçïÁöÑÁé∞‰ª£ÂåñÊ†∑Âºè */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
            background-color: #f5f7fa; color: #333;
        }
        #header {
            background-color: #6c5ce7; color: white;
            padding: 15px; text-align: center; font-weight: bold;
            font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #chat-window {
            flex: 1; overflow-y: auto; padding: 15px;
            scroll-behavior: smooth;
        }
        .message-container { display: flex; margin-bottom: 15px; }
        .message-container.user { justify-content: flex-end; }
        .message-container.pico { justify-content: flex-start; }
        .avatar {
            width: 40px; height: 40px; border-radius: 50%;
            margin-right: 10px; background-color: #eee;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .message {
            padding: 12px 16px; border-radius: 18px;
            max-width: 75%; line-height: 1.5; word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .user .message {
            background-color: #6c5ce7; color: white;
            border-bottom-right-radius: 4px;
        }
        .pico .message {
            background-color: white; color: #333;
            border-bottom-left-radius: 4px;
        }
        #typing-indicator {
            padding: 5px 20px; color: #999; font-style: italic; font-size: 0.9rem;
            opacity: 0; transition: opacity 0.3s;
        }
        #typing-indicator.active { opacity: 1; }
        #input-area {
            display: flex; padding: 10px; background: white;
            border-top: 1px solid #eee;
        }
        #user-input {
            flex: 1; padding: 12px; border: 1px solid #ddd;
            border-radius: 25px; font-size: 16px; outline: none;
            transition: border-color 0.3s;
        }
        #user-input:focus { border-color: #6c5ce7; }
        #send-button {
            background-color: #6c5ce7; color: white; border: none;
            padding: 10px 20px; margin-left: 10px; border-radius: 25px;
            font-weight: bold; cursor: pointer;
        }
        #send-button:disabled { background-color: #ccc; }
    </style>
</head>
<body>
    <div id="header">ü§ñ Pico</div>
    <div id="chat-window"></div>
    <div id="typing-indicator">Pico Ê≠£Âú®ÊÄùËÄÉ...</div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="ÂèëÈÄÅÊ∂àÊÅØ..." autocomplete="off">
        <button id="send-button">ÂèëÈÄÅ</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        const socket = io();
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const typingIndicator = document.getElementById('typing-indicator');

        // ÁÆÄÂçïÁöÑÈü≥È¢ëÊí≠ÊîæÈòüÂàóÔºåÈò≤Ê≠¢Â§öÊù°ËØ≠Èü≥ÂêåÊó∂Êí≠Êîæ
        let audioQueue = [];
        let isPlaying = false;

        function playNextAudio() {
            if (audioQueue.length > 0 && !isPlaying) {
                isPlaying = true;
                const audioUrl = audioQueue.shift();
                const audio = new Audio(audioUrl);
                audio.onended = () => {
                    isPlaying = false;
                    playNextAudio(); // Êí≠Êîæ‰∏ã‰∏ÄÊù°
                };
                audio.play().catch(e => {
                    console.warn("Ëá™Âä®Êí≠ÊîæË¢´ÊµèËßàÂô®ÈòªÊ≠¢ÔºåÁî®Êà∑ÈúÄË¶ÅÂÖàËøõË°å‰∫§‰∫í„ÄÇ", e);
                    isPlaying = false;
                });
            }
        }

        function appendMessage(text, sender) {
            const container = document.createElement('div');
            container.className = `message-container ${sender}`;
            
            if (sender === 'pico') {
                const avatar = document.createElement('div');
                avatar.className = 'avatar';
                avatar.textContent = 'ü§ñ';
                container.appendChild(avatar);
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);

            chatWindow.appendChild(container);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function sendMessage() {
            const text = userInput.value.trim();
            if (text) {
                appendMessage(text, 'user');
                socket.emit('message', { text: text });
                userInput.value = '';
            }
        }

        // --- Socket ‰∫ã‰ª∂ ---
        socket.on('connect', () => console.log('Â∑≤ËøûÊé•ÊúçÂä°Âô®'));
        
        socket.on('response', (data) => {
            appendMessage(data.text, 'pico');
            // Â¶ÇÊûúÊúâÈü≥È¢ëÔºåÂä†ÂÖ•Êí≠ÊîæÈòüÂàó
            if (data.audio) {
                audioQueue.push(data.audio);
                playNextAudio();
            }
        });

        socket.on('typing_status', (data) => {
            typingIndicator.className = data.status === 'typing' ? 'active' : '';
        });

        // --- ‰∫§‰∫íÁªëÂÆö ---
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        // ÁßªÂä®Á´Ø‰ºòÂåñÔºöÁÇπÂáªËæìÂÖ•Ê°ÜÊó∂ÊªöÂä®Âà∞Â∫ïÈÉ®
        userInput.addEventListener('focus', () => {
            setTimeout(() => chatWindow.scrollTop = chatWindow.scrollHeight, 300);
        });

    </script>
</body>
</html>
